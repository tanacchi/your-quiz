# 仕様整理

## 目的

- 新機能開発において、ビジネス要件を明確化し、開発チーム全体が同じ理解を持つため、ユーザーストーリーと成功／失敗パターンを4W1Hで整理し、RESTステータスと振る舞いを明示した仕様書を作成する

## 遵守事項

- 指示を読むペルソナとしては「Webやプログラミング技術、文章理解力は高いが、そのドキュメントで扱う対象についての知識はなく、目的や遵守事項を細かく明確に指示しないといけないタイプ」を想定し、その想定のもとハイクオリティなドキュメントを作成すること

## 仕様整理の手順

### 0. 出力先ディレクトリ作成

#### 0.1 ディレクトリ構造
```
specifications/
├── user-stories/           # ユーザーストーリー
├── api-specs/             # API仕様書
├── success-scenarios/     # 成功パターン
├── error-scenarios/       # 失敗パターン
└── requirements/          # 非機能要件
```

#### 0.2 ファイル命名規則
- **ユーザーストーリー**: `user-story-[機能名].md`
- **API仕様**: `api-spec-[機能名].md`
- **成功シナリオ**: `success-[機能名].md`
- **エラーシナリオ**: `error-[機能名].md`
- **要件定義**: `requirements-[機能名].md`

### 1. ユーザーストーリー作成

#### 1.1 4W1H形式での記述
以下の構造でユーザーストーリーを記述する：

```
## ユーザーストーリー: [機能名]

### Who（誰が）
- **ユーザー種別**: [具体的なユーザータイプ]
- **権限レベル**: [必要な権限や認証状態]
- **前提条件**: [ユーザーが満たすべき条件]

### What（何を）
- **実現したい機能**: [具体的な機能内容]
- **対象データ**: [操作対象となるデータや情報]
- **操作範囲**: [機能が影響する範囲]

### When（いつ）
- **実行タイミング**: [機能を使用する場面]
- **前提状況**: [機能実行時のシステム状態]
- **制約条件**: [時間的・状況的制約]

### Where（どこで）
- **実行環境**: [Webブラウザ、モバイルアプリ等]
- **画面・ページ**: [具体的な実行場所]
- **システム範囲**: [関連するシステム・サービス]

### Why（なぜ）
- **ビジネス価値**: [この機能が提供する価値]
- **解決する課題**: [現状の問題点]
- **期待する結果**: [機能実現後の理想状態]
```

#### 1.2 ユーザーストーリー記述の原則
- **具体性**: 曖昧な表現を避け、測定可能な内容にする
- **ユーザー中心**: 技術実装ではなくユーザーの行動と価値に焦点
- **独立性**: 他のストーリーに依存しない単独で理解可能な内容
- **検証可能性**: 完了の判定が明確にできる内容

#### 1.3 ユーザーストーリー出力
作成したユーザーストーリーを `specifications/user-stories/user-story-[機能名].md` に保存する。

### 2. 成功パターン定義

#### 2.1 正常系シナリオ
```
## 成功パターン

### シナリオ: [シナリオ名]

**前提条件**:
- [システムやデータの初期状態]
- [ユーザーの認証・権限状態]

**実行手順**:
1. [具体的なアクション1]
2. [具体的なアクション2]
3. [具体的なアクション3]

**期待結果**:
- **HTTPステータス**: 200 OK / 201 Created / 204 No Content
- **レスポンス内容**: [具体的なデータ構造]
- **システム状態変化**: [データベースやキャッシュの変更]
- **ユーザー体験**: [画面表示や通知の内容]
```

#### 2.2 バリエーションパターン
- **境界値テスト**: 最小値、最大値での動作
- **データパターン**: 異なるデータタイプでの正常動作
- **権限パターン**: 異なる権限レベルでの正常動作

#### 2.3 成功パターン出力
作成した成功パターンを `specifications/success-scenarios/success-[機能名].md` に保存する。

### 3. 失敗パターン定義

#### 3.1 異常系シナリオ
```
## 失敗パターン

### エラーシナリオ: [エラー種別]

**発生条件**:
- [エラーが発生する具体的な状況]
- [不正な入力や状態]

**実行手順**:
1. [エラーを引き起こすアクション]
2. [システムの反応]

**期待結果**:
- **HTTPステータス**: 400 Bad Request / 401 Unauthorized / 403 Forbidden / 404 Not Found / 409 Conflict / 422 Unprocessable Entity / 500 Internal Server Error
- **エラーレスポンス**: 
  ```json
  {
    "error": {
      "code": "ERROR_CODE",
      "message": "ユーザー向けエラーメッセージ",
      "details": "詳細な技術情報（開発者向け）"
    }
  }
  ```
- **システム動作**: [ロールバック、ログ出力等]
- **ユーザー体験**: [エラー画面や通知の内容]
```

#### 3.2 エラーパターンの分類
- **バリデーションエラー**: 入力値の形式・範囲違反
- **認証・認可エラー**: 権限不足やセッション切れ
- **ビジネスルールエラー**: 業務制約違反
- **システムエラー**: サーバー障害や外部API障害
- **リソースエラー**: データ不存在や重複

#### 3.3 失敗パターン出力
作成した失敗パターンを `specifications/error-scenarios/error-[機能名].md` に保存する。

### 4. APIエンドポイント設計

#### 4.1 RESTful API設計
```
## APIエンドポイント

### [機能名] API

**エンドポイント**: `[HTTP_METHOD] /api/v1/[resource]`

**リクエスト**:
- **Headers**:
  - `Content-Type: application/json`
  - `Authorization: Bearer [token]`
- **Parameters**:
  - `param1` (string, required): [説明]
  - `param2` (number, optional): [説明]
- **Body**:
  ```json
  {
    "field1": "value1",
    "field2": 123
  }
  ```

**レスポンス**:
- **成功時 (200 OK)**:
  ```json
  {
    "data": {
      "id": "uuid",
      "field1": "value1",
      "created_at": "2024-01-01T00:00:00Z"
    }
  }
  ```
- **エラー時 (400 Bad Request)**:
  ```json
  {
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "入力値が正しくありません"
    }
  }
  ```
```

#### 4.2 API仕様出力
作成したAPI仕様を `specifications/api-specs/api-spec-[機能名].md` に保存する。

### 5. データ整合性要件

#### 5.1 データ制約
- **一意性制約**: 重複を許可しないフィールド
- **外部キー制約**: 関連データの整合性
- **CHECK制約**: 値の範囲や形式制約
- **NOT NULL制約**: 必須フィールド

#### 5.2 トランザクション要件
- **ACID特性**: 原子性、一貫性、独立性、持続性の保証
- **分離レベル**: 同時実行時の動作制御
- **デッドロック対策**: 競合状態の回避方法

### 6. パフォーマンス要件

#### 6.1 応答時間
- **API応答時間**: 95%ile で [X]ms 以内
- **画面表示時間**: 初回読み込み [X]秒以内
- **バッチ処理時間**: [X]件の処理を [X]分以内

#### 6.2 スループット
- **同時接続数**: 最大 [X] 接続
- **リクエスト処理数**: 毎秒 [X] リクエスト
- **データ処理量**: 毎時 [X] GB

### 7. セキュリティ要件

#### 7.1 認証・認可
- **認証方式**: JWT トークン / OAuth 2.0
- **権限管理**: RBAC (Role-Based Access Control)
- **セッション管理**: タイムアウト時間と更新方式

#### 7.2 データ保護
- **暗号化**: 機密データの暗号化方式
- **アクセスログ**: 監査証跡の記録要件
- **個人情報保護**: GDPR、個人情報保護法への対応

### 8. 要件ドキュメント出力

#### 8.1 非機能要件出力
データ整合性、パフォーマンス、セキュリティ要件を `specifications/requirements/requirements-[機能名].md` に保存する。

#### 8.2 完成した仕様書の構成
```
specifications/
├── user-stories/user-story-[機能名].md      # ユーザーストーリー
├── success-scenarios/success-[機能名].md    # 成功パターン
├── error-scenarios/error-[機能名].md        # 失敗パターン
├── api-specs/api-spec-[機能名].md           # API仕様
└── requirements/requirements-[機能名].md    # 非機能要件
```

## 完了判定基準

- `specifications/` ディレクトリ配下に適切な構造でファイルが作成されていること
- ユーザーストーリーが4W1H（Who, What, When, Where, Why）で記述されていること
- 成功／失敗パターンがRESTステータスと振る舞いで明示されていること
- APIエンドポイントの設計が RESTful な原則に従っていること
- データ整合性要件が具体的に定義されていること
- パフォーマンス要件が数値で明示されていること
- セキュリティ要件が具体的な実装方式で記述されていること
- すべてのエラーパターンに適切なHTTPステータスコードが割り当てられていること
- ユーザー体験とシステム動作の両方の観点で記述されていること
- ファイル命名規則に従って適切にファイルが分割されていること
- 作成対象が実際のファイルとして出力されていること
- Markdownのlintルールに従っていない記述が少ないこと

## 完了後

- アウトプットを全てリストアップし、ユーザーからのレビューを受ける