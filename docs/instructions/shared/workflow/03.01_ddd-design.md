# DDD設計

## 目的

- 仕様整理と全体技術設計を基に、ドメイン駆動設計の戦術パターンを適用した具体的なドメインモデルとアーキテクチャ層を設計せよ

## 遵守事項

- **ドメインエキスパートとの密接な協働**: ビジネス専門家との対話を通じてユビキタス言語を確立せよ
- **戦略的設計から戦術的設計への段階的アプローチ**: 境界づけられたコンテキスト→ドメインモデル→アーキテクチャ層の順で設計せよ
- **ドメイン層の純粋性保持**: インフラストラクチャへの依存を排除し、ビジネスルールに集中せよ
- **表形式による設計判断の記録**: エンティティ・値オブジェクト・サービスの分類根拠を明文化せよ
- **実装可能性の検証**: 後続のAPI設計・DB設計への制約と指針を明確化せよ

## アウトプット出力先

### 基本方針

DDD設計成果物は、ワークフローガイド番号と対応する統一的な構造で整理し、`docs/project/ddd-design/` ディレクトリに体系的に配置して、誰でも同じファイル構成で作業できる環境を提供する。

### 統一ディレクトリ構造

```text
docs/project/ddd-design/
├── README.md                                # DDD設計全体概要・ナビゲーション
├── 2.01_domain-understanding/              # ドメイン理解（03.02対応）
│   ├── domain-knowledge-base.md
│   ├── business-rules/
│   ├── stakeholder-interviews/
│   └── domain-complexity-analysis.md
├── 2.02_user-flow-analysis/             # ユーザーフロー分析（03.02.5対応）
│   ├── user-flow-analysis.md
│   ├── flow-priority-matrix/
│   ├── flow-detailed-analysis/
│   └── flow-monitoring/
├── 2.03_ubiquitous-language/              # ユビキタス言語（03.03対応）
│   ├── ubiquitous-language-dictionary.md
│   ├── context-specific-terms/
│   ├── bdd-integration/
│   └── language-evolution/
├── 2.04_event-storming/                   # Event Storming（03.04対応）
│   ├── event-storming-results.md
│   ├── workshop-sessions/
│   ├── discovered-events/
│   └── collaboration-artifacts/
├── 2.05_domain-object-extraction/         # ドメインオブジェクト抽出（03.05対応）
│   ├── domain-object-analysis.md
│   ├── usecase-domain-mapping/
│   ├── domain-model-integration.md
│   └── implementation-guidelines.md
├── 2.06_entity-relationship-analysis/     # エンティティ関係分析（03.06対応）
│   ├── entity-relationship-analysis.md
│   ├── relationship-patterns/
│   ├── cardinality-analysis/
│   └── relationship-constraints/
├── 2.07_domain-service-extraction/        # ドメインサービス抽出（03.07対応）
│   ├── domain-service-analysis.md
│   ├── service-categories/
│   ├── service-specifications/
│   └── service-interactions/
├── 2.08_aggregate-design/                 # 集約設計（03.08対応）
│   ├── aggregate-design.md
│   ├── aggregates/
│   ├── event-sourcing/
│   ├── cqrs-integration/
│   └── saga-coordination/
├── 2.09_bounded-context-definition/       # 境界づけられたコンテキスト（03.09対応）
│   ├── bounded-context-overview.md
│   ├── discovery/
│   ├── contexts/
│   ├── mapping/
│   └── evolution/
├── 2.10_domain-events-catalog/            # ドメインイベントカタログ（03.10対応）
│   ├── domain-events-catalog.md
│   ├── event-categories/
│   ├── event-specifications/
│   ├── event-flows/
│   └── event-store-design/
└── 2.11_ontology-creation/                # オントロジー作成（03.11対応）
    ├── domain-ontology.md
    ├── concept-hierarchies/
    ├── semantic-relationships/
    ├── knowledge-graphs/
    └── ontology-validation/
```

### 統一ファイル命名規則

#### 基本原則

- **ガイド番号継承**: 03.XX → 2.XX でディレクトリ番号対応
- **複数成果物**: サブディレクトリで分類整理
- **一貫性**: 全ガイドで同じ命名パターン適用

#### 具体的命名規則

| 成果物種別 | 命名パターン | 例 |
|-----------|-------------|-----|
| **メインドキュメント** | `{主要成果物名}.md` | `domain-knowledge-base.md` |
| **個別仕様書** | `{名前}.{種別}.md` | `Quiz.aggregate.md`, `QuizCreated.event.md` |
| **分析結果** | `{対象}-{分析種別}.md` | `quiz-lifecycle-events.md` |
| **サブディレクトリ** | `{機能分類名}/` (kebab-case) | `service-specifications/` |
| **一覧・索引** | `README.md` | `aggregates/README.md` |

#### 種別識別子一覧

| 種別 | 識別子 | 例 |
|------|-------|-----|
| **エンティティ** | `.entity.md` | `User.entity.md` |
| **値オブジェクト** | `.value-object.md` | `QuizId.value-object.md` |
| **ドメインサービス** | `.service.md` | `QuizApproval.service.md` |
| **集約** | `.aggregate.md` | `Quiz.aggregate.md` |
| **ドメインイベント** | `.event.md` | `QuizCreated.event.md` |
| **コンテキスト** | `.context.md` | `QuizManagement.context.md` |
| **Canvas** | `.canvas.md` | `QuizManagement.canvas.md` |
| **リポジトリ** | `.repository.md` | `QuizRepository.repository.md` |

## DDD設計の手順

### 1. ドメイン理解とユビキタス言語確立

#### 1.1 ドメインエキスパートとの対話実施

**必須実施項目**:

- ビジネスルール整理（状況・条件→対応・処理の表形式整理）
- 重要概念・用語の抽出
- 例外的状況の対応方法確認

**詳細な実施手順**: [ドメイン理解ドキュメント作成ガイド](./03.02_domain-understanding-guide.md)を参照せよ

#### 1.2 ユビキタス言語確立

**BDDテスト実装との統一必須**: 同じユビキタス言語辞書を使用せよ

**必須作成要素**:

- 用語定義と英語表記の統一
- BDDシナリオでの表現方法統一
- コード・文書・会話での統一使用徹底

**詳細な作成手順**: [ユビキタス言語辞書作成ガイド](./03.03_ubiquitous-language-creation-guide.md)を参照せよ

### 2. ドメインオブジェクトの抽出・分類

#### 2.1 エンティティと値オブジェクトの分類実施

**分類基準**:

| 分類 | 判定条件 | データベース表現 |
|------|----------|------------------|
| **エンティティ** | IDで識別、状態変化あり | テーブル化 |
| **値オブジェクト** | 値そのものが識別子、不変 | フィールド化 |

**必須作成**: エンティティ・値オブジェクト分類表（概念・分類・判定理由・主要属性を表形式で整理せよ）

**詳細な実施手順**: [ドメインオブジェクト抽出ガイド](./03.05_domain-object-extraction-guide.md)を参照せよ

### 3. ユーザー操作と業務フローの整理

**必須実施項目**:

- ビジネス価値・技術難易度による優先度評価
- 4WH1完全分析（Who・What・When・Where・Why・How）
- ROI計算による段階的実装計画

**詳細な実施手順**: [ユーザーフロー分析ガイド](./03.02.5_user-flow-analysis-guide.md)を参照せよ

### 4. エンティティ間関連性分析

**関連性パターン整理**: 1対1所有・1対多所有・多対多関連・参照関係を表形式で整理せよ

**詳細な実施手順**: [エンティティ関係分析ガイド](./03.06_entity-relationship-analysis-guide.md)を参照せよ

### 5. ドメインサービス抽出

**抽出基準**: 複数集約操作・複雑な計算・外部連携ロジックを特定せよ

**詳細な実施手順**: [ドメインサービス抽出ガイド](./03.07_domain-service-extraction-guide.md)を参照せよ

### 6. 境界づけられたコンテキスト定義

**境界設定基準**: 責務の独立性・用語の一意性・変更の独立性で判定せよ

**詳細な実施手順**: [境界づけられたコンテキスト定義ガイド](./03.09_bounded-context-definition-guide.md)および[Event Stormingワークショップガイド](./03.04_event-storming-workshop-guide.md)を参照せよ

### 7. 集約と集約ルート定義

**集約設計の原則**:

- **整合性境界**: 集約内の不変条件を常に保証
- **集約ルート経由**: 集約への操作は全て集約ルートから
- **ID参照原則**: 他集約はIDでのみ参照
- **最小サイズ**: 必要最小限の要素のみ含める

**詳細な実施手順**: [集約設計ガイド](./03.08_aggregate-design-guide.md)を参照せよ

### 8. モデル設計（最終成果物）

#### 8.1 設計図作成

**必須作成図表**:

1. ドメインモデル図
2. 集約図
3. コンテキストマップ
4. 状態遷移図
5. ドメインオントロジー（[ドメインオントロジー作成ガイド](./03.11_ontology-creation-guide.md)参照）

#### 8.2 実装制約・原則

**型安全性原則**:

- **厳密な型定義**: ドメイン概念を適切な型システムで表現せよ
- **null安全性**: 不正状態を型レベルで排除せよ
- **不変性**: 値オブジェクトの不変性を言語機能で保証せよ

**実装詳細**: 具体的なコード・インターフェース定義は[実装工程](./10.01_implementation.md)で扱う

## DDD成果物品質ガイドライン

### 統一フォーマット要件

**全DDD成果物は以下の統一フォーマットに準拠すること**:

```markdown
# {成果物タイトル}

## 目的
- {この成果物の作成目的}

## 概要
- {成果物の概要説明}

## {メインセクション1}
### {サブセクション}
{具体的内容}

## {メインセクション2}
### {サブセクション}
{具体的内容}

## まとめ
- {成果物の要約}

## 関連ドキュメント
- [関連ドキュメント1](path/to/doc1.md)
- [関連ドキュメント2](path/to/doc2.md)

---
**作成工程**: DDD設計
**作成日**: YYYY-MM-DD
**更新日**: YYYY-MM-DD
```

### 成果物種別要件

#### 分析系ドキュメント（analysis/extraction）

- **必須構成**: 目的 → 分析手法 → 分析結果（表形式） → 設計への示唆
- **表形式活用**: 分析結果は必ず表形式で整理（比較・検索・追跡性確保）
- **Mermaid図表**: 関係性・フローは図表で可視化
- **具体例**: specifications配下のデータを用いた実証的な分析例を必須記載

#### 設計系ドキュメント（design/specification）

- **必須構成**: 目的 → 設計原則 → 詳細設計 → 実装指針 → 制約・前提
- **設計仕様**: ドメイン概念の構造・制約・責務を明記
- **不変条件**: 各設計要素の不変条件・ビジネスルールを明記
- **依存関係**: 他の設計要素との依存関係・制約を明確化

#### 一覧・カタログ系ドキュメント（catalog/dictionary）

- **必須構成**: 概要 → 分類体系 → 個別項目詳細 → 使用指針
- **索引性**: 検索・参照しやすい構造（表形式・アルファベット順等）
- **BDD統合**: ユビキタス言語はBDDテスト実装での使用方法を併記
- **進化管理**: 用語・概念の変更履歴・バージョン管理方針

### データ品質要件

#### specifications連携要件

- **トレーサビリティ**: 全設計判断をspecifications配下の要件に追跡可能
  - 例: 「問題文500文字制限」→ `requirements-quiz.md:11` の文字制約要件
  - 例: 「匿名ユーザー」概念→ `user-story-quiz.md:5` のユーザー種別定義
- **実証性**: 仮想的でなく実際のspecificationsデータを用いた具体例
  - 例: QuizエンティティのQuestion値オブジェクト設計時、`requirements-quiz.md`の「問題文: 必須、500文字以内」制約を型定義に反映
  - 例: 承認フロー設計時、`requirements-quiz.md:20`の「承認待ち状態」要件を状態遷移に組み込み
- **整合性**: requirements/user-stories/success-scenariosとの論理的一貫性
  - ユーザーストーリーの5W1H分析結果をドメインオブジェクト抽出の根拠として活用
  - 非機能要件のパフォーマンス制約をドメインサービス設計に反映

#### 実装整合性要件

- **型安全性考慮**: ドメイン制約を型システムで表現可能な設計
- **命名統一**: ユビキタス言語辞書との完全一致
- **テスト可能性**: 単体テスト・BDDテストでの検証可能な設計

### Markdown品質要件

#### 構造要件

- **見出し階層**: # → ## → ### の適切な階層構造
- **リンク完全性**: 全内部リンクの有効性確認
- **表形式**: 比較・分類データは必ず表形式（| | |）で記載
- **図表ブロック**: 図表指定（```mermaid）でドメイン構造を可視化

#### 可読性要件

- **簡潔性**: 1段落150文字以内、1文80文字以内を目安
- **具体性**: 抽象的表現を避け、具体例・数値・制約を明記
- **一貫性**: 用語・表記・フォーマットの文書内統一

### 品質チェックリスト

#### 📋 成果物作成前チェック

- [ ] **specifications確認**: 対象要件を `docs/project/specifications/` から特定済み
- [ ] **ユビキタス言語参照**: `ubiquitous-language-dictionary.md` の用語を使用予定
- [ ] **統一フォーマット確認**: 上記フォーマット要件を理解済み
- [ ] **関連ドキュメント確認**: 依存する他DDD成果物の最新状態を確認済み

#### 📝 作成中チェック

- [ ] **表形式活用**: 設計判断・分類結果を表形式で整理済み
- [ ] **具体例記載**: specifications配下の実データを用いた例を記載済み
- [ ] **設計仕様**: ドメイン概念の構造・制約・責務を記載済み
- [ ] **Mermaid図表**: 関係性・フローを図表で可視化済み

#### ✅ 完成後チェック

- [ ] **統一フォーマット準拠**: 「目的→概要→メインセクション→まとめ→関連ドキュメント」構造
- [ ] **specifications整合性**: 全設計判断の根拠がspecifications要件で説明可能
- [ ] **リンク有効性**: 内部リンクが全て正しいパスを指している
- [ ] **用語統一**: ユビキタス言語辞書の英語名・日本語名を正しく使用
- [ ] **実装指針**: 後続工程（API設計・DB設計）への具体的制約・指針を提供

#### 🔍 品質検証チェック

- [ ] **トレーサビリティ**: 設計判断→specifications要件の追跡パスが明確
- [ ] **不変条件明記**: エンティティ・集約の不変条件がビジネスルールと整合
- [ ] **依存関係整理**: 他ドメインオブジェクトとの依存関係が適切に制約
- [ ] **拡張性考慮**: 将来の機能追加への影響が最小限に設計

## 完了判定基準

### 必須要件

- **統一構造準拠**: 2.XX系ディレクトリ構造への完全移行完了
- **境界づけられたコンテキスト明確化**: 責務境界と関係性が表形式で整理されている
- **ユビキタス言語確立**: 専門用語の定義と使用方法が統一されている
- **エンティティ・値オブジェクト分類**: 分類根拠が表形式で明文化されている
- **集約境界設定**: 不変条件に基づく集約設計が完了している
- **リポジトリインターフェース定義**: ドメイン層での抽象化が完了している
- **ドメインイベント設計**: 重要な業務イベントが定義されている（[ドメインイベントカタログガイド](./03.10_domain-events-catalog-guide.md)参照）
- **アーキテクチャ層構造**: 4層アーキテクチャでの役割分担が明確化されている

### 品質要件

- **実装可能性**: 後続のAPI設計・DB設計に具体的な制約と指針を提供
- **保守性**: ドメイン知識の変更がコードに反映しやすい構造
- **拡張性**: 新しい機能追加時の影響範囲が限定的
- **テスタビリティ**: 単体テストが容易な責務分離
- **specifications整合性**: 全設計判断がspecifications配下の要件に追跡可能

### 文書品質要件

- **統一フォーマット準拠**: 上記品質ガイドラインへの完全準拠（チェックリスト完全クリア）
- **表形式の活用**: 設計判断の根拠が表形式で整理されている
- **図表による可視化**: UMLやMermaidでの構造表現が適切
- **トレードオフの明示**: 設計選択の理由と代替案比較が記載
- **設計仕様**: ドメイン概念・制約・関係性の明確な仕様定義
- **specifications連携**: 実際のspecificationsデータに基づく具体例記載
- **チェックリスト準拠**: 上記品質チェックリストの全項目をクリア

### エンティティ実装準備

DDD設計で定義したエンティティの実装については、本実装工程で以下の実装ガイドを参照すること：

- **[10.02_entity-implementation-guide.md](10.02_entity-implementation-guide.md)** - ドメインエンティティ実装ガイド
  - DDD設計成果物から実装への橋渡し
  - 型安全性とimmutabilityを重視した実装パターン
  - QuizSummaryと同品質のエンティティ実装手法

## 完了後の必須アクション

1. **直ちに**ユーザーに「DDD設計成果物」のレビューを依頼する
2. **ADR作成**: 以下の重要なドメインモデリング決定について、必ずADRを作成する：
   - **境界づけられたコンテキスト分割決定**: なぜその境界で分割したかの根拠
   - **集約設計決定**: 集約境界と集約ルートの選択理由
   - **ドメインサービス抽出決定**: エンティティから抽出したドメインロジックの根拠
   - **リポジトリパターン採用決定**: 永続化抽象化の設計選択理由
3. **ADR作成手順**:
   - 各ADRは「Proposed」ステータスで作成
   - ADRインデックス（`docs/project/adr/README.md`）への追加
   - DDD設計ドキュメント（`docs/project/ddd-design/README.md`）からのリンク追加
4. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「API設計」または「DB設計」に進む
   - 戻りフロー：仕様見直しが必要な場合は「仕様整理」に戻る
   - 並行フロー：要件が明確な場合は「BDDテスト実装」を並行実施
5. ユーザーの明示的な承認を得てから指定された工程に進む
