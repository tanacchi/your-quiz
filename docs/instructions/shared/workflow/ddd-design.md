# DDD設計

## 目的

- 仕様整理と全体技術設計を基に、ドメイン駆動設計の戦術パターンを適用した具体的なドメインモデルとアーキテクチャ層を設計せよ

## 遵守事項

- **ドメインエキスパートとの密接な協働**: ビジネス専門家との対話を通じてユビキタス言語を確立せよ
- **戦略的設計から戦術的設計への段階的アプローチ**: 境界づけられたコンテキスト→ドメインモデル→アーキテクチャ層の順で設計せよ
- **ドメイン層の純粋性保持**: インフラストラクチャへの依存を排除し、ビジネスルールに集中せよ
- **表形式による設計判断の記録**: エンティティ・値オブジェクト・サービスの分類根拠を明文化せよ
- **実装可能性の検証**: 後続のAPI設計・DB設計への制約と指針を明確化せよ

## アウトプット出力先

### 基本方針

DDD設計成果物は、プロジェクトドキュメント体系として整理し、`docs/project/ddd-design/` ディレクトリに集約して後続工程からの参照を容易にする。

### 出力先ディレクトリ構造

```text
docs/project/ddd-design/
├── ubiquitous-language.md          # ユビキタス言語辞書
├── bounded-contexts/               # 境界づけられたコンテキスト
├── entities/                      # エンティティ定義
├── value-objects/                 # 値オブジェクト定義
├── domain-services/               # ドメインサービス定義
├── aggregates/                    # 集約定義
└── repositories/                  # リポジトリインターフェース
```

**ファイル命名規則**:

- **エンティティ**: `{名前}.entity.md`
- **値オブジェクト**: `{名前}.value-object.md`
- **ドメインサービス**: `{名前}.domain-service.md`
- **集約**: `{名前}.aggregate.md`
- **リポジトリ**: `{名前}.repository.interface.md`

## DDD設計の手順

### 1. ドメイン理解とユビキタス言語確立

#### 1.1 ドメインエキスパートとの対話実施

**必須実施項目**:

- ビジネスルール整理（状況・条件→対応・処理の表形式整理）
- 重要概念・用語の抽出
- 例外的状況の対応方法確認

**詳細な実施手順**: [ドメイン理解ドキュメント作成ガイド](./domain-understanding-guide.md)を参照せよ

#### 1.2 ユビキタス言語確立

**BDDテスト実装との統一必須**: 同じユビキタス言語辞書を使用せよ

**必須作成要素**:

- 用語定義と英語表記の統一
- BDDシナリオでの表現方法統一
- コード・文書・会話での統一使用徹底

**詳細な作成手順**: [ユビキタス言語辞書作成ガイド](./ubiquitous-language-creation-guide.md)を参照せよ

### 2. ドメインオブジェクトの抽出・分類

#### 2.1 エンティティと値オブジェクトの分類実施

**分類基準**:

| 分類 | 判定条件 | データベース表現 |
|------|----------|------------------|
| **エンティティ** | IDで識別、状態変化あり | テーブル化 |
| **値オブジェクト** | 値そのものが識別子、不変 | フィールド化 |

**必須作成**: エンティティ・値オブジェクト分類表（概念・分類・判定理由・主要属性を表形式で整理せよ）

### 3. ユーザー操作と業務フローの整理

**必須実施項目**:

- 主要ユーザーストーリーの抽出
- 正常系・異常系の両方考慮
- 運営側業務フローの整理

### 4. エンティティ間関連性分析

**関連性パターン整理**: 1対1所有・1対多所有・多対多関連・参照関係を表形式で整理せよ

### 5. ドメインサービス抽出

**抽出基準**: 複数集約操作・複雑な計算・外部連携ロジックを特定せよ

### 6. 境界づけられたコンテキスト定義

**境界設定基準**: 責務の独立性・用語の一意性・変更の独立性で判定せよ

### 7. 集約と集約ルート定義

**集約設計の原則**:

- **整合性境界**: 集約内の不変条件を常に保証
- **集約ルート経由**: 集約への操作は全て集約ルートから
- **ID参照原則**: 他集約はIDでのみ参照
- **最小サイズ**: 必要最小限の要素のみ含める

### 8. モデル設計（最終成果物）

#### 8.1 設計図作成

**必須作成図表**:

1. ドメインモデル図
2. 集約図
3. コンテキストマップ
4. 状態遷移図

#### 8.2 TypeScript実装指針

**必須ルール**:

- **any型禁止**: 型安全性を確保せよ
- **as型アサーション禁止**: 実行時エラーを防止せよ
- **Non-null assertion禁止**: null/undefined安全性確保せよ

### 9. 実装指針

#### 9.1 BDD連携ポイント

**重要な統合項目**:

- **ユビキタス言語**: DDD設計とBDDテストで同一用語使用必須
- **ドメインルール**: 不変条件とGiven/When/Thenの統一
- **境界づけられたコンテキスト**: コンテキスト単位でテスト分類

#### 9.2 アーキテクチャ層設計

**DDD標準4層アーキテクチャ**:

| 層 | 責務 | 依存関係 | 制約事項 |
|---|------|----------|----------|
| **プレゼンテーション層** | API制御 | アプリケーション層のみ | HTTPリクエスト/レスポンス変換 |
| **アプリケーション層** | ユースケース調整 | ドメイン層、インフラ層 | ドメインロジック記述禁止 |
| **ドメイン層** | ビジネスルール | なし（純粋） | 外部依存禁止 |
| **インフラストラクチャ層** | 永続化、外部連携 | ドメイン層（実装時） | ドメイン层インターフェース実装 |

## 完了判定基準

### 必須要件

- **境界づけられたコンテキスト明確化**: 責務境界と関係性が表形式で整理されている
- **ユビキタス言語確立**: 専門用語の定義と使用方法が統一されている
- **エンティティ・値オブジェクト分類**: 分類根拠が表形式で明文化されている
- **集約境界設定**: 不変条件に基づく集約設計が完了している
- **リポジトリインターフェース定義**: ドメイン層での抽象化が完了している
- **ドメインイベント設計**: 重要な業務イベントが定義されている
- **アーキテクチャ層構造**: 4層アーキテクチャでの役割分担が明確化されている

### 品質要件

- **実装可能性**: 後続のAPI設計・DB設計に具体的な制約と指針を提供
- **保守性**: ドメイン知識の変更がコードに反映しやすい構造
- **拡張性**: 新しい機能追加時の影響範囲が限定的
- **テスタビリティ**: 単体テストが容易な責務分離

### 文書品質要件

- **表形式の活用**: 設計判断の根拠が表形式で整理されている
- **図表による可視化**: UMLやMermaidでの構造表現が適切
- **トレードオフの明示**: 設計選択の理由と代替案比較が記載
- **実装サンプル**: TypeScriptでのインターフェース例が提供

## 完了後の必須アクション

1. **直ちに**ユーザーに「DDD設計成果物」のレビューを依頼する
2. **ADR作成**: 以下の重要なドメインモデリング決定について、必ずADRを作成する：
   - **境界づけられたコンテキスト分割決定**: なぜその境界で分割したかの根拠
   - **集約設計決定**: 集約境界と集約ルートの選択理由
   - **ドメインサービス抽出決定**: エンティティから抽出したドメインロジックの根拠
   - **リポジトリパターン採用決定**: 永続化抽象化の設計選択理由
3. **ADR作成手順**:
   - 各ADRは「Proposed」ステータスで作成
   - ADRインデックス（`docs/project/adr/README.md`）への追加
   - DDD設計ドキュメント（`docs/project/ddd-design/README.md`）からのリンク追加
4. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「API設計」または「DB設計」に進む
   - 戻りフロー：仕様見直しが必要な場合は「仕様整理」に戻る
   - 並行フロー：要件が明確な場合は「BDDテスト実装」を並行実施
5. ユーザーの明示的な承認を得てから指定された工程に進む
