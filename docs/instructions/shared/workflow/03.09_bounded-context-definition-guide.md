# 境界づけられたコンテキスト定義ガイド

## 目的

- Event Storming・Bounded Context Canvas・Context Mapping・Team Topologyを統合した包括的アプローチで境界づけられたコンテキストを定義し、現代的なマイクロサービスアーキテクチャとチーム構造に適合した実装可能な設計成果物を実現せよ

## 遵守事項

- **Event Storming中心発見**: 協働的な境界発見プロセスを必須とせよ
- **Conway's Law考慮**: チーム構造との整合性を確保せよ
- **疎結合通信設計**: Domain Eventsによる疎結合通信を設計せよ
- **1コンテキスト＝1マイクロサービス**: 実装境界との一致を原則とせよ
- **適切なサイズ維持**: 集約より大きく、ドメイン全体より小さい境界を設定せよ

## アウトプット出力先

### 基本方針

境界づけられたコンテキスト定義成果物は、戦略的設計の中核として、`docs/project/ddd-design/bounded-contexts/` ディレクトリに体系的に整理し、戦術的設計への明確な指針を提供する。

### 出力先ディレクトリ構造

```text
docs/project/ddd-design/2.09_bounded-context-definition/
├── bounded-context-overview.md           # 境界づけられたコンテキスト概要
├── discovery/                             # 発見プロセス記録
│   ├── event-storming-workshop.md         # Event Stormingワークショップ結果
│   ├── pivotal-events-analysis.md         # 重要境界イベント分析
│   └── domain-language-alignment.md       # ドメイン言語整合性確認
├── contexts/                              # 個別コンテキスト定義
│   ├── QuizManagement.context.md          # QuizManagementコンテキスト詳細
│   ├── QuizManagement.canvas.md           # QuizManagement Canvas
│   ├── UserLearning.context.md            # UserLearningコンテキスト詳細
│   ├── UserLearning.canvas.md             # UserLearning Canvas
│   ├── Administration.context.md          # Administrationコンテキスト詳細
│   ├── Administration.canvas.md           # Administration Canvas
│   └── README.md                          # コンテキスト一覧・関係図
├── mapping/                               # コンテキスト間関係
│   ├── context-map.md                     # Context Map全体図
│   ├── integration-patterns.md            # 統合パターン定義
│   └── team-topology-alignment.md         # チーム構造との整合性確認
└── evolution/                             # 進化戦略
    ├── bounded-context-evolution.md       # コンテキスト進化計画
    └── migration-strategy.md              # 移行戦略
```

**ファイル命名規則**:

- **コンテキスト定義**: `{ContextName}.context.md`
- **Canvas定義**: `{ContextName}.canvas.md`
- **kebab-case使用**: ディレクトリ・プロセスファイルはkebab-case

## 境界づけられたコンテキスト定義の手順

### フェーズ1: 協働的発見プロセス

#### 1.1 Event Stormingワークショップ実施

**参照ドキュメント**: [Event Stormingワークショップガイド](./03.04_event-storming-workshop-guide.md)の成果物

**実施期間**: 1-2日間（Big Picture + Design Level）
**参加者**: ドメインエキスパート、アーキテクト、開発チーム、プロダクトオーナー

**Big Picture Event Storming テンプレート**:

```markdown
# Domain Events Discovery

## Event Storm 全体概要

| Event Name | Trigger | Involved Actors | Business Value | Context Hint | Priority |
|------------|---------|-----------------|----------------|--------------|----------|
| {EventName} | {Trigger condition} | {Actor list} | {Business value} | {Potential context} | High/Medium/Low |

## Command & Aggregate Identification

| Command | Target Aggregate | Resulting Event | Business Rule | Context Ownership | Complexity |
|---------|------------------|-----------------|---------------|-------------------|------------|
| {CommandName} | {AggregateName} | {EventName} | {Business rule} | {Context candidate} | High/Medium/Low |

## Business Process Flow

| Process Step | Events Involved | Decision Points | Exception Handling | Context Boundary Hints |
|--------------|-----------------|-----------------|-------------------|----------------------|
| {Process step} | {Event sequence} | {Decision criteria} | {Exception flow} | {Boundary indicators} |
```

#### 1.2 Pivotal Events Analysis（境界発見の核心）

**目的**: コンテキスト境界を示す重要なイベントを特定する

**Pivotal Events分析テンプレート**:

```markdown
# Pivotal Events Matrix

## 境界決定イベント分析

| Pivotal Event | Context Before | Context After | Boundary Reason | Integration Pattern | Team Impact |
|---------------|----------------|----------------|-----------------|-------------------|--------------|
| {EventName} | {Source context} | {Target context} | {Why boundary exists} | {How to integrate} | {Team changes needed} |

## Context Transition Analysis

| State Before | Pivotal Event | State After | Responsibility Transfer | Consistency Requirements | Business Rules Change |
|--------------|---------------|-------------|------------------------|-------------------------|----------------------|
| {Before state} | {Event} | {After state} | {What transfers} | Strong/Eventually consistent | {Rule changes} |
```

#### 1.3 Domain Language Alignment

**重要**: ユビキタス言語の境界を明確化する

**言語境界分析テンプレート**:

```markdown
# Ubiquitous Language Mapping

## 用語境界分析

| Term | Context A Meaning | Context B Meaning | Translation Needed | Shared Kernel Candidate |
|------|-------------------|-------------------|-------------------|------------------------|
| {Term} | {Meaning in A} | {Meaning in B} | Yes/No | Yes/No |

## Language Boundary Indicators

| Language Boundary | Contexts Involved | Communication Gap | Resolution Strategy |
|-------------------|-------------------|-------------------|-------------------|
| {Boundary description} | {Context list} | {Gap description} | {How to resolve} |
```

### フェーズ2: コンテキスト候補モデリング

#### 2.1 Context Candidate Definition

**コンテキスト候補分析テンプレート**:

```markdown
# Context Candidate Analysis

## 候補コンテキスト一覧

| Context Candidate | Core Domain Events | Core Aggregates | Primary Responsibility | Team Assignment | Size Assessment |
|-------------------|-------------------|-----------------|----------------------|-----------------|-----------------|
| {ContextName} | {Event list} | {Aggregate list} | {Main responsibility} | {Team name} | Appropriate/Too Large/Too Small |

## Context Cohesion Analysis

| Context | Internal Cohesion | External Coupling | Business Capability | Technology Alignment | Evolution Independence |
|---------|------------------|-------------------|--------------------|--------------------|----------------------|
| {ContextName} | High/Medium/Low | High/Medium/Low | {Capability description} | {Tech stack fit} | High/Medium/Low |
```

#### 2.2 Context Sizing Guidelines

**設計原則**:

- Bounded Context ≥ Aggregate
- Bounded Context ≤ Domain
- 1 Bounded Context = 1 Team (理想)
- 1 Bounded Context = 1 Microservice

**サイズ検証テンプレート**:

```markdown
# Context Size Validation

| Context | Aggregate Count | Team Size | Development Velocity | Operational Complexity | Verdict |
|---------|----------------|-----------|----------------------|----------------------|---------|
| {ContextName} | {Count} | {Team size} | {Velocity assessment} | {Ops complexity} | Appropriate/Split/Merge |
```

### フェーズ3: Bounded Context Canvas作成

#### 3.1 Standard Canvas Template

各コンテキストに対して以下のcanvasを作成する：

```markdown
# Bounded Context Canvas: {Context Name}

## Strategic Classification
- **Domain Type**: Core Domain / Supporting Domain / Generic Subdomain
- **Business Criticality**: High / Medium / Low
- **Evolution Stage**: Genesis / Custom Built / Product / Commodity

## Purpose & Responsibility
- **Purpose**: {Why this context exists}
- **Key Responsibilities**: {What this context does}
- **Success Metrics**: {How we measure success}

## Domain Model
- **Core Aggregates**: {Main business entities}
- **Key Value Objects**: {Important value objects}
- **Domain Services**: {Complex business logic}
- **Domain Events**: {Published events}

## Ubiquitous Language

| Term | Definition | Synonyms | Usage Context |
|------|------------|----------|---------------|
| {Term} | {Definition} | {Alternative terms} | {When used} |

## Business Decisions
- **Critical Business Rules**: {Key business constraints}
- **Policy Decisions**: {Important policies}
- **Assumptions**: {Key assumptions made}

## Communication Patterns

### Inbound Communication
| Source Context | Message Type | Content | Frequency | SLA Requirements |
|----------------|--------------|---------|-----------|------------------|
| {Source} | Command/Event/Query | {Message content} | {How often} | {Performance needs} |

### Outbound Communication  
| Target Context | Message Type | Content | Delivery Guarantee | Business Impact |
|----------------|--------------|---------|-------------------|-----------------|
| {Target} | Command/Event/Query | {Message content} | At-least-once/Exactly-once | {Impact if fails} |

## Team Topology Alignment
- **Team Assignment**: {Which team owns this}
- **Team Type**: Stream-aligned / Platform / Enabling / Complicated-subsystem
- **Interaction Modes**: Collaboration / X-as-a-Service / Facilitating
- **Cognitive Load**: {Assessment of complexity}

## Technology Choices
- **Primary Technology Stack**: {Main technologies}
- **Data Storage**: {Database choices}
- **Integration Technology**: {How it integrates}
- **Deployment Model**: {How it's deployed}

## Quality Attributes
- **Performance Requirements**: {Speed, throughput needs}
- **Availability Requirements**: {Uptime needs}
- **Consistency Requirements**: Strong/Eventual consistency
- **Security Requirements**: {Security considerations}
```

### フェーズ4: Context Mapping & Integration Design

#### 4.1 Context Map Creation

**Context Map テンプレート**:

```markdown
# Context Map

## Context Relationships Overview

| Upstream Context | Downstream Context | Relationship Pattern | Integration Style | Evolution Strategy |
|------------------|-------------------|---------------------|-------------------|-------------------|
| {Upstream} | {Downstream} | Partnership/Customer-Supplier/Conformist/Anti-corruption Layer/Open Host Service/Shared Kernel | Synchronous/Asynchronous/Event-driven | {How relationship evolves} |

## Integration Patterns Detail

### Pattern: Customer-Supplier
| Upstream | Downstream | Service Contract | SLA | Change Management |
|----------|------------|------------------|-----|-------------------|
| {Context A} | {Context B} | {Contract definition} | {Performance SLA} | {How changes managed} |

### Pattern: Anti-Corruption Layer
| Protected Context | External Context | Translation Layer | Business Logic Protection | Maintenance Strategy |
|-------------------|------------------|-------------------|-------------------------|---------------------|
| {Internal} | {External} | {How data translated} | {Business rules protected} | {How ACL maintained} |

### Pattern: Shared Kernel
| Context A | Context B | Shared Elements | Change Coordination | Risk Management |
|-----------|-----------|-----------------|-------------------|------------------|
| {Context A} | {Context B} | {Shared code/data} | {How changes coordinated} | {Risks and mitigation} |
```

#### 4.2 Domain Message Flow Design

**メッセージフロー設計テンプレート**:

```markdown
# Domain Message Flow Architecture

## Event-Driven Communication Design

| Source Context | Target Context | Message Type | Event Schema | Routing Strategy | Error Handling |
|----------------|----------------|--------------|--------------|------------------|----------------|
| {Source} | {Target} | Command/Event/Query | {Schema definition} | {How routed} | {Error strategy} |

## Message Delivery Guarantees

| Message Flow | Delivery Guarantee | Idempotency | Ordering | Retry Strategy | Dead Letter Handling |
|--------------|-------------------|-------------|----------|----------------|---------------------|
| {Source → Target} | At-least-once/Exactly-once/At-most-once | Required/Not Required | Required/Not Required | {Retry policy} | {DLQ strategy} |

## Saga Orchestration (if applicable)

| Saga Name | Participating Contexts | Compensation Logic | Failure Scenarios | Monitoring Strategy |
|-----------|----------------------|-------------------|-------------------|-------------------|
| {Saga name} | {Context list} | {Rollback logic} | {Failure cases} | {How monitored} |
```

### フェーズ5: Team Topology Alignment

#### 5.1 Conway's Law Consideration

**チーム構造整合性テンプレート**:

```markdown
# Team Topology & Conway's Law Alignment

## Team-Context Mapping

| Team Name | Team Type | Owned Contexts | Interaction Patterns | Communication Frequency |
|-----------|-----------|----------------|---------------------|----------------------|
| {Team name} | Stream-aligned/Platform/Enabling/Complicated-subsystem | {Context list} | {How they interact} | {How often} |

## Team Interaction Assessment

| Team A | Team B | Interaction Mode | Communication Overhead | Coupling Risk | Optimization Needed |
|--------|--------|------------------|----------------------|---------------|-------------------|
| {Team A} | {Team B} | Collaboration/X-as-a-Service/Facilitating | High/Medium/Low | High/Medium/Low | Yes/No |

## Cognitive Load Analysis

| Team | Context Complexity | Technology Diversity | Domain Complexity | Total Load | Action Required |
|------|-------------------|-------------------|------------------|------------|-----------------|
| {Team} | High/Medium/Low | High/Medium/Low | High/Medium/Low | Appropriate/High/Low | {Action needed} |
```

### フェーズ6: 進化戦略定義

#### 6.1 Context Evolution Strategy

**進化戦略テンプレート**:

```markdown
# Bounded Context Evolution Strategy

## Context Lifecycle Management

| Context | Current Stage | Target Stage | Evolution Path | Timeline | Success Criteria |
|---------|---------------|--------------|----------------|----------|------------------|
| {Context} | {Current} | {Target} | {How to evolve} | {When} | {Success measures} |

## Split/Merge Strategy

| Current Context | Action | Resulting Contexts | Business Reason | Technical Reason | Migration Plan |
|-----------------|--------|-------------------|-----------------|------------------|----------------|
| {Context} | Split/Merge | {New contexts} | {Business driver} | {Technical driver} | {How to migrate} |

## API Versioning Strategy

| Context | API Versioning Approach | Backward Compatibility | Migration Support | Deprecation Policy |
|---------|------------------------|------------------------|-------------------|-------------------|
| {Context} | {Versioning strategy} | {Compatibility level} | {Migration tools} | {Deprecation rules} |
```

## 完了判定基準

### 必須要件

- **Event Stormingワークショップ完了**: 実施結果が文書化されている
- **Pivotal Events特定**: 境界根拠が明確になっている
- **Bounded Context Canvas作成**: 各コンテキストにCanvasが作成されている
- **Context Map完成**: 統合パターンが定義されている
- **Team Topology整合性**: チーム構造との整合性が確認されている
- **Message Flow設計**: Domain Message Flowが設計されている
- **ユビキタス言語境界**: 言語境界が明確化されている
- **進化戦略定義**: Context進化戦略が定義されている

### 品質要件

- **1コンテキスト＝1マイクロサービス**: 実装境界との一致が確保されている
- **Conway's Law考慮**: チーム構造との整合性がある
- **疎結合通信**: Domain Eventsによる疎結合通信が設計されている
- **適切なサイズ**: 集約以上、ドメイン未満のコンテキストサイズ
- **ビジネス価値基準**: ビジネス価値に基づく境界設定がされている

### 文書品質要件

- **構造化出力**: 指定ディレクトリ構造に従ってファイルが分割されている
- **具体的テンプレート**: 実践的なサンプルデータで記述されている
- **トレーサビリティ**: Event Stormingから境界決定までの追跡可能性
- **実装可能性**: マイクロサービス実装に直結する設計指針の提供

## 完了後の必須アクション

1. **直ちに**ユーザーに「境界づけられたコンテキスト定義・戦略的設計」のレビューを依頼する
2. **ADR作成**: 以下の重要な戦略的設計決定について、必ずADRを作成する：
   - **コンテキスト境界決定**: Event Stormingに基づく境界設定の根拠
   - **統合パターン選択決定**: Context間統合パターンの選択理由
   - **チーム構造整合決定**: Conway's Lawを考慮したチーム-コンテキスト対応の根拠
   - **進化戦略決定**: コンテキスト進化・分割・統合戦略の選択理由
3. **ADR作成手順**:
   - 各ADRは「Proposed」ステータスで作成
   - ADRインデックス（`docs/project/adr/README.md`）への追加
   - DDD設計ドキュメント（`docs/project/ddd-design/README.md`）からのリンク追加
4. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「API設計」「DB設計」でコンテキスト境界を実装境界に反映
   - 並行フロー：「マイクロサービス設計」でコンテキスト単位のサービス設計
   - 戻りフロー：境界決定に基づく集約・ドメインサービス設計の見直し
5. ユーザーの明示的な承認を得てから指定された工程に進む

## 参考：このアプローチの特徴

### 2024年DDD最新ベストプラクティス統合

**選択根拠**:

- ✅ **Event Storming中心**: 協働的発見プロセスを重視
- ✅ **Team Topology統合**: Conway's Lawを考慮した組織設計
- ✅ **Event-Driven Architecture**: Domain Eventsによる疎結合設計
- ✅ **Microservices Ready**: 1 Context = 1 Service の原則適用

### 実用性向上

- **段階的プロセス**: 6つの明確なフェーズに分割
- **具体的テンプレート**: 実際に使える詳細なテンプレート
- **品質担保**: 完了判定基準による品質確保
- **継続改善**: 進化戦略による長期保守性確保

### 現代的アーキテクチャ対応

- **マイクロサービス**: 適切な境界でのサービス分割
- **イベント駆動**: 非同期通信による疎結合実現
- **プラットフォーム思考**: 再利用可能なコンポーネント設計
- **スケーラビリティ**: 将来の成長を見据えた設計

この選択により、現代的なマイクロサービスアーキテクチャと整合した実装可能なコンテキスト境界設計が実現される。
