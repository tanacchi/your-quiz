# 仕様整理

## 目的

- 新機能開発において、ビジネス要件を明確化し、開発チーム全体が同じ理解を持つため、ユーザーストーリーと成功／失敗パターンを4W1Hで整理し、RESTステータスと振る舞いを明示した仕様書を作成する

## 遵守事項

- ユーザーストーリーを4W1H形式で明確に記述する
- **ユーザー体験中心の記述**: エラー時・成功時にユーザーが「何を見て」「どう感じ」「何ができるか」を主語として記述する
- 成功・失敗パターンをユーザー体験の観点で定義し、技術的分類としてHTTPステータスコードを併記する
- **機能要件と非機能要件の明確な分離**: 各要件を適切なカテゴリに分類し、混在を防ぐ
- 指示者との対話を通して内容をブラッシュアップし、都度ドキュメントに反映する。
- 「一旦」「とりあえず」という言葉に注意する。後から変更が大変な項目であれば深く考慮した方が良いと提案する。

## ⚠️ 注意事項（工程を跨ぐ内容への言及禁止）

- **API仕様の詳細設計禁止**: エンドポイント、リクエスト/レスポンス構造、JSON形式の具体的記述は次工程（API設計）で行うこと
- **アーキテクチャ実装詳細の禁止**: DB設計、技術スタック選定、フレームワーク仕様の記述は次工程（技術設計・技術選定）で行うこと
- **未確定事項への深追い禁止**: 「まだ早い」「先の話」「詳細すぎ」とユーザーが判断した場合は即座に future-work.md に移動し、現工程から除外すること
- **HTTPステータスコード例外**: エラーシナリオでのHTTPステータスコード記載は技術的分類として必須だが、詳細なレスポンス構造は記載せず、ユーザーが体験するエラー状況（メッセージ表示、操作継続可否等）に焦点を当てること

## Future Work 分離原則

以下に該当する内容は `docs/project/specifications/future-work.md` に記載し、現在の仕様から除外する：

- 「将来的に」「次フェーズで」「後で検討」等の表現を含む機能
- 現在の MVP（Minimum Viable Product）に含まれない拡張機能
- ユーザーが「先の話」と判断した技術要件や詳細仕様
- 長期的なロードマップに関わる機能拡張計画

## 工程境界の明確化

### 仕様整理工程で記載すべき内容（現工程）

- ビジネス要件とユーザーストーリー（4W1H）
- 基本的な成功・失敗シナリオ（ユーザー体験の観点から）
- 数値化された非機能要件（性能・制約）
- エラー時のユーザー体験（メッセージ表示、操作継続可否、回復手段）
- 技術的分類としてのHTTPステータスコード

### 仕様整理工程で記載してはいけない内容（次工程以降）

- API エンドポイントの URL パス
- JSON リクエスト/レスポンスの詳細構造
- データベーススキーマ設計
- 技術フレームワークの選定理由
- 実装パターンの詳細

## 仕様整理の手順

### 0. 出力先ディレクトリ作成

#### 0.1 ディレクトリ構造

```
docs/project/specifications/
├── user-stories/           # ユーザーストーリー
├── success-scenarios/     # 成功パターン
├── error-scenarios/       # 失敗パターン
└── requirements/          # 非機能要件
```

#### 0.2 ファイル命名規則

- **ユーザーストーリー**: `user-story-[機能名].md`
- **成功シナリオ**: `success-[機能名].md`
- **エラーシナリオ**: `error-[機能名].md`
- **要件定義**: `requirements-[機能名].md`

### 1. ユーザーストーリー作成

#### 1.1 4W1H形式での記述

以下の構造でユーザーストーリーを記述する：

```
## ユーザーストーリー: [機能名]

### Who（誰が）
- **ユーザー種別**: [具体的なユーザータイプ]
- **権限レベル**: [必要な権限や認証状態]
- **前提条件**: [ユーザーが満たすべき条件]

### What（何を）
- **実現したい機能**: [具体的な機能内容]
- **対象データ**: [操作対象となるデータや情報]
- **操作範囲**: [機能が影響する範囲]

### When（いつ）
- **実行タイミング**: [機能を使用する場面]
- **前提状況**: [機能実行時のシステム状態]
- **制約条件**: [時間的・状況的制約]

### Where（どこで）
- **実行環境**: [Webブラウザ、モバイルアプリ等]
- **画面・ページ**: [具体的な実行場所]
- **システム範囲**: [関連するシステム・サービス]

### Why（なぜ）
- **ビジネス価値**: [この機能が提供する価値]
- **解決する課題**: [現状の問題点]
- **期待する結果**: [機能実現後の理想状態]
```

#### 1.2 ユーザーストーリー記述の原則

- **具体性**: 曖昧な表現を避け、測定可能な内容にする
- **ユーザー中心**: 技術実装ではなくユーザーの行動と価値に焦点
- **独立性**: 他のストーリーに依存しない単独で理解可能な内容
- **検証可能性**: 完了の判定が明確にできる内容

#### 1.3 ユーザーストーリー出力

作成したユーザーストーリーを `docs/project/specifications/user-stories/user-story-[機能名].md` に保存する。

### 2. 成功パターン定義

#### 2.1 正常系シナリオ

```
## 成功パターン

### シナリオ: [シナリオ名]

**前提条件**:
- [システムやデータの初期状態]
- [ユーザーの認証・権限状態]

**実行手順**:
1. [具体的なアクション1]
2. [具体的なアクション2]
3. [具体的なアクション3]

**期待結果**:
- **ユーザー体験**: [ユーザーが見る画面表示、感じる体験、次に取れる行動]
- **システム動作**: [ユーザーから見える動作・反応]
- **技術分類**: HTTPステータス 200 OK / 201 Created / 204 No Content
```

#### 2.2 バリエーションパターン

- **境界値テスト**: 最小値、最大値での動作
- **データパターン**: 異なるデータタイプでの正常動作
- **権限パターン**: 異なる権限レベルでの正常動作

#### 2.3 成功パターン出力

作成した成功パターンを `docs/project/specifications/success-scenarios/success-[機能名].md` に保存する。

### 3. 失敗パターン定義

#### 3.1 異常系シナリオ

```
## 失敗パターン

### エラーシナリオ: [エラー種別]

**発生条件**:
- [エラーが発生する具体的な状況]
- [不正な入力や状態]

**実行手順**:
1. [エラーを引き起こすアクション]
2. [システムの反応]

**期待結果**:
- **ユーザー体験**: [ユーザーが見るエラーメッセージ、利用継続可否、回復手段]
- **エラー対応**: [ユーザーが取れる次の行動、システムからの案内]
- **システム動作**: [ユーザーから見える処理の停止・継続状況]
- **技術分類**: HTTPステータス 400 Bad Request / 401 Unauthorized / 403 Forbidden / 404 Not Found / 409 Conflict / 422 Unprocessable Entity / 500 Internal Server Error

```

#### 3.2 エラーパターンの分類

- **バリデーションエラー**: 入力値の形式・範囲違反
- **認証・認可エラー**: 権限不足やセッション切れ
- **ビジネスルールエラー**: 業務制約違反
- **システムエラー**: サーバー障害や外部API障害
- **リソースエラー**: データ不存在や重複

#### 3.3 失敗パターン出力

作成した失敗パターンを `docs/project/specifications/error-scenarios/error-[機能名].md` に保存する。

### 4. データ整合性要件

#### 4.1 ユーザー体験としての制約・制限

ユーザーが利用する際に体験する「できること・できないこと」「制約・制限」を明確に記載する。

**例:**

- ユーザーは同じメールアドレスで複数登録できない
- 1人のユーザーは複数のグループに属することはできない
- 1つのクイズは1人の作成者しか持てない
- 回答は1問につき1回のみ可能
- クイズのタイトルは空欄にできない
- 公開クイズは承認済みのみ表示される

※ 技術用語（外部キー、一意性、ACID等）は記載しない。あくまで「ユーザーが何をできて、何ができないか」「どんな体験・制約があるか」を主語にすること。

### 5. 機能要件・非機能要件の分類ガイド

#### 5.1 機能要件（Functional Requirements）

**定義**: システムが「何をするか」を定義する要件

**含むべき内容**:

- ユーザーストーリー（4W1H）
- 成功・失敗シナリオの具体的動作
- データ構造・入力制約（文字数制限、必須項目等）
- UI動作・画面遷移
- ビジネスルール・業務フロー

**記載場所**: `user-stories/`, `success-scenarios/`, `error-scenarios/`

#### 5.2 非機能要件（Non-Functional Requirements）

**定義**: システムの「品質特性」「制約条件」を定義する要件

**含むべき内容**:

- パフォーマンス要件（応答時間、スループット）
- 可用性要件（稼働率、対応環境）
- セキュリティ要件（認証方式、暗号化）
- 保守性・拡張性要件
- 運用要件（監視、バックアップ）

**記載場所**: `requirements/requirements-[機能名].md`

#### 5.3 分類判断基準

**機能要件の判断例**:

- 「◯×形式のクイズを出題する」→ 機能要件
- 「右スワイプで◯回答」→ 機能要件
- 「問題文は500文字以内」→ 機能要件
- 「エラー時にメッセージ表示」→ 機能要件

**非機能要件の判断例**:

- 「API応答時間95%ile 100ms以内」→ 非機能要件
- 「同時100接続対応」→ 非機能要件
- 「スマートフォンのみ対応」→ 非機能要件
- 「JWT認証方式」→ 非機能要件

#### 5.4 混在防止チェックリスト

作成時に以下を確認せよ:

- [ ] ユーザーストーリーに品質特性（性能・可用性等）が混入していないか
- [ ] 非機能要件にUI動作・データ仕様が混入していないか
- [ ] 「何をするか」と「どのような品質で」が明確に分離されているか
- [ ] 技術実装詳細が非機能要件に混入していないか

### 6. パフォーマンス要件

#### 6.1 応答時間

- **API応答時間**: 95%ile で [X]ms 以内
- **画面表示時間**: 初回読み込み [X]秒以内
- **バッチ処理時間**: [X]件の処理を [X]分以内

#### 6.2 スループット

- **同時接続数**: 最大 [X] 接続
- **リクエスト処理数**: 毎秒 [X] リクエスト
- **データ処理量**: 毎時 [X] GB

### 7. セキュリティ要件

#### 7.1 認証・認可

- **認証方式**: JWT トークン / OAuth 2.0
- **権限管理**: RBAC (Role-Based Access Control)
- **セッション管理**: タイムアウト時間と更新方式

#### 7.2 データ保護

- **暗号化**: 機密データの暗号化方式
- **アクセスログ**: 監査証跡の記録要件
- **個人情報保護**: GDPR、個人情報保護法への対応

### 8. 要件ドキュメント出力

#### 8.1 非機能要件出力

パフォーマンス、可用性、セキュリティ等の品質特性要件を `docs/project/specifications/requirements/requirements-[機能名].md` に保存する。

#### 8.2 完成した仕様書の構成

```text
docs/project/specifications/
├── user-stories/user-story-[機能名].md      # ユーザーストーリー
├── success-scenarios/success-[機能名].md    # 成功パターン
├── error-scenarios/error-[機能名].md        # 失敗パターン
├── requirements/requirements-[機能名].md    # 非機能要件
└── future-work.md                           # 将来的な機能拡張・改善案
```

## 完了判定基準

- `docs/project/specifications/` ディレクトリ配下に適切な構造でファイルが作成されていること
- ユーザーストーリーが4W1H（Who, What, When, Where, Why）で記述されていること
- 成功／失敗パターンがRESTステータスと振る舞いで明示されていること
- 機能要件と非機能要件が適切に分離されていること（UI動作は機能要件、性能・品質特性は非機能要件）
- パフォーマンス要件が数値で明示されていること
- セキュリティ要件が具体的な実装方式で記述されていること
- すべてのエラーパターンに適切なHTTPステータスコードが割り当てられていること
- ユーザー体験とシステム動作の両方の観点で記述されていること
- ファイル命名規則に従って適切にファイルが分割されていること
- 作成対象が実際のファイルとして出力されていること
- Markdownのlintルールに従っていない記述が少ないこと
- **工程境界遵守**: API詳細設計・技術実装詳細を含まないこと
- **Future Work分離**: 将来的機能が future-work.md に適切に分離されていること

## 完了後

- アウトプットを全てリストアップし、ユーザーからのレビューを受ける
