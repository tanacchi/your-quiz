# 単体テスト実装（TDD）

## 目的

- TDD（テスト駆動開発）でAPIレイヤーの個別コンポーネントを実装・検証し、95%以上のカバレッジを達成する包括的な単体テスト群を作成せよ

## 遵守事項

- **TDDサイクル必須**: Red-Green-Refactorサイクルに従った実装を行え
- **95%以上カバレッジ必須**: テストカバレッジ95%以上を達成せよ
- **階層構造化**: describeブロックで機能→メソッド→条件の階層構造を構築せよ
- **パラメータ化活用**: test.each()で同一ロジック・異なるデータのテスト重複を排除せよ
- **表形式整理**: 全テストケース、境界値、異常系を表形式で網羅的に整理せよ
- **Mock/Stub使用**: 責務を明確に分離してテスト対象を限定せよ

## アウトプット出力先

### ファイル配置ルール

- **テストファイル**: テスト対象ファイルと同じディレクトリに配置せよ
- **命名規則**: `User.ts` のテストは `User.spec.ts` で作成せよ
- **設定ファイル**: `tests/` ディレクトリに集約せよ（vitest.config.ts、mock、fixture等）

## 単体テスト実装の手順

### 1. TDDサイクルの実践

#### 1.1 Red-Green-Refactorサイクル

1. **Red**: 失敗するテストを先に書く
2. **Green**: テストを通すための最小限のコードを実装
3. **Refactor**: コードの品質を向上させる（テストが通ることを保証）

#### 1.2 テスト構造化の原則

**describe階層設計原則**:

- **機能単位**: 最上位のdescribeはクラス・モジュール単位
- **メソッド単位**: 2段目のdescribeは個別メソッド単位
- **条件単位**: 3段目のdescribeは特定の条件・状況単位
- **テストケース**: 最下位のtest/itで具体的なアサーション

**パラメータ化テスト活用原則**:

- **同一ロジック・異なるデータ**: test.each()で重複排除
- **境界値テスト**: 複数の境界条件を効率的にテスト
- **異常系パターン**: エラーパターンを網羅的にテスト

#### 1.3 テスト実装の基本例

```typescript
// パラメータ化テストの例
test.each([
  ['valid email', 'user@example.com', true],
  ['invalid format', 'invalid-email', false],
  ['missing domain', 'user@', false],
  ['missing @', 'user-example.com', false],
])('should validate %s: %s', async (description, email, isValid) => {
  const userData = { email, name: 'Test User' };

  if (isValid) {
    await expect(userService.createUser(userData)).resolves.toBeDefined();
  } else {
    await expect(userService.createUser(userData)).rejects.toThrow();
  }
});
```

### 2. レイヤー別テスト戦略

#### 2.1 ディシジョンテーブル設計

**作成原則**: 条件部・アクション部・ルール部を漏れなく重複なく整理せよ

**例: ユーザー登録**:

| 条件 | R1 | R2 | R3 | R4 | R5 | R6 |
|------|----|----|----|----|----|----|
| Email形式正当 | ○ | ○ | ○ | × | × | × |
| Email未重複 | ○ | × | × | ○ | ○ | × |
| Password規則遵守 | ○ | ○ | × | ○ | × | × |
| **アクション** | | | | | | |
| ユーザー作成成功 | ✓ | - | - | - | - | - |
| エラー | - | 409 | 400 | 400 | 400 | 400 |

**境界値・セキュリティテスト**: 以下パターンを必須でテストせよ

- **境界値**: 最小値±1、最大値±1、空値、null
- **セキュリティ**: SQLインジェクション、XSS、パストラバーサル、コマンドインジェクション

#### 2.2 APIコントローラー層テスト

**必須テストパターン**:

- **正常系**: レスポンス形式、HTTPステータス確認
- **異常系**: バリデーションエラー、認証エラー、サーバーエラー
- **パラメータ化**: test.each()でエラーパターン網羅

**実装例**:

```typescript
test.each([
  ['invalid email', { email: 'invalid' }, 'INVALID_EMAIL'],
  ['missing name', { email: 'test@example.com' }, 'MISSING_NAME'],
])('should handle %s', async (desc, body, errorCode) => {
  // テスト実装
})
```

#### 2.3 ドメインサービス層テスト

**必須テストパターン**:

- **ビジネスルール検証**: ドメイン固有制約、権限チェック
- **依存関係モック**: Repository等の外部依存をモック化
- **例外ハンドリング**: ドメインエラーの適切な発生確認

#### 2.4 リポジトリ実装テスト

**必須テストパターン**:

- **データ永続化**: CRUD操作の正確性確認
- **エラーハンドリング**: DBエラー、制約違反、コネクションエラー
- **パラメータ化**: 境界値、特殊文字、大文字小文字

## 3. Vitestモック機能

### 3.1 基本モック操作

**モジュールモック**: `vi.mock('モジュールパス')`
**関数モック**: `vi.fn()`, `vi.spyOn()`
**戻り値設定**: `mockReturnValue()`, `mockResolvedValue()`

### 3.2 テストダブル使い分け

- **Mock**: 呼び出し検証が必要な場合
- **Stub**: 特定の戻り値が必要な場合
- **Spy**: 既存実装の呼び出し監視が必要な場合

### 3.3 パラメータ化Mock

**外部サービスレスポンスパターン**をtest.each()で網羅せよ

### 4. テストデータ管理

#### 4.1 Fixtureファイル作成

tests/fixtures/配下にJSONC形式でテストデータを管理せよ

#### 4.2 TestDataBuilderクラス

**パラメータ化テスト用データ生成機能を必須で実装せよ**:

- 正常データ生成メソッド
- 境界値テストケース生成
- 特殊文字パターン生成

### 5. エラーハンドリングテスト

#### 5.1 バリデーションエラー

**test.each()でバリデーションパターンを網羅せよ**:

- Email形式エラー
- 必須項目欠如エラー
- 文字数制限エラー

#### 5.2 例外処理テスト

**パラメータ化で例外パターンを網羅せよ**:

- ネットワークエラー
- データベースエラー
- ビジネスルール違反

### 6. カバレッジとメトリクス

**必須要件**: カバレッジ95%以上、実行時間30秒以内

### 7. UIコンポーネントテスト

**必須テストパターン**:

- **data-testid必須**: 要素取得にdata-testid属性を使用
- **ユーザー操作**: 実際のユーザー操作をシミュレーション
- **パラメータ化**: test.each()でプロパティパターンを効率的にテスト

### 8. パフォーマンステスト

performance.now()でメソッド実行時間を測定し、閾値以下であることを確認せよ

### 9. CI/CD統合

**package.json設定例**:

```json
{
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:ci": "vitest run --coverage --reporter=verbose"
  }
}
```

## 完了判定基準

### 必須要件

- **パラメータ化テストの活用**: test.each()を使用し、同一ロジックの異なるデータパターンを効率的にテスト
- **describe階層構造**: 機能・メソッド・条件の3階層でテストを体系化
- **data-testid必須使用**: UIコンポーネントテストではdata-testid属性による要素取得を必須とする
- **全テストがGreen**: 全ての単体テストがGreenで通過している
- **カバレッジ95%以上**: テストカバレッジが95%以上達成されている
- **Mock/Stub適切使用**: テスト対象の責務が明確に分離されている
- **TDDサイクル遵守**: Red-Green-Refactorサイクルに従って実装されている
- **エラーハンドリング**: エッジケースと異常系が適切にテストされている
- **CI/CD統合**: テストが自動実行される環境が構築されている

### 品質要件

- **BDD連携**: BDDテストとの役割分担が明確になっている
- **UIコンポーネント品質**: ユーザー操作パターン、アクセシビリティ、ローディング状態が適切にテストされている
- **保守性**: テストコードが保守しやすく、理解しやすい構造になっている
- **パフォーマンス**: パフォーマンステストが実装されている
- **データ管理**: テストデータとFixtureが適切に管理されている

## 完了後の必須アクション

1. **直ちに**ユーザーに「単体テストスイート」のレビューを依頼する
2. **ADR作成判断**: テストフレームワーク選定、テスト戦略について、ADRでの記録をユーザーに提案する
3. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「TDD実装（Red→Green）」に進む
   - 戻りフロー：テスト設計による仕様見直しで前工程に戻る
4. ユーザーの明示的な承認を得てから指定された工程に進む
