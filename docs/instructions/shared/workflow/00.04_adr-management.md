# アーキテクチャ決定記録（ADR）管理

## 目的

- プロジェクト全体のアーキテクチャ決定を体系的に記録・管理し、設計判断の透明性とトレーサビリティを確保するため、標準化されたフォーマットとプロセスに基づいて、アーキテクチャ決定記録（ADR：Architecture Decision Records）の作成・管理・レビュー体制を構築する

## 遵守事項

- 標準化されたADRフォーマットに従った記録作成を行う
- アーキテクチャ決定の背景・選択肢・理由を明確に記述する
- 決定事項の影響範囲とトレードオフを明示する
- 決定記録の不可逆性とトレーサビリティを保証する

## アウトプット出力先

### 基本方針

ADRはプロジェクト固有のドキュメントとして、プロジェクト内で一元管理し、開発チーム全体がアクセス可能な場所に配置する。

### 出力先ディレクトリ構造

```text
docs/
├── project/
│   └── adr/
│       ├── README.md                    # ADR一覧とインデックス
│       ├── 0001-architecture-style.md   # システムアーキテクチャスタイル選定
│       ├── 0002-database-selection.md   # データベース選定
│       ├── 0003-communication-pattern.md # 通信パターン選定
│       └── templates/
│           └── adr-template.md          # ADR作成テンプレート
```

### ファイル命名規則

- **ADRファイル**: `[4桁連番]-[決定内容の簡潔な英語表記].md`
  - 例: `0001-monolith-architecture.md`
  - 例: `0002-postgresql-database.md`
- **インデックスファイル**: `README.md`
- **テンプレートファイル**: `adr-template.md`

### 各成果物の保存場所

- **ADRファイル**: `adr/` 直下に配置
- **テンプレート**: `adr/templates/` 配下に配置
- **参考資料**: 必要に応じて `adr/references/` 配下に配置

## ADR管理の手順

### 1. ADR作成フロー

#### 1.1 ADR作成の契機

以下のタイミングでADRの作成が必要となる：

- **重要なアーキテクチャ決定**: システム全体に影響する技術選択
- **トレードオフが存在する決定**: 複数の選択肢から一つを選ぶ場合
- **制約に基づく決定**: 外部要因により選択肢が限られる場合
- **実験的な決定**: 新技術や新手法の採用を決定する場合
- **既存決定の変更**: 過去のADRを覆す新たな決定

#### 1.2 ADR番号の採番

- **連番管理**: 既存ADRの最後の番号+1で採番
- **4桁ゼロパディング**: `0001`, `0002`, `0003`...の形式
- **欠番禁止**: 削除ではなくステータス変更で管理

#### 1.3 ADR作成プロセス

1. **テンプレート使用**: `adr-template.md`をコピーして作成開始
2. **下書き作成**: ステータス「Proposed」で内容を記述
3. **初回提出**: 必ずステータス「Proposed」で提出・レビュー依頼
4. **ステークホルダーレビュー**: 関係者による内容確認
5. **指示者承認**: レビューを経て指示者が「Accepted」に変更
6. **ファイル配置**: 承認後の正式なファイル名で配置・コミット

**重要**: 新規ADRは必ず「Proposed」ステータスで作成し、指示者の承認を経て「Accepted」に変更する。作成者が直接「Accepted」にしてはならない。

### 2. ADRフォーマット

#### 2.1 標準ADRテンプレート

```markdown
# ADR-[番号]: [決定内容の簡潔な説明]

## Status
[Proposed | Accepted | Deprecated | Superseded by ADR-XXXX]

## Context
[決定が必要になった背景・状況・問題]

### Background
- [現在の状況や既存システムの制約]
- [解決すべき課題や要件]

### Drivers
- [決定を促進する要因]
- [制約条件や前提条件]

## Decision
[採用した解決策・アーキテクチャ・技術の詳細]

### Chosen Option
**[選択された解決策名]**

[選択理由の詳細説明]

### Alternatives Considered
以下の代替案を検討した：

| 選択肢 | メリット | デメリット | 評価 |
|--------|----------|------------|------|
| 選択肢A | ○○○ | ×××× | ★★ |
| **選択案B** | **○○○○** | **△△** | **★★★** |
| 選択肢C | △△△ | ××× | ★ |

## Consequences
[決定による影響・トレードオフ・リスク]

### Positive
- [決定により得られる利益・価値]
- [解決される問題]
- [向上する品質特性]

### Negative
- [決定により失われるもの]
- [新たに発生するリスク]
- [悪化する可能性のある品質特性]

### Neutral
- [中立的な影響・変化]
- [今後監視すべき項目]

### Risks and Mitigation
| リスク | 発生確率 | 影響度 | 対策 |
|--------|----------|--------|------|
| [リスク1] | 高/中/低 | 高/中/低 | [具体的な対策] |

## Implementation Notes
[実装時の注意点・ガイドライン]

### Action Items
- [ ] [実装に必要なアクション1]
- [ ] [実装に必要なアクション2]

### Timeline
- **決定日**: YYYY-MM-DD
- **実装開始**: YYYY-MM-DD
- **完了予定**: YYYY-MM-DD

## References
[参考資料・関連ドキュメント・外部リンク]

- [参考文献1]
- [関連ADR]
- [技術ドキュメント]

---
**Created**: YYYY-MM-DD
**Last Updated**: YYYY-MM-DD
**Authors**: [作成者名]
**Reviewers**: [レビュー者名]
```

ADRのReviewerは原則として[@tanacchi](https://github.com/tanacchi)とする。

#### 2.2 ADRステータスの管理

##### ステータス種別

- **Proposed**: 提案中・レビュー待ち
- **Accepted**: 承認済み・有効
- **Deprecated**: 非推奨・段階的廃止予定
- **Superseded**: 他のADRにより置き換え済み

##### ステータス遷移ルール

- **Proposed → Accepted**: 指示者承認により確定（作成者による直接変更禁止）
- **Accepted → Deprecated**: 新たな制約・要件により非推奨化
- **Accepted → Superseded**: 新しいADRにより置き換え
- **削除禁止**: 一度作成したADRは削除せず、ステータス変更で管理

**承認権限**: 「Proposed」から「Accepted」への変更は指示者（[@tanacchi](https://github.com/tanacchi)）のみが実行可能

### 3. ADRインデックス管理

#### 3.1 README.md構成

ADRディレクトリのREADME.mdには、全ADRの一覧とステータスを記載する：

```markdown
# Architecture Decision Records (ADR)

このディレクトリには、プロジェクトのアーキテクチャに関する重要な決定事項を記録したADRが含まれています。

## ADR一覧

| 番号 | タイトル | ステータス | 決定日 | 概要 |
|------|----------|------------|--------|------|
| [0001](0001-architecture-style.md) | システムアーキテクチャスタイル選定 | Accepted | 2024-01-15 | モノリス vs マイクロサービス選定 |
| [0002](0002-database-selection.md) | データベース選定 | Accepted | 2024-01-20 | PostgreSQL採用決定 |
| [0003](0003-communication-pattern.md) | 通信パターン選定 | Proposed | 2024-01-25 | REST vs GraphQL選定 |

## ステータス定義

- **Proposed**: 提案中・レビュー待ち
- **Accepted**: 承認済み・有効
- **Deprecated**: 非推奨・段階的廃止予定
- **Superseded**: 他のADRにより置き換え済み

## ADR作成ガイドライン

新しいADRを作成する場合は、[templates/adr-template.md](templates/adr-template.md) を使用してください。

詳細な作成手順については、[docs/instructions/shared/workflow/adr-management.md](docs/instructions/shared/workflow/adr-management.md) を参照してください。
```

#### 3.2 インデックス更新ルール

- **ADR作成時**: README.mdに新エントリを追加
- **ステータス変更時**: 該当エントリのステータスを更新
- **定期メンテナンス**: 月次でADR一覧の整合性確認

### 4. ADRレビュープロセス

#### 4.1 レビュー対象者

- **必須レビュー者**: アーキテクト、テックリード
- **関係者レビュー**: 影響を受ける開発チーム、運用チーム
- **最終承認者**: プロジェクトマネージャー、技術責任者

#### 4.2 レビュー観点

以下の観点でADRをレビューする：

##### 内容品質

- **背景の妥当性**: 決定が必要な理由が明確か
- **選択肢の網羅性**: 代替案が十分検討されているか
- **根拠の論理性**: 選定理由が論理的で説得力があるか
- **影響の分析**: Consequencesが適切に分析されているか

##### フォーマット準拠

- **テンプレート準拠**: 標準フォーマットに従っているか
- **記述の明確性**: 第三者が理解できる記述か
- **参考資料**: 必要な参考情報が含まれているか

#### 4.3 承認プロセス

1. **作成者**: ADRドラフト作成、ステータス「Proposed」
2. **レビュー依頼**: 指示者（[@tanacchi](https://github.com/tanacchi)）にレビュー依頼
3. **内容レビュー**: 指示者による技術妥当性・内容品質確認
4. **最終承認**: 指示者による承認、ステータス「Accepted」への変更

**承認フロー**:

- 新規ADR → Proposed → レビュー依頼 → 指示者レビュー → Accepted
- 作成者は「Proposed」状態でのみ提出、「Accepted」への変更権限なし

### 5. ADR活用とメンテナンス

#### 5.1 ADRの活用場面

- **新規開発時**: 関連ADRを参照して技術選択の一貫性確保
- **設計レビュー時**: ADRを根拠とした設計妥当性確認
- **技術選定時**: 過去の決定経緯を踏まえた検討
- **新メンバーオンボーディング**: プロジェクトの技術的背景理解

#### 5.2 定期的なメンテナンス

- **四半期レビュー**: ADRの有効性・妥当性確認
- **アーキテクチャ進化**: 新たな制約・要件に基づくADR見直し
- **ステータス更新**: Deprecated・Superseded状態の適切な管理

### 6. ツール・自動化

#### 6.1 ADR作成支援

- **テンプレート提供**: 標準テンプレートの配布
- **番号採番自動化**: 可能であればスクリプトによる連番管理
- **フォーマットチェック**: Markdownlintによる形式確認

#### 6.2 ADR検索・参照

- **全文検索**: ADR内容のキーワード検索
- **タグ分類**: 技術領域・影響範囲によるADR分類
- **関連性可視化**: ADR間の依存関係・影響関係の図示

## 完了判定基準

- ADR管理のディレクトリ構造が適切に設計されていること
- 標準ADRテンプレートが作成され、利用可能になっていること
- ADRの番号採番ルールが明確に定義されていること
- ADRステータス管理の方針が確立されていること
- インデックスファイル（README.md）のフォーマットが定義されていること
- レビュープロセスと承認フローが明確になっていること
- ADRの活用場面とメンテナンス方針が明示されていること
- プロジェクト固有の配置場所が適切に選択されていること
- ファイル命名規則が一貫性を持って定義されていること
- 作成対象が実際のテンプレートファイルとして出力されていること
- Markdownのlintルールに従っていない記述が少ないこと

## 完了後

- アウトプットを全てリストアップし、ユーザーからのレビューを受ける
