# API設計

## 目的

- ドメインモデルに基づき、TypeSpecを使用してタイプセーフなRESTful API設計を行い、OpenAPI 3.0形式で出力される包括的なAPI設計書を作成せよ

## 遵守事項

- **TypeSpecを使用したタイプセーフな仕様書作成必須**: 手書きのOpenAPI YAML絶対禁止
- **RESTful設計原則準拠**: 名詞リソース表現、適切なHTTPメソッド使用
- **エラーハンドリング統一**: 統一エラーレスポンス形式で全エンドポイント対応
- **セキュリティ要件明確化**: 認証・認可・入力検証を詳細定義
- **バリデーションルール詳細記述**: 全フィールドのバリデーション仕様明示

## 必須ツール

**TypeSpec使用義務化**: OpenAPI仕様書作成には必ずTypeSpecを使用せよ。手書きのOpenAPI YAML絶対禁止。

**TypeSpec使用理由**: タイプセーフ・自動生成・保守性・コンパイル時検証を確保

## アウトプット出力先

**基本方針**: APIドキュメントは `docs/project/api/` ディレクトリに配置し、プロジェクトドキュメント体系として整理する

**ファイル命名規則**:

- **メインTypeSpec**: `specs/main.tsp`
- **モデル定義**: `specs/models/{リソース名}.tsp`
- **操作定義**: `specs/operations/{機能名}.tsp`
- **生成されたOpenAPI**: `docs/project/api/openapi.yaml`

## API設計の手順

### 1. RESTful設計原則適用

#### 1.1 ハイブリッドAPI設計（名詞+動詞）

**基本方針**: RESTful原則をベースに、複雑なビジネスロジックには動詞APIを併用

##### 名詞API（リソース中心）

- **基本CRUD操作**: 単純な作成・読取・更新・削除
- **リソース階層**: 親子関係の明確な操作
- **統一インターフェース**: HTTP メソッドの標準的利用

```http
# ✅ 名詞API - 基本CRUD操作
GET    /api/quiz/v1/manage/quizzes           # クイズ一覧取得
POST   /api/quiz/v1/manage/quizzes           # クイズ作成
GET    /api/quiz/v1/manage/quizzes/123       # 特定クイズ取得
PUT    /api/quiz/v1/manage/quizzes/123       # クイズ更新
DELETE /api/quiz/v1/manage/quizzes/123       # クイズ削除

# ✅ リソース階層操作
GET    /api/quiz/v1/learning/decks/456/sessions     # Deck内のセッション一覧
POST   /api/user/v1/sessions/789/answers            # セッション内に回答作成
GET    /api/quiz/v1/learning/published              # 公開クイズ一覧
```

##### 動詞API（ビジネスロジック中心）

- **複合操作**: 複数リソースに跨る処理
- **ワークフロー**: 承認・同期・変換などの業務プロセス
- **複雑な状態変更**: 単純更新では表現困難な操作

```http
# ✅ 動詞API - 複雑ビジネスロジック
POST   /api/quiz/v1/manage/quizzes/123/approve      # 承認ワークフロー
POST   /api/quiz/v1/manage/quizzes/123/reject       # 却下処理
POST   /api/quiz/v1/manage/quizzes/123/publish      # 公開処理

POST   /api/quiz/v1/learning/decks/from-search      # 検索結果からDeck生成
POST   /api/quiz/v1/learning/sessions/789/submit    # セッション提出・結果計算
POST   /api/sync/v1/synchronize                     # データ同期・競合解決

POST   /api/user/v1/sessions/456/pause              # セッション一時停止
POST   /api/user/v1/sessions/456/resume             # セッション再開
```

##### 使い分け基準

| 操作の複雑さ | API種別 | 判断基準 | 実装例 |
|-------------|---------|----------|--------|
| **単純** | 名詞API | 単一リソースのCRUD | `GET /quizzes`, `POST /quizzes` |
| **中程度** | 名詞API | 関連リソースの操作 | `POST /sessions/123/answers` |
| **複雑** | 動詞API | 複数ステップの業務処理 | `POST /quizzes/123/approve` |
| **ワークフロー** | 動詞API | 状態遷移・外部連携 | `POST /sync/v1/synchronize` |

##### 避けるべきパターン

```http
# ❌ 悪い例 - 混在パターン
POST   /api/v1/createQuiz               # 動詞のみ（古いパターン）
GET    /api/v1/getQuizById/123          # 動詞のみ
POST   /api/v1/submitAnswer             # リソース階層不明確

# ❌ 動詞の乱用
POST   /api/v1/quiz/update              # PUTで十分
POST   /api/v1/quiz/delete              # DELETEで十分
GET    /api/v1/quiz/get                 # GETで十分
```

#### 1.2 HTTPメソッド利用方針

| Method | 用途 | 冪等性 | 安全性 | レスポンス |
|--------|------|--------|--------|------------|
| **GET** | リソース取得 | ✓ | ✓ | 200, 404 |
| **POST** | リソース作成・複合操作 | ✗ | ✗ | 201, 400, 409 |
| **PUT** | リソース更新・置換 | ✓ | ✗ | 200, 201, 404 |
| **PATCH** | リソース部分更新 | ✗ | ✗ | 200, 404 |
| **DELETE** | リソース削除 | ✓ | ✗ | 204, 404 |

#### 1.3 URL設計規約

##### バージョニング戦略

```bash
# Domain-based Versioning（採用）
/api/{domain}/v1/{context}/{resource}

# 具体例
/api/quiz/v1/manage/quizzes        # Quiz Domain - Manage Context
/api/quiz/v1/learning/decks        # Quiz Domain - Learning Context
/api/user/v1/sessions              # User Domain
/api/sync/v1/cache-manifest        # Sync Domain

# 従来方式（非推奨）
/api/v1/quiz-management/quizzes    # 旧形式

# Header Versioning（将来検討）
Accept: application/vnd.yourquiz.v1+json
```

#### 1.4 ステータスコード標準化

- **2xx成功**: 200 OK, 201 Created, 204 No Content
- **4xxクライアントエラー**: 400, 401, 403, 404, 409, 422
- **5xxサーバーエラー**: 500, 502, 503

### 2. TypeSpec仕様書作成

**基本構成**: `specs/main.tsp`にサービス定義、`specs/models/`にモデル、`specs/operations/`に操作を作成せよ

**OpenAPI生成**: `tsp compile specs/main.tsp --emit @typespec/openapi3`実行せよ

### 3. データスキーマ設計

**型システム定義必須項目**:

- プリミティブ型: string, number, integer, boolean
- 複合型: object, array
- フォーマット: date, date-time, email, uri, uuid
- 制約: required, minimum, maximum, minLength, maxLength, pattern

### 4. エラーハンドリング設計

**統一エラーレスポンス形式必須**: error.code, error.message, error.detailsの構造で統一せよ

**エラーコード体系定義必須**:

- **バリデーションエラー（4xx）**: VALIDATION_ERROR, FORMAT_INVALID, REQUIRED_FIELD_MISSING
- **認証・認可エラー（4xx）**: UNAUTHORIZED, TOKEN_EXPIRED, FORBIDDEN
- **リソースエラー（4xx）**: RESOURCE_NOT_FOUND, RESOURCE_CONFLICT
- **サーバーエラー（5xx）**: INTERNAL_SERVER_ERROR, SERVICE_UNAVAILABLE

### 5. セキュリティ仕様

**認証・認可定義必須**:

- JWT Bearer認証またはOAuth2を選択し詳細仕様定義せよ
- 各エンドポイントのセキュリティ要件を明示せよ

**入力検証対策必須**:

- SQLインジェクション対策: パラメータ化クエリ必須
- XSS対策: 出力時エスケープ必須
- CSRF対策: SameSite Cookie + CSRFトークン
- レート制限: API呼び出し頻度制限

### 6. パフォーマンス設計

**ページネーション必須**: page, limit パラメータとX-Total-Count, X-Page-Countヘッダー定義せよ

**フィルタリング・ソート定義**: filter（JSON形式）、sort（enum）パラメータ仕様定義せよ

### 7. 後方互換性ガイドライン

**破壊的変更判定基準**:

- 破壊的変更: メジャーバージョンアップ
- 非破壊的変更: マイナーバージョンアップ

### 8. ドキュメント生成

**自動生成ツール連携必須**: Swagger UI、Redoc、Postman Collection生成設定せよ

**CI/CDパイプライン統合**: API仕様変更時の自動ドキュメント生成・デプロイ設定せよ

## 完了判定基準

### 必須要件

- **TypeSpec仕様書作成完了**: 手書きOpenAPI YAML使用なし
- **OpenAPI 3.0仕様書生成**: 全エンドポイントのリクエスト/レスポンス構造定義完了
- **エラーハンドリング統一**: HTTPステータスコードと統一エラー形式明示完了
- **バリデーションルール詳細記述**: 全フィールドのバリデーション仕様明示完了
- **セキュリティ仕様定義**: 認証・認可・入力検証定義完了
- **パフォーマンス考慮**: ページネーション、フィルタリング、ソート実装完了
- **バージョニング戦略明確化**: 後方互換性ガイドライン定義完了
- **自動生成設定**: Swagger UI、CI/CDパイプライン統合完了
- **ファイル命名規則準拠**: 適切なファイル分割と出力完了

## 設計品質特性

この設計原則・命名規約により、以下の品質特性を持つAPI実装が実現される：

### 品質特性

1. **一貫性**: 統一的な設計原則による実装の一貫性
2. **可読性**: 明確な命名規約による理解しやすさ
3. **保守性**: 標準的なパターンによる保守容易性
4. **拡張性**: モジュラー設計による機能拡張の容易さ
5. **信頼性**: エラーハンドリング・バリデーションの充実
6. **パフォーマンス**: キャッシュ・最適化戦略の統一

### 開発効率の向上

- **自動生成**: OpenAPI仕様書・型定義の自動生成
- **テスト容易性**: 標準化されたテストパターン
- **ドキュメント**: 自動更新される包括的なドキュメント
- **品質保証**: 一貫したバリデーション・エラー処理

## 完了後の必須アクション

1. **直ちに**ユーザーに「API設計成果物」のレビューを依頼する
2. **ADR作成判断**: API設計選択について、ADRでの記録をユーザーに提案する
3. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「本実装」に進む
   - 戻りフロー：API設計見直しで前工程に戻る
4. ユーザーの明示的な承認を得てから指定された工程に進む
