# 本実装

## 目的

- 単体テスト実装（TDD）で検証された設計に基づき、ビジネス要求を満たす高品質で保守性の高いプロダクションコードを実装し、BDDテストとE2Eテストで総合的に検証される完全なアプリケーションを構築せよ

## 遵守事項

- **Test-Drivenで実装済みのテストを必ず通すこと**
- **TypeScript厳格ルールの完全遵守**: any型、as型アサーション、Non-null assertion（!）を絶対に使用しない
- **Clean Architectureの階層分離を厳密に守る**: 依存関係の方向を必ず内側（ドメイン）向きに統一
- **DRY原則とSOLID原則を適用**: 重複コードの排除と単一責任の徹底
- **エラーハンドリングとロギングを必須実装**: 適切な例外処理と運用監視に必要なログ出力
- **既存のTDDテストケースを全て通すこと**を実装完了の必要条件とする
- **パフォーマンスとセキュリティを考慮**した実装を行う

## アウトプット出力先

### ファイル命名規則

- **エンティティ**: `{名前}.entity.ts`
- **値オブジェクト**: `{名前}.value-object.ts`
- **ユースケース**: `{動詞}{対象}.use-case.ts`
- **リポジトリ**: `{名前}.repository.ts`、`{名前}.repository.interface.ts`
- **コントローラー**: `{名前}.controller.ts`

## 本実装の手順

### 1. 実装前準備

#### 1.1 テスト環境確認

**既存TDDテストの実行状況を確認せよ**:
- 全単体テストがGreenで通過している
- テストカバレッジが95%以上達成している
- BDDテストが定義され実行可能状態にある

#### 1.2 技術スタック確認

**選定済み技術スタックの設定を確認せよ**:
- フレームワーク・ライブラリのバージョン
- TypeScript設定（strict: true、noImplicitAny: true等）
- Linter・Formatter設定（ESLint、Prettier）
- DI コンテナ設定（InversifyJS、Awilix等）

### 2. ドメイン層実装

#### 2.1 エンティティ実装

**ビジネス不変条件を実装せよ**:

**必須実装項目**:
- 不変条件の検証（コンストラクタ・ファクトリーメソッド）
- ビジネスルールの実装（状態変更メソッド）
- ドメインイベントの発行
- 等価性・ハッシュコード実装

#### 2.2 値オブジェクト実装

**不変性とバリデーションを実装せよ**:
- 値の不変性保証
- ファクトリーメソッドでのバリデーション
- 等価性比較メソッド
- 型安全性の確保

#### 2.3 ドメインサービス実装

**エンティティ間の複雑なビジネスロジックを実装せよ**:
- ユニークネス検証（メールアドレス重複チェック）
- 複数エンティティにまたがるビジネスルール
- ドメイン計算ロジック

#### 2.4 リポジトリインターフェース定義

**永続化の抽象化を定義せよ**:
- CRUD操作の抽象化
- ドメイン固有の検索メソッド
- Result型を使用した戻り値設計
- エラーハンドリングの抽象化

### 3. アプリケーション層実装

#### 3.1 ユースケース実装

**ビジネスユースケースを実装せよ**:

**必須実装項目**:
- 入力バリデーション
- トランザクション境界の管理
- ドメインイベントの発行
- エラーハンドリング
- DTO変換

#### 3.2 DTO・マッパー実装

**レイヤー間のデータ変換を実装せよ**:
- ドメインオブジェクト ↔ DTO変換
- 外部サービス ↔ ドメインオブジェクト変換
- バリデーション付きDTO実装

### 4. インフラストラクチャ層実装

#### 4.1 リポジトリ実装

**データ永続化の具体実装を行え**:

**必須実装項目**:
- データベーススキーマとの適合性
- トランザクション管理
- 例外のドメインエラーへの変換
- パフォーマンス最適化（N+1問題対策等）

#### 4.2 Webコントローラー実装

**HTTP/REST APIを実装せよ**:

**必須実装項目**:
- OpenAPI仕様との整合性
- HTTPステータスコードの適切な使用
- セキュリティヘッダーの設定
- レート制限・CORS設定

#### 4.3 外部サービス統合

**外部APIとの統合を実装せよ**:
- 認証・認可サービス
- メール送信サービス
- ファイルストレージ
- 通知サービス

### 5. 共通基盤実装

#### 5.1 エラーハンドリング

**統一的なエラー処理を実装せよ**:

**必須実装項目**:
- カスタム例外クラス定義
- エラーコード・メッセージ管理
- スタックトレース保持
- ログ出力との連携

#### 5.2 ロギング

**運用監視に必要なログを実装せよ**:
- 構造化ログ（JSON形式）
- ログレベル（DEBUG、INFO、WARN、ERROR）
- コンテキスト情報（ユーザーID、リクエストID）
- パフォーマンスメトリクス

#### 5.3 設定管理・DI

**環境別設定とDIコンテナを実装せよ**:
- 環境変数による設定管理
- 開発・本番環境の切り替え
- DIコンテナによる依存関係解決
- シークレット管理

### 6. パフォーマンス・セキュリティ

#### 6.1 パフォーマンス最適化

**応答性能を確保せよ**:
- データベースクエリ最適化
- キャッシュ戦略実装
- 非同期処理・バッチ処理
- メモリ使用量最適化

#### 6.2 セキュリティ実装

**セキュリティ要件を満たせ**:
- 入力検証・サニタイゼーション
- SQLインジェクション対策
- XSS・CSRF対策
- 認証・認可の実装

### 7. テスト統合・検証

#### 7.1 TDDテスト実行

**既存テストとの整合性確認を行え**:
- 全単体テストの実行・合格確認
- カバレッジレポート生成
- テスト失敗時の原因分析・修正

#### 7.2 BDDテスト実行

**ビジネス仕様の実装確認を行え**:
- Given-When-Thenシナリオの実行
- ビジネスルールの動作確認
- エラーケースの適切な処理

#### 7.3 統合テスト

**コンポーネント間連携の確認を行え**:
- API統合テスト
- データベース統合テスト
- 外部サービス連携テスト

## 完了判定基準

### 機能実装の完了

- **全TDDテストがGreen**: 既存の単体テストが100%成功している
- **BDDテストがGreen**: ビジネスシナリオが全て成功している
- **API仕様準拠**: OpenAPIドキュメントとの完全な整合性
- **Clean Architecture遵守**: 依存関係の方向性が正しく実装されている

### 品質要件の達成

- **TypeScript厳格モード**: any型、型アサーション、non-null assertionを使用していない
- **テストカバレッジ95%以上**: コード網羅性が達成されている
- **Linter・Formatter通過**: コード品質基準を満たしている
- **セキュリティ要件**: 入力検証、認証・認可が適切に実装されている

### 非機能要件の確認

- **パフォーマンス要件**: レスポンス時間・スループット基準の達成
- **エラーハンドリング**: 適切な例外処理とログ出力の実装
- **運用監視**: 本番運用に必要なログ・メトリクス出力の実装
- **設定管理**: 環境別設定とシークレット管理の実装

### 統合性・保守性の確保

- **依存関係管理**: DIコンテナによる適切な依存関係解決
- **コード構造**: Clean Architectureの層構造が明確に実装されている
- **ドキュメント更新**: APIドキュメント、設計書の更新完了
- **デプロイ準備**: 本番環境での動作確認とデプロイメント設定

## 完了後の必須アクション

1. **直ちに**ユーザーに「本実装コード」のレビューを依頼する
2. **ADR作成判断**: アーキテクチャパターン実装、パフォーマンス最適化等の重要決定について、ADRでの記録をユーザーに提案する
3. **次工程の判断**をユーザーに委ねる：
   - 通常フロー：「E2Eテスト」に進む
   - 戻りフロー：実装課題発見によるBDDテスト見直し
4. ユーザーの明示的な承認を得てから指定された工程に進む