# 開発ワークフロー

## サマリ

```mermaid
flowchart TD
  A[仕様整理] --> B[全体技術設計]
  B --> C[DDD設計]
  C --> API[API・UI設計]
  API --> X[DB設計]
  X --> D[技術選定]
  D --> E[BDDテスト実装]
  E --> F[スケルトン実装]
  API --> E
  E --> DESIGN[UI設計]
  DESIGN -->UI[UI開発]
  F --> G[単体テスト実装（TDD）]
  G --> H[本実装]
  H --> I[E2Eテスト]
  A --> Z[ドキュメント整備]
  Z --> A

  %% 反復フロー（要件変更・課題発見時）
  B --> E
  C --> E
  API --> E
  X --> E
  D --> E
  F --> E
  G --> E
  H --> E
  I --> A
  I --> B
  I --> C
  I --> API
  I --> X
  I --> D

  %% ユーザー承認が必要な判断ポイント
  A --> |ユーザー判断| B
  A --> |ユーザー判断| E
  B --> |ユーザー判断| C
  B --> |ユーザー判断| E
  C --> |ユーザー判断| API
  C --> |ユーザー判断| E
  API --> |ユーザー判断| X
  API --> |ユーザー判断| E
```

## 重要な実行原則

- **段階的承認必須**：各工程完了後、必ずユーザーレビューを経てから次工程に進むこと
- **インクリメンタルな開発**：仕様から一度に作成するのではなく小さな機能単位に分解して、機能単位で積み上げるように開発すること
- **遷移判断の承認必須**：線形フローから外れる場合（BDDへの遷移、前工程への戻り等）は、必ずユーザーの明示的な承認を得ること
- **工程完了後の質問対応**：「終わったら何をしますか？」等の質問には、**直近の必須アクション**（レビュー依頼）を最優先で回答すること
- **反復開発対応**：要件変更や課題発見時は、適切な工程に戻ることを恐れずに提案すること
- **省略禁止**：承認されたワークフローを一切省略せず実行すること
- **ADR作成判断**：重要な技術的・設計的決定を行った場合、ユーザーの判断でADR（アーキテクチャ決定記録）作成を推奨する

## 各工程からBDDへの遷移条件

以下の条件に該当する場合、**ユーザーの承認を得た上で**BDDテスト実装工程に遷移することを推奨する：

### 遷移条件

- **要件不明確時**: ユーザーストーリーやビジネスルールが曖昧で、実例による検証が必要
- **ステークホルダー間の理解齟齬**: 仕様の解釈に違いがあり、共通理解の構築が必要
- **複雑なビジネスルール**: ドメインロジックが複雑で、仕様の検証が困難
- **技術制約の影響**: 選定技術の制約により要件調整が必要
- **API設計の複雑さ**: REST設計やエラーハンドリングの詳細検証が必要
- **データ整合性の複雑さ**: トランザクション境界や制約の検証が必要
- **外部システム連携**: 外部APIやサービス連携の動作確認が必要

### 遷移時の必須アクション

1. **現工程の中断理由を明確化**し、ユーザーに報告
2. **BDD遷移の必要性と期待効果**をユーザーに説明
3. **ユーザーの明示的な承認**を得てからBDD工程に移行
4. **BDD完了後の戻り先工程**をユーザーと合意

## ADR（アーキテクチャ決定記録）作成指針

### ADR作成対象となる決定

以下のような重要な技術的・設計的決定を行った場合、ADR作成を推奨する：

- **アーキテクチャパターン選定**: システム全体に影響するアーキテクチャ決定
- **技術スタック選定**: フレームワーク、ライブラリ、データベース等の選定
- **設計方針決定**: API設計方針、データモデル設計方針等
- **非機能要件対応**: パフォーマンス、セキュリティ、可用性対応方針
- **制約による決定**: 外部要因や既存システム制約による技術選択

### ADR作成タイミング

各工程において、以下のタイミングでADR作成をユーザーに提案する：

1. **重要な決定を行った直後**: 技術選定や設計方針決定の完了時
2. **トレードオフを伴う選択**: 複数の選択肢から一つを選んだ場合
3. **将来への影響が大きい決定**: 後続工程や長期運用に影響する決定
4. **ユーザーが明示的に要求**: ADR作成の必要性をユーザーが判断

### ADR作成プロセス

ADR作成が決定された場合、以下の手順で実施する：

1. **adr-management.md参照**: ADR作成の詳細手順を確認
2. **ADR下書き作成**: 標準テンプレートを使用して内容記述
3. **ユーザーレビュー**: 作成したADRをユーザーに確認依頼
4. **承認・配置**: ユーザー承認後、適切な場所に配置

## フロー詳細

### 1. 仕様整理

- **必須要件**：新機能を開始したら直ちにユーザーストーリーと成功／失敗パターンを整理せよ
- **参照必須の文書**：./specification.md
- **完了判定基準**：
  - ユーザーストーリーが4W1Hで記述されている
  - 成功／失敗パターンがRESTステータスと振る舞いで明示されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「仕様整理結果」のレビューを依頼する
  2. **ADR作成判断**：重要な要件決定や制約がある場合、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「全体技術設計」に進む
     - BDD遷移：要件不明確等の理由でBDDテスト実装に遷移
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 2. 全体技術設計

- **前提条件**：仕様整理のユーザー承認完了
- **必須要件**：同期API vs Pub/Sub、モノリス vs マイクロサービス、DB種別選定などを明確に定義せよ
- **参照必須の文書**：./architecture.md
- **完了判定基準**：
  - 選定したアーキテクチャパターンが図示されている
  - 技術的トレードオフと理由が箇条書きで示されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「アーキテクチャ設計案」のレビューを依頼する
  2. **ADR作成判断**：アーキテクチャパターン選定等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「DDD設計」に進む
     - BDD遷移：技術制約等の理由でBDDテスト実装に遷移
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 3. ドメイン設計（DDD）

- **前提条件**：全体技術設計のユーザー承認完了
- **必須要件**：BC、エンティティ／VO／ドメインサービス、ユースケースI/Fを設計せよ
- **参照必須の文書**：./ddd-design.md
- **完了判定基準**：
  - エンティティ・VOが型定義付きで示されている
  - ドメインサービスおよびリポジトリI/Fがインターフェースで定義されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「DDDモデル図とI/F設計」のレビューを依頼する
  2. **ADR作成判断**：ドメインモデル設計やコンテキスト分離等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「API設計」に進む
     - BDD遷移：複雑なビジネスルール等の理由でBDDテスト実装に遷移
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 4. API設計

- **前提条件**：DDD設計のユーザー承認完了
- **必須要件**：ドメインモデルに基づく詳細なAPI仕様を作成し、OpenAPI形式で文書化せよ
- **参照必須の文書**：./api-design.md
- **完了判定基準**：
  - OpenAPI 3.0仕様書が作成されている
  - 全エンドポイントのリクエスト/レスポンス構造が定義されている
  - エラーハンドリングとHTTPステータスコードが明示されている
  - バリデーションルールが詳細に記述されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「API設計仕様書」のレビューを依頼する
  2. **ADR作成判断**：API設計方針やエラーハンドリング戦略等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「DB設計」に進む
     - BDD遷移：API設計の複雑さ等の理由でBDDテスト実装に遷移
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 5. DB設計

- **前提条件**：API設計のユーザー承認完了
- **必須要件**：エンティティ／VOに基づくテーブルスキーマを設計せよ
- **参照必須の文書**：./db-design.md
- **完了判定基準**：
  - ER図が作成されている
  - マイグレーションファイルの雛形が生成されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「DB設計結果」のレビューを依頼する
  2. **ADR作成判断**：データモデル設計やスキーマ設計等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「技術選定」に進む
     - BDD遷移：データ整合性の複雑さ等の理由でBDDテスト実装に遷移
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 6. 技術選定

- **前提条件**：DB設計のユーザー承認完了
- **必須要件**：neverthrowやORM、バリデーションライブラリなどを選定せよ
- **参照必須の文書**：./tech-selection.md
- **完了判定基準**：
  - 選定ライブラリとバージョン、理由が表形式で示されている
  - プロジェクト要件を満たすことが明確になっている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「技術選定リスト」のレビューを依頼する
  2. **ADR作成判断**：フレームワーク、ライブラリ、データベース等の技術スタック選定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「BDDテスト実装」に進む
     - 戻りフロー：技術制約による要件調整で前工程に戻る
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 7. BDDテスト実装

- **前提条件**：技術選定のユーザー承認完了
- **必須要件**：E2Eおよびドメイン結合シナリオをGherkin形式で記述し、選定したBDDフレームワークで実装せよ
- **参照必須の文書**：./bdd-implementation.md
- **完了判定基準**：
  - 全シナリオがGherkin形式（Given-When-Then）で記述されている
  - Step Definitionsが実装され、テストがコンパイル・実行可能になっている
  - BDDテスト実行時に全シナリオがRedで失敗している
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「BDDテストコード」のレビューを依頼する
  2. **ADR作成判断**：BDDフレームワーク選定やテスト戦略等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「スケルトン実装」に進む
     - 戻りフロー：BDD結果に基づく要件見直しで前工程に戻る
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 8. スケルトン実装

- **前提条件**：BDDテスト実装のユーザー承認完了
- **必須要件**：APIルートやメッセージハンドラの骨組みを実装し、BDDテストが依然としてRedであることを確認せよ
- **参照必須の文書**：./skeleton.md
- **完了判定基準**：
  - スケルトンコードがコンパイルし、BDDテストがすべてRedであること
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「スケルトン実装コード」のレビューを依頼する
  2. **ADR作成判断**：アーキテクチャパターン実装やコンポーネント構造等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「単体テスト実装」に進む
     - BDD遷移：実装課題発見によるBDDテスト再実装
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 9. 単体テスト実装 (TDD)

- **前提条件**：スケルトン実装のユーザー承認完了
- **必須要件**：TDDで単体テストを実装しGreen化せよ
- **参照必須の文書**：./unit-testing.md
- **完了判定基準**：
  - 全てのユニットテストがGreenで通過している
  - カバレッジが95%以上達成している
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「単体テスト結果」のレビューを依頼する
  2. **ADR作成判断**：テストフレームワーク選定やモック戦略等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「本実装」に進む
     - BDD遷移：テスト課題発見によるBDDテスト見直し
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 10. 本実装

- **前提条件**：単体テスト実装のユーザー承認完了
- **必須要件**：アプリケーションおよびAPIルートへ組み込み、本実装を完了せよ
- **参照必須の文書**：./implementation.md
- **完了判定基準**：
  - 全てのBDDテストがGreenで通過している
  - OpenAPIドキュメントが更新されている
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「本実装結果」のレビューを依頼する
  2. **ADR作成判断**：アーキテクチャパターン実装やパフォーマンス最適化等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 通常フロー：「E2Eテスト」に進む
     - BDD遷移：実装課題発見によるBDDテスト見直し
  4. ユーザーの明示的な承認を得てから指定された工程に進む

### 11. E2Eテスト要件策定 & 実行

- **前提条件**：本実装のユーザー承認完了
- **必須要件**：フロントからバックエンドまでのユーザーフローをカバーするE2Eシナリオを記述・実行せよ
- **参照必須の文書**：./e2e-testing.md
- **完了判定基準**：
  - 全てのE2EテストがGreenで成功している
- **完了後の必須アクション**：
  1. **直ちに**ユーザーに「E2Eテスト結果」のレビューを依頼する
  2. **ADR作成判断**：E2Eテストフレームワーク選定やテスト戦略等の重要決定について、ADRでの記録をユーザーに提案する
  3. **次工程の判断**をユーザーに委ねる：
     - 完了：開発完了
     - 戻りフロー：E2E結果に基づく要件見直しで前工程に戻る
  4. ユーザーの明示的な承認を得て作業を終了または継続する

上記ワークフローを一切省略せず実行すること。

----

## 新規タスク追加、工程のドキュメント時の対応

各工程のドキュメントが存在しなかったあるいは新規にワークフローの工程を増やす場合は ./docs.md の内容に従ってドキュメントを追加すること。
追加後はユーザのレビューを経て、本ドキュメントに工程を追加すること。
