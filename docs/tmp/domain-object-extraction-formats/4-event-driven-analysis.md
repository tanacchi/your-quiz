# æ¡ˆ4: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•åˆ†æå‹

## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¦‚è¦

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ“ã‚¸ãƒã‚¹ã§é‡è¦ãªå‡ºæ¥äº‹ï¼‰ã‚’èµ·ç‚¹ã¨ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼•ãèµ·ã“ã™ãƒ»å‡¦ç†ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®šã€‚ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿè²¬ä»»ãƒ»å‡¦ç†è²¬ä»»ãƒ»é€£é–åå¿œã‚’åˆ†æã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°è¦³ç‚¹ã§ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­è¨ˆã‚’è¡Œã†ã€‚

## æ§‹æˆ

```markdown
# ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŠ½å‡ºãƒ»åˆ†æï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰

## ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆæ´—ã„å‡ºã—
### specificationsåˆ†æã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆæŠ½å‡º
### ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ†é¡ï¼ˆãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ»UIã‚¤ãƒ™ãƒ³ãƒˆï¼‰

## ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿè²¬ä»»åˆ†æ
### ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæºã®ç‰¹å®š
### ç™ºç”Ÿæ¡ä»¶ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ†æ

## ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†è²¬ä»»åˆ†æ
### ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†è€…ã®ç‰¹å®š
### å‡¦ç†å†…å®¹ãƒ»å‰¯ä½œç”¨ã®åˆ†æ

## ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³åˆ†æ
### ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®å› æœé–¢ä¿‚
### é€£é–åå¿œãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š

## ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŠ½å‡º
### ã‚¤ãƒ™ãƒ³ãƒˆä¸­å¿ƒã‹ã‚‰è¦‹ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
### ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»ã‚¨ãƒŸãƒƒã‚¿ãƒ¼è¨­è¨ˆ
```

## ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

```markdown
# ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŠ½å‡ºãƒ»åˆ†æï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰

## ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆæ´—ã„å‡ºã—

### specificationsåˆ†æã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆæŠ½å‡º
**åˆ†æå¯¾è±¡**: user-stories, requirements, success-scenarios

| ã‚¤ãƒ™ãƒ³ãƒˆå | ç™ºè¦‹ç®‡æ‰€ | ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ | ãƒ“ã‚¸ãƒã‚¹å½±éŸ¿ | åˆ†é¡ |
|------------|----------|-------------|-------------|------|
| **QuizSubmitted** | success#L35 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ã‚¤ã‚ºã‚’æŠ•ç¨¿ã—ãŸ | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¢—åŠ  | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **QuizApproved** | requirements#L20 | ç®¡ç†è€…ãŒã‚¯ã‚¤ã‚ºã‚’æ‰¿èªã—ãŸ | å…¬é–‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¢—åŠ  | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **QuizRejected** | requirements#L21 | ç®¡ç†è€…ãŒã‚¯ã‚¤ã‚ºã‚’æ‹’å¦ã—ãŸ | å“è³ªç®¡ç† | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **AnswerSubmitted** | success#L15 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ã‚¤ã‚ºã«å›ç­”ã—ãŸ | å­¦ç¿’é€²æ—æ›´æ–° | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **CorrectAnswerGiven** | success#L16 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£è§£ã—ãŸ | å­¦ç¿’æˆæœå‘ä¸Š | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **IncorrectAnswerGiven** | success#L16 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸æ­£è§£ã—ãŸ | å­¦ç¿’æ©Ÿä¼šæä¾› | ğŸ”´ ãƒ“ã‚¸ãƒã‚¹ |
| **SwipeGestureDetected** | success#L15 | ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œãŒæ¤œå‡ºã•ã‚ŒãŸ | UIåå¿œé–‹å§‹ | ğŸŸ¡ ã‚·ã‚¹ãƒ†ãƒ  |
| **JudgmentDisplayed** | success#L16 | æ­£èª¤åˆ¤å®šãŒè¡¨ç¤ºã•ã‚ŒãŸ | UIçŠ¶æ…‹å¤‰æ›´ | ğŸŸ¡ ã‚·ã‚¹ãƒ†ãƒ  |
| **SessionStarted** | success#L7 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†é–‹å§‹ | ğŸŸ¡ ã‚·ã‚¹ãƒ†ãƒ  |
| **OfflineModeActivated** | success#L76 | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œ | å¯ç”¨æ€§ç¢ºä¿ | ğŸŸ¡ ã‚·ã‚¹ãƒ†ãƒ  |
| **DataSynchronized** | success#L84 | ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº† | æ•´åˆæ€§ç¢ºä¿ | ğŸŸ¡ ã‚·ã‚¹ãƒ†ãƒ  |
| **TagSelected** | success#L13 | ã‚¿ã‚°ãŒé¸æŠã•ã‚ŒãŸ | ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ | ğŸŸ¢ UI |
| **BannerFadedOut** | success#L17 | ãƒãƒŠãƒ¼ãŒãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ | UIé·ç§»å®Œäº† | ğŸŸ¢ UI |

### ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ†é¡

#### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ ¸å¿ƒï¼‰
- **QuizSubmitted**: ã‚¯ã‚¤ã‚ºæŠ•ç¨¿ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¾›çµ¦ï¼‰
- **QuizApproved**: ã‚¯ã‚¤ã‚ºæ‰¿èªï¼ˆå“è³ªä¿è¨¼ï¼‰
- **AnswerSubmitted**: å›ç­”æå‡ºï¼ˆå­¦ç¿’è¡Œå‹•ï¼‰
- **CorrectAnswerGiven**: æ­£è§£ç²å¾—ï¼ˆå­¦ç¿’æˆæœï¼‰

#### ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæŠ€è¡“å®Ÿè£…ï¼‰
- **SessionStarted**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **OfflineModeActivated**: å¯ç”¨æ€§åˆ¶å¾¡
- **DataSynchronized**: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

#### UIã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼‰
- **SwipeGestureDetected**: æ“ä½œæ¤œå‡º
- **JudgmentDisplayed**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
- **BannerFadedOut**: UIçŠ¶æ…‹é·ç§»

## ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿè²¬ä»»åˆ†æ

### ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæºã®ç‰¹å®š

#### QuizSubmittedï¼ˆã‚¯ã‚¤ã‚ºæŠ•ç¨¿ï¼‰
**ç™ºç”Ÿæº**: Creatorï¼ˆä½œæˆè€…ï¼‰
**ç™ºç”Ÿæ¡ä»¶**:
- å¿…é ˆé …ç›®å…¥åŠ›å®Œäº†ï¼ˆQuestion, CorrectAnswerï¼‰
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéï¼ˆæ–‡å­—æ•°åˆ¶é™ã€ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
- æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `Quiz.submit()` ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œæ™‚
**ç™ºç”Ÿå ´æ‰€**: `CreatorService.submitQuiz()`

**ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿**:
```typescript
interface QuizSubmittedEvent {
  eventId: string;
  occurredAt: Date;
  quizId: QuizId;
  creatorId: CreatorId;
  quiz: {
    question: string;
    correctAnswer: boolean;
    explanation?: string;
    tags: string[];
  };
}
```

#### AnswerSubmittedï¼ˆå›ç­”æå‡ºï¼‰
**ç™ºç”Ÿæº**: Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰via SwipeGesture
**ç™ºç”Ÿæ¡ä»¶**:
- æ‰¿èªæ¸ˆã¿ã‚¯ã‚¤ã‚ºã®å­˜åœ¨
- æœ‰åŠ¹ãªã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œæ¤œå‡º
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æ€§ç¢ºèª

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `SwipeGesture.complete()` æ™‚
**ç™ºç”Ÿå ´æ‰€**: `AnswerService.processSwipe()`

**ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿**:
```typescript
interface AnswerSubmittedEvent {
  eventId: string;
  occurredAt: Date;
  answerId: AnswerId;
  quizId: QuizId;
  sessionId: SessionId;
  userAnswer: boolean;
  isCorrect: boolean;
  responseTime: number;
}
```

#### QuizApprovedï¼ˆã‚¯ã‚¤ã‚ºæ‰¿èªï¼‰
**ç™ºç”Ÿæº**: Administratorï¼ˆç®¡ç†è€…ï¼‰
**ç™ºç”Ÿæ¡ä»¶**:
- ç®¡ç†è€…æ¨©é™ã®ç¢ºèª
- æ‰¿èªå¾…ã¡çŠ¶æ…‹ã®ã‚¯ã‚¤ã‚ºå­˜åœ¨
- æ‰¿èªåŸºæº–ã®é€šé

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `Administrator.approve()` å®Ÿè¡Œæ™‚
**ç™ºç”Ÿå ´æ‰€**: `ApprovalService.approveQuiz()`

**ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿**:
```typescript
interface QuizApprovedEvent {
  eventId: string;
  occurredAt: Date;
  quizId: QuizId;
  administratorId: AdministratorId;
  approvalReason?: string;
  previousStatus: QuizStatus;
}
```

#### DataSynchronizedï¼ˆãƒ‡ãƒ¼ã‚¿åŒæœŸï¼‰
**ç™ºç”Ÿæº**: SyncServiceï¼ˆåŒæœŸã‚µãƒ¼ãƒ“ã‚¹ï¼‰
**ç™ºç”Ÿæ¡ä»¶**:
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¸ã®çŠ¶æ…‹å¤‰åŒ–
- åŒæœŸå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç¢ºèª

**ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `SyncService.sync()` å®Œäº†æ™‚
**ç™ºç”Ÿå ´æ‰€**: `OfflineSyncService.performSync()`

### ç™ºç”Ÿæ¡ä»¶ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ†æ

#### ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿã®å‰ææ¡ä»¶ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
| ã‚¤ãƒ™ãƒ³ãƒˆ | å¿…è¦ãªãƒ‰ãƒ¡ã‚¤ãƒ³çŠ¶æ…‹ | å¤–éƒ¨æ¡ä»¶ | æ¨©é™è¦ä»¶ |
|----------|------------------|-----------|----------|
| QuizSubmitted | Creatorè­˜åˆ¥æ¸ˆã¿ | å…¥åŠ›å€¤æœ‰åŠ¹ | ãªã—ï¼ˆåŒ¿åå¯ï¼‰ |
| QuizApproved | Quiz=PendingApproval | ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ | Administratoræ¨©é™ |
| AnswerSubmitted | Quiz=Approved | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ | ãªã—ï¼ˆåŒ¿åå¯ï¼‰ |
| DataSynchronized | OfflineDataå­˜åœ¨ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š | ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ |

## ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†è²¬ä»»åˆ†æ

### ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†è€…ã®ç‰¹å®š

#### QuizSubmittedEventHandler
**å‡¦ç†è²¬ä»»è€…**: `QuizManagementService`
**å‡¦ç†å†…å®¹**:
1. Quiz ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ°¸ç¶šåŒ–
2. QuizStatus ã‚’ 'PendingApproval' ã«è¨­å®š
3. ApprovalQueue ã¸ã®è¿½åŠ 
4. Creator ã¸ã®æŠ•ç¨¿å®Œäº†é€šçŸ¥

**å‰¯ä½œç”¨**:
- PendingApprovalQueueUpdated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
- CreatorNotified ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ

```typescript
class QuizSubmittedEventHandler {
  async handle(event: QuizSubmittedEvent): Promise<void> {
    // Quizæ°¸ç¶šåŒ–
    const quiz = await this.quizRepository.save(event.quiz);
    
    // æ‰¿èªã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    await this.approvalQueue.enqueue(quiz.id);
    
    // å¾Œç¶šã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    await this.eventBus.publish(new PendingApprovalQueueUpdatedEvent(quiz.id));
    await this.eventBus.publish(new CreatorNotifiedEvent(event.creatorId, 'SUBMITTED'));
  }
}
```

#### AnswerSubmittedEventHandler
**å‡¦ç†è²¬ä»»è€…**: `LearningService`
**å‡¦ç†å†…å®¹**:
1. Answer ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç”Ÿæˆãƒ»ä¿å­˜
2. AnswerHistory ã¸ã®è¿½åŠ 
3. Statistics ã®æ›´æ–°
4. UI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¡¨ç¤ºåˆ¶å¾¡

**å‰¯ä½œç”¨**:
- AnswerRecorded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
- StatisticsUpdated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
- JudgmentDisplayRequested ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ

```typescript
class AnswerSubmittedEventHandler {
  async handle(event: AnswerSubmittedEvent): Promise<void> {
    // Answerè¨˜éŒ²
    const answer = new Answer(event.answerId, event.quizId, event.userAnswer, event.isCorrect);
    await this.answerRepository.save(answer);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
    const session = await this.sessionRepository.findById(event.sessionId);
    session.addAnswer(answer);
    await this.sessionRepository.save(session);
    
    // å¾Œç¶šã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    await this.eventBus.publish(new AnswerRecordedEvent(answer));
    await this.eventBus.publish(new JudgmentDisplayRequestedEvent(event.isCorrect));
  }
}
```

#### QuizApprovedEventHandler
**å‡¦ç†è²¬ä»»è€…**: `ApprovalService`
**å‡¦ç†å†…å®¹**:
1. Quiz.status ã‚’ 'Approved' ã«æ›´æ–°
2. PublicQuizList ã¸ã®è¿½åŠ 
3. ApprovalHistory ã®è¨˜éŒ²
4. Creator ã¸ã®æ‰¿èªé€šçŸ¥

**å‰¯ä½œç”¨**:
- QuizPublishedEvent ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
- ApprovalHistoryUpdatedEvent ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
- CreatorNotifiedEvent ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ

### å‡¦ç†å†…å®¹ãƒ»å‰¯ä½œç”¨ã®åˆ†æ

#### ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®è²¬ä»»åˆ†æ•£
```mermaid
graph TD
    QuizSubmittedEvent -->|handled by| QuizManagementService
    QuizManagementService -->|emits| PendingApprovalQueueUpdatedEvent
    
    AnswerSubmittedEvent -->|handled by| LearningService
    LearningService -->|emits| AnswerRecordedEvent
    LearningService -->|emits| JudgmentDisplayRequestedEvent
    
    QuizApprovedEvent -->|handled by| ApprovalService
    ApprovalService -->|emits| QuizPublishedEvent
    ApprovalService -->|emits| CreatorNotifiedEvent
```

## ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³åˆ†æ

### ã‚¤ãƒ™ãƒ³ãƒˆé–“ã®å› æœé–¢ä¿‚

#### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³1: ã‚¯ã‚¤ã‚ºæŠ•ç¨¿-æ‰¿èª-å…¬é–‹
```mermaid
sequenceDiagram
    participant Creator
    participant QuizManagement
    participant ApprovalService
    participant Administrator
    participant PublicSpace
    
    Creator->>QuizManagement: QuizSubmittedEvent
    QuizManagement->>ApprovalService: PendingApprovalQueueUpdatedEvent
    Administrator->>ApprovalService: QuizApprovedEvent
    ApprovalService->>PublicSpace: QuizPublishedEvent
    ApprovalService->>Creator: CreatorNotifiedEvent
```

**ãƒã‚§ãƒ¼ãƒ³ã®èª¬æ˜**:
1. Creator ãŒ QuizSubmittedEvent ã‚’ç™ºç”Ÿ
2. QuizManagementService ãŒå‡¦ç†ã— PendingApprovalQueueUpdatedEvent ã‚’ç™ºè¡Œ
3. Administrator ãŒæ‰‹å‹•ã§ QuizApprovedEvent ã‚’ç™ºç”Ÿ
4. ApprovalService ãŒå‡¦ç†ã— QuizPublishedEvent + CreatorNotifiedEvent ã‚’ç™ºè¡Œ

#### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³2: å›ç­”-åˆ¤å®š-è¨˜éŒ²-çµ±è¨ˆæ›´æ–°
```mermaid
sequenceDiagram
    participant User
    participant SwipeHandler
    participant LearningService
    participant UIService
    participant StatisticsService
    
    User->>SwipeHandler: SwipeGestureDetectedEvent
    SwipeHandler->>LearningService: AnswerSubmittedEvent
    LearningService->>UIService: JudgmentDisplayRequestedEvent
    LearningService->>StatisticsService: AnswerRecordedEvent
    UIService->>UIService: BannerFadedOutEvent
    StatisticsService->>StatisticsService: StatisticsUpdatedEvent
```

#### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³3: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³-ã‚ªãƒ³ãƒ©ã‚¤ãƒ³-åŒæœŸ
```mermaid
sequenceDiagram
    participant NetworkMonitor
    participant OfflineService
    participant SyncService
    participant RemoteService
    
    NetworkMonitor->>OfflineService: NetworkDisconnectedEvent
    OfflineService->>OfflineService: OfflineModeActivatedEvent
    NetworkMonitor->>SyncService: NetworkReconnectedEvent
    SyncService->>SyncService: DataSynchronizationStartedEvent
    SyncService->>RemoteService: DataSynchronizedEvent
```

### é€£é–åå¿œãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: æˆåŠŸãƒã‚§ãƒ¼ãƒ³ï¼ˆHappy Pathï¼‰
```
UserAction â†’ BusinessEvent â†’ ProcessedEvent â†’ NotificationEvent â†’ UIUpdateEvent
```
**ä¾‹**: SwipeGesture â†’ AnswerSubmitted â†’ AnswerRecorded â†’ StatisticsUpdated â†’ JudgmentDisplayed

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ‰¿èªãƒã‚§ãƒ¼ãƒ³ï¼ˆApproval Flowï¼‰
```
SubmissionEvent â†’ QueueEvent â†’ ApprovalEvent â†’ PublishEvent â†’ NotificationEvent
```
**ä¾‹**: QuizSubmitted â†’ PendingApprovalQueued â†’ QuizApproved â†’ QuizPublished â†’ CreatorNotified

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¨ãƒ©ãƒ¼ãƒ»è£œå„Ÿãƒã‚§ãƒ¼ãƒ³ï¼ˆError Handlingï¼‰
```
FailureEvent â†’ CompensationEvent â†’ RetryEvent â†’ RecoveryEvent
```
**ä¾‹**: SyncFailed â†’ OfflineActivated â†’ RetryScheduled â†’ DataSynchronized

#### ãƒ‘ã‚¿ãƒ¼ãƒ³4: çŠ¶æ…‹é·ç§»ãƒã‚§ãƒ¼ãƒ³ï¼ˆState Transitionï¼‰
```
StateChangeEvent â†’ ValidationEvent â†’ TransitionEvent â†’ SideEffectEvent
```
**ä¾‹**: QuizStatusChanged â†’ BusinessRuleValidated â†’ StatusTransitioned â†’ CacheInvalidated

## ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŠ½å‡º

### ã‚¤ãƒ™ãƒ³ãƒˆä¸­å¿ƒã‹ã‚‰è¦‹ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

#### 1. ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆEvent Emittersï¼‰
| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | ç™ºç”Ÿã‚¤ãƒ™ãƒ³ãƒˆ | ç™ºç”Ÿè²¬ä»» | ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ |
|-------------|-------------|----------|-------------|
| **Quiz** | QuizSubmitted, QuizApproved, QuizRejected | æŠ•ç¨¿ãƒ»æ‰¿èªçŠ¶æ…‹ç®¡ç† | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å“è³ªä¿è¨¼ |
| **Answer** | AnswerSubmitted, AnswerRecorded | å›ç­”è¨˜éŒ²ãƒ»çµ±è¨ˆæä¾› | å­¦ç¿’é€²æ—è¿½è·¡ |
| **Session** | SessionStarted, SessionEnded, DataSynced | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ»åŒæœŸåˆ¶å¾¡ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ç¶™ç¶š |
| **SwipeGesture** | SwipeDetected, SwipeInterpreted | æ“ä½œæ¤œå‡ºãƒ»è§£é‡ˆ | ç›´æ„Ÿçš„UIå®Ÿç¾ |

#### 2. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆEvent Handlersï¼‰
| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | å‡¦ç†ã‚¤ãƒ™ãƒ³ãƒˆ | å‡¦ç†è²¬ä»» | å”èª¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ |
|-------------|-------------|----------|----------------|
| **QuizManagementService** | QuizSubmitted | Quizæ°¸ç¶šåŒ–ãƒ»ã‚­ãƒ¥ãƒ¼ç®¡ç† | Quiz, ApprovalQueue |
| **LearningService** | AnswerSubmitted | å­¦ç¿’è¨˜éŒ²ãƒ»çµ±è¨ˆæ›´æ–° | Answer, Session, Statistics |
| **ApprovalService** | QuizApproved/Rejected | æ‰¿èªå‡¦ç†ãƒ»é€šçŸ¥ | Quiz, Administrator, Notification |
| **SyncService** | NetworkReconnected | ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ»æ•´åˆæ€§ç¢ºä¿ | Session, OfflineStorage, RemoteStorage |

#### 3. ã‚¤ãƒ™ãƒ³ãƒˆåª’ä»‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆEvent Mediatorsï¼‰
| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | åª’ä»‹å½¹å‰² | é–¢ä¸ã‚¤ãƒ™ãƒ³ãƒˆ | åˆ¶å¾¡è²¬ä»» |
|-------------|----------|-------------|----------|
| **EventBus** | ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | å…¨ã‚¤ãƒ™ãƒ³ãƒˆ | é…ä¿¡ä¿è¨¼ãƒ»é †åºåˆ¶å¾¡ |
| **ApprovalQueue** | æ‰¿èªé †åºç®¡ç† | QuizSubmitted â†’ QuizApproved | æ‰¿èªå¾…ã¡ç®¡ç†ãƒ»å„ªå…ˆåº¦åˆ¶å¾¡ |
| **StateMachine** | çŠ¶æ…‹é·ç§»åˆ¶å¾¡ | Statuså¤‰æ›´ç³»ã‚¤ãƒ™ãƒ³ãƒˆ | çŠ¶æ…‹é·ç§»è¦å‰‡ãƒ»ä¸æ­£é·ç§»é˜²æ­¢ |
| **NotificationService** | é€šçŸ¥é…ä¿¡ | é€šçŸ¥ç³»ã‚¤ãƒ™ãƒ³ãƒˆ | é€šçŸ¥æ–¹å¼ãƒ»é…ä¿¡åˆ¶å¾¡ |

### ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»ã‚¨ãƒŸãƒƒã‚¿ãƒ¼è¨­è¨ˆ

#### Event-Driven Architecture ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

##### 1. ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
```typescript
abstract class DomainEvent {
  public readonly eventId: string;
  public readonly occurredAt: Date;
  public readonly aggregateId: string;
  
  constructor(aggregateId: string) {
    this.eventId = generateEventId();
    this.occurredAt = new Date();
    this.aggregateId = aggregateId;
  }
}

class QuizSubmittedEvent extends DomainEvent {
  constructor(
    public readonly quizId: QuizId,
    public readonly creatorId: CreatorId,
    public readonly quizData: QuizData
  ) {
    super(quizId);
  }
}
```

##### 2. ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæºï¼ˆAggregate Rootï¼‰
```typescript
abstract class AggregateRoot {
  private uncommittedEvents: DomainEvent[] = [];
  
  protected emitEvent(event: DomainEvent): void {
    this.uncommittedEvents.push(event);
  }
  
  public getUncommittedEvents(): DomainEvent[] {
    return [...this.uncommittedEvents];
  }
  
  public markEventsAsCommitted(): void {
    this.uncommittedEvents = [];
  }
}

class Quiz extends AggregateRoot {
  public submit(): void {
    this.validateForSubmission();
    this.status = QuizStatus.PendingApproval;
    
    this.emitEvent(new QuizSubmittedEvent(
      this.id,
      this.creatorId,
      this.getQuizData()
    ));
  }
  
  public approve(administrator: Administrator): void {
    this.requiresPendingStatus();
    this.status = QuizStatus.Approved;
    
    this.emitEvent(new QuizApprovedEvent(
      this.id,
      administrator.id,
      this.status
    ));
  }
}
```

##### 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…
```typescript
interface EventHandler<T extends DomainEvent> {
  handle(event: T): Promise<void>;
}

class QuizSubmittedEventHandler implements EventHandler<QuizSubmittedEvent> {
  constructor(
    private readonly approvalQueue: ApprovalQueue,
    private readonly notificationService: NotificationService,
    private readonly eventBus: EventBus
  ) {}
  
  async handle(event: QuizSubmittedEvent): Promise<void> {
    // æ‰¿èªã‚­ãƒ¥ãƒ¼ã¸ã®è¿½åŠ 
    await this.approvalQueue.enqueue(event.quizId);
    
    // ä½œæˆè€…ã¸ã®é€šçŸ¥
    await this.notificationService.notifyCreator(
      event.creatorId,
      'Quiz submitted successfully'
    );
    
    // å¾Œç¶šã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œ
    await this.eventBus.publish(
      new PendingApprovalQueueUpdatedEvent(event.quizId)
    );
  }
}
```

##### 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ãƒ»èª¿æ•´æ©Ÿæ§‹
```typescript
class EventBus {
  private handlers: Map<string, EventHandler<any>[]> = new Map();
  
  public subscribe<T extends DomainEvent>(
    eventType: new (...args: any[]) => T,
    handler: EventHandler<T>
  ): void {
    const eventName = eventType.name;
    const handlers = this.handlers.get(eventName) || [];
    handlers.push(handler);
    this.handlers.set(eventName, handlers);
  }
  
  public async publish(event: DomainEvent): Promise<void> {
    const eventName = event.constructor.name;
    const handlers = this.handlers.get(eventName) || [];
    
    // é †æ¬¡å‡¦ç†ï¼ˆé †åºä¿è¨¼ï¼‰
    for (const handler of handlers) {
      await handler.handle(event);
    }
  }
}
```

##### 5. ã‚µãƒ¼ã‚¬ãƒ»é•·æœŸå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹
```typescript
class QuizApprovalSaga {
  constructor(private readonly eventBus: EventBus) {
    this.eventBus.subscribe(QuizSubmittedEvent, this.handleQuizSubmitted.bind(this));
    this.eventBus.subscribe(QuizApprovedEvent, this.handleQuizApproved.bind(this));
    this.eventBus.subscribe(QuizRejectedEvent, this.handleQuizRejected.bind(this));
  }
  
  private async handleQuizSubmitted(event: QuizSubmittedEvent): Promise<void> {
    // æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
    const approvalProcess = new ApprovalProcess(event.quizId);
    await approvalProcess.start();
  }
  
  private async handleQuizApproved(event: QuizApprovedEvent): Promise<void> {
    // æ‰¿èªå®Œäº†å‡¦ç†
    await this.publishQuiz(event.quizId);
    await this.notifyCreator(event.quizId, 'APPROVED');
  }
  
  private async handleQuizRejected(event: QuizRejectedEvent): Promise<void> {
    // æ‹’å¦å‡¦ç†
    await this.notifyCreator(event.quizId, 'REJECTED');
    await this.recordRejectionReason(event.quizId, event.reason);
  }
}
```

## å®Ÿè£…ã¸ã®ç¤ºå”†

### Event-Driven Architecture ã®è¨­è¨ˆåŸå‰‡

#### 1. ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆ
- ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ€åˆã«å®šç¾©
- ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è²¬ä»»ã‚’å°å‡º
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ç–çµåˆå®Ÿç¾

#### 2. ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ†é›¢åŸå‰‡
- **Command**: çŠ¶æ…‹å¤‰æ›´è¦æ±‚ï¼ˆQuizSubmitCommandï¼‰
- **Event**: ç™ºç”Ÿã—ãŸäº‹å®Ÿï¼ˆQuizSubmittedEventï¼‰
- **Query**: ç¾åœ¨çŠ¶æ…‹ã®ç…§ä¼šï¼ˆGetQuizQueryï¼‰

#### 3. æ•´åˆæ€§ã®æ®µéšçš„å®Ÿç¾
- **å³åº§æ•´åˆæ€§**: åŒä¸€é›†ç´„å†…
- **çµæœæ•´åˆæ€§**: é›†ç´„é–“ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±
- **è£œå„Ÿå‡¦ç†**: ã‚¨ãƒ©ãƒ¼æ™‚ã®çŠ¶æ…‹å¾©æ—§

### ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆã‚¢è¨­è¨ˆ
```typescript
interface EventStore {
  save(aggregateId: string, events: DomainEvent[]): Promise<void>;
  getEvents(aggregateId: string): Promise<DomainEvent[]>;
  getEventsByType(eventType: string): Promise<DomainEvent[]>;
}

class Quiz extends AggregateRoot {
  public static fromHistory(events: DomainEvent[]): Quiz {
    const quiz = new Quiz();
    
    for (const event of events) {
      quiz.applyEvent(event);
    }
    
    quiz.markEventsAsCommitted();
    return quiz;
  }
  
  private applyEvent(event: DomainEvent): void {
    if (event instanceof QuizSubmittedEvent) {
      this.status = QuizStatus.PendingApproval;
      this.createdAt = event.occurredAt;
    } else if (event instanceof QuizApprovedEvent) {
      this.status = QuizStatus.Approved;
      this.approvedAt = event.occurredAt;
    }
  }
}
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚¯ã‚¨ãƒªãƒ¢ãƒ‡ãƒ«
```typescript
class QuizListProjection {
  constructor(private readonly eventBus: EventBus) {
    this.eventBus.subscribe(QuizApprovedEvent, this.handleQuizApproved.bind(this));
    this.eventBus.subscribe(QuizRejectedEvent, this.handleQuizRejected.bind(this));
  }
  
  private async handleQuizApproved(event: QuizApprovedEvent): Promise<void> {
    const quiz = await this.quizRepository.findById(event.quizId);
    
    await this.publicQuizListView.add({
      id: quiz.id,
      question: quiz.question.text,
      tags: quiz.tags.map(t => t.name),
      createdAt: quiz.createdAt,
      approvedAt: event.occurredAt
    });
  }
}
```
```

## åˆ©ç‚¹ãƒ»æ¬ ç‚¹

### åˆ©ç‚¹
- âœ… **ãƒ“ã‚¸ãƒã‚¹ä¸­å¿ƒ**: ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­è¨ˆ
- âœ… **ç–çµåˆ**: ã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±ã§ã®é–“æ¥çš„ãªå”èª¿
- âœ… **æ‹¡å¼µæ€§**: æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¿½åŠ ãŒå®¹æ˜“
- âœ… **ç›£æŸ»æ€§**: ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã«ã‚ˆã‚‹å®Œå…¨ãªè¿½è·¡å¯èƒ½æ€§
- âœ… **å¾©æ—§æ€§**: ã‚¤ãƒ™ãƒ³ãƒˆãƒªãƒ—ãƒ¬ã‚¤ã«ã‚ˆã‚‹çŠ¶æ…‹å¾©å…ƒ

### æ¬ ç‚¹
- âŒ **è¤‡é›‘æ€§**: ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®éåŒæœŸæ€§ãƒ»é †åºåˆ¶å¾¡
- âŒ **ãƒ‡ãƒãƒƒã‚°å›°é›£**: åˆ†æ•£ã—ãŸå‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è¿½è·¡é›£
- âŒ **çµæœæ•´åˆæ€§**: å³åº§æ•´åˆæ€§ãŒå¿…è¦ãªå ´é¢ã§ã®åˆ¶ç´„
- âŒ **å­¦ç¿’ã‚³ã‚¹ãƒˆ**: Event Sourcingãƒ»CQRS ã®ç†è§£ãŒå¿…è¦

## é©ç”¨å ´é¢
- ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãŒé‡è¦ã§è¿½è·¡ãŒå¿…è¦ãªå ´åˆ
- éåŒæœŸå‡¦ç†ãƒ»çµæœæ•´åˆæ€§ãŒè¨±å®¹ã•ã‚Œã‚‹å ´åˆ
- æ‹¡å¼µæ€§ãƒ»ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’é‡è¦–ã™ã‚‹å ´åˆ
- ç›£æŸ»ãƒ­ã‚°ãƒ»ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆ
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ»åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®åˆ©ç”¨