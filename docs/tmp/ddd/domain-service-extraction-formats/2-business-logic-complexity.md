# ドメインサービス抽出フォーマット案2：ビジネスロジック複雑度型

## フォーマットの概要

DDD 2024年のベストプラクティスに基づき、ビジネスロジックの複雑度を中心としたドメインサービス抽出フォーマット。複雑なアルゴリズム・計算処理・判定ロジックの特定と、エンティティからの適切な分離に重点を置く。

## 記載項目テンプレート

### 1. ビジネスロジック複雑度分析

#### 複雑度評価マトリックス

| ロジック名 | 計算複雑度 | 条件分岐数 | 外部データ依存 | 変更頻度 | サービス候補度 |
|---|---|---|---|---|---|
| [Logic名] | [O(n)/O(n²)/O(log n)] | [分岐数] | [High/Medium/Low] | [High/Medium/Low] | [High/Medium/Low] |

#### アルゴリズム分類

| アルゴリズム名 | 種別 | 複雑度理由 | エンティティ不適合理由 | 専門知識要求 |
|---|---|---|---|---|
| [Algorithm名] | [計算/最適化/機械学習] | [複雑度の要因] | [なぜEntityに不適切か] | [必要な専門知識] |

### 2. 複雑ロジック抽出基準

#### 抽出閾値設定

| 評価軸 | 閾値 | 判定基準 | 例外条件 | 再評価頻度 |
|---|---|---|---|---|
| サイクロマティック複雑度 | [数値] | [基準] | [例外ケース] | [評価タイミング] |
| 行数 | [行数] | [基準] | [例外ケース] | [評価タイミング] |
| 外部依存数 | [個数] | [基準] | [例外ケース] | [評価タイミング] |

#### 複雑度パターン分析

| パターン名 | 識別特徴 | 抽出指針 | 実装戦略 | テスト戦略 |
|---|---|---|---|---|
| [Pattern名] | [特徴] | [いつ抽出するか] | [実装方針] | [テスト方針] |

### 3. サービス責任設計

#### 単一責任原則適用

| サービス名 | 単一責任 | 責任境界 | 変更理由 | 依存性注入 |
|---|---|---|---|---|
| [Service名] | [責任内容] | [境界設定] | [変更トリガー] | [注入対象] |

#### コヒージョン分析

| サービス名 | 内部結合度 | 結合要因 | 分割検討 | 統合検討 |
|---|---|---|---|---|
| [Service名] | [High/Medium/Low] | [結合理由] | [分割可能性] | [他サービスとの統合] |

### 4. アルゴリズム実装設計

#### 計算処理設計

| 処理名 | 入力データ | 出力データ | 計算アルゴリズム | 性能要件 |
|---|---|---|---|---|
| [Process名] | [入力仕様] | [出力仕様] | [アルゴリズム詳細] | [性能目標] |

#### 最適化戦略

| サービス名 | ボトルネック予測 | 最適化手法 | トレードオフ | 測定指標 |
|---|---|---|---|---|
| [Service名] | [予想ボトルネック] | [最適化方法] | [犠牲になるもの] | [監視項目] |

### 5. 複雑度管理戦略

#### 複雑度監視

| 監視対象 | 監視指標 | 警告閾値 | 対応アクション | 自動化レベル |
|---|---|---|---|---|
| [Monitor対象] | [指標名] | [閾値] | [対応策] | [自動/半自動/手動] |

#### リファクタリング計画

| 対象サービス | リファクタリング理由 | 実施計画 | 影響範囲 | 検証方法 |
|---|---|---|---|---|
| [Service名] | [理由] | [計画] | [影響] | [検証手順] |

---

## サンプル実装：クイズアプリケーション

### 1. ビジネスロジック複雑度分析

#### 複雑度評価マトリックス

| ロジック名 | 計算複雑度 | 条件分岐数 | 外部データ依存 | 変更頻度 | サービス候補度 |
|---|---|---|---|---|---|
| スコア計算 | O(n) | 8 | Medium | Low | High |
| 推奨アルゴリズム | O(n²) | 15 | High | High | High |
| 不正検出パターンマッチング | O(n log n) | 12 | High | Medium | High |
| 統計集計処理 | O(n) | 6 | Medium | Low | Medium |
| 難易度調整アルゴリズム | O(n) | 10 | Medium | Medium | High |
| ランキング計算 | O(n log n) | 4 | Low | Low | Medium |

#### アルゴリズム分類

| アルゴリズム名 | 種別 | 複雑度理由 | エンティティ不適合理由 | 専門知識要求 |
|---|---|---|---|---|
| 協調フィルタリング推奨 | 機械学習 | ユーザー間類似度計算の複雑性 | Entityの責任を超えた横断的処理 | 推薦システム、統計学 |
| 異常検知アルゴリズム | 機械学習 | パターン認識と学習機能 | リアルタイム分析に不適切 | 機械学習、パターン認識 |
| 動的難易度調整 | 最適化 | 多変数最適化問題 | ビジネスルールが複雑すぎる | 最適化理論、統計学 |
| 重み付きスコア計算 | 計算 | 多要素の重み付け計算 | 複数データソースの統合必要 | 統計学、数学 |
| 時系列分析予測 | 機械学習 | 時系列データの予測モデル | 履歴データ全体の分析必要 | 時系列分析、機械学習 |

### 2. 複雑ロジック抽出基準

#### 抽出閾値設定

| 評価軸 | 閾値 | 判定基準 | 例外条件 | 再評価頻度 |
|---|---|---|---|---|
| サイクロマティック複雑度 | 10以上 | 分岐・ループ数による計算 | 設定読み込みロジック除外 | 四半期ごと |
| 行数 | 50行以上 | 実効行数（コメント除く） | 初期化処理は100行まで許容 | 月次 |
| 外部依存数 | 3個以上 | Repository・外部API・計算ライブラリ | 設定値・定数は依存に含めない | 月次 |
| 変更頻度 | 月1回以上 | Git履歴による変更頻度 | バグ修正は変更に含めない | 四半期ごと |

#### 複雑度パターン分析

| パターン名 | 識別特徴 | 抽出指針 | 実装戦略 | テスト戦略 |
|---|---|---|---|---|
| 多段階計算パターン | 計算が3段階以上の処理 | 計算ロジック全体をサービス化 | Strategy パターン適用 | 各段階のUnit Test |
| 条件分岐集約パターン | if-else が5個以上 | 判定ロジックをサービス化 | Rule Engine パターン | Decision Table Testing |
| 外部データ統合パターン | 3つ以上のデータソース結合 | データ統合ロジックをサービス化 | Facade パターン | Mock を使った統合テスト |
| アルゴリズム選択パターン | 動的にアルゴリズム選択 | アルゴリズム選択をサービス化 | Strategy + Factory パターン | アルゴリズム別テスト |

### 3. サービス責任設計

#### 単一責任原則適用

| サービス名 | 単一責任 | 責任境界 | 変更理由 | 依存性注入 |
|---|---|---|---|---|
| ScoreCalculationService | スコア計算アルゴリズムの実行 | 入力検証・出力フォーマットは除外 | スコア計算式の変更 | 設定Repository |
| RecommendationEngineService | 推奨アルゴリズムの実行 | UI表示・フィルタリングは除外 | 推奨ロジックの改善 | UserRepository, QuizRepository |
| FraudDetectionService | 不正パターンの検出 | 処罰・通知は除外 | 検出精度の向上 | MLModelRepository |
| DifficultyAdjustmentService | 動的難易度調整 | 静的設定・UI表示は除外 | 調整アルゴリズムの変更 | StatisticsRepository |
| AnalyticsService | 統計分析とレポート生成 | データ可視化・出力形式は除外 | 分析手法の追加 | DataWarehouseRepository |

#### コヒージョン分析

| サービス名 | 内部結合度 | 結合要因 | 分割検討 | 統合検討 |
|---|---|---|---|---|
| ScoreCalculationService | High | 全てスコア計算に関連 | 不要 | 不要 |
| RecommendationEngineService | Medium | 推奨生成と推奨ランキングが混在 | ランキング処理を分離検討 | 不要 |
| FraudDetectionService | High | 全て不正検出に関連 | 不要 | 不要 |
| DifficultyAdjustmentService | Medium | 難易度計算と適用処理が混在 | 適用処理を分離検討 | 不要 |
| AnalyticsService | Low | 複数の分析手法が混在 | レポート種別で分割検討 | 不要 |

### 4. アルゴリズム実装設計

#### 計算処理設計

| 処理名 | 入力データ | 出力データ | 計算アルゴリズム | 性能要件 |
|---|---|---|---|---|
| スコア計算 | 回答結果、時間、難易度 | 総合スコア(0-100) | 重み付き平均 + 時間係数 | 100ms以内 |
| 協調フィルタリング | ユーザー履歴、全体統計 | 推奨クイズリスト | コサイン類似度 + k-NN | 2秒以内 |
| 異常検知 | 回答パターン、統計データ | 不正確率(0-1) | One-Class SVM | 500ms以内 |
| 難易度調整 | ユーザー能力、クイズ統計 | 調整された難易度 | 多変数最適化 | 1秒以内 |
| 時系列予測 | 過去データ、トレンド | 予測値と信頼区間 | ARIMA + 季節調整 | 5秒以内 |

#### 最適化戦略

| サービス名 | ボトルネック予測 | 最適化手法 | トレードオフ | 測定指標 |
|---|---|---|---|---|
| ScoreCalculationService | 複雑な重み付け計算 | 計算結果キャッシュ | メモリ使用量増加 | 計算時間、キャッシュヒット率 |
| RecommendationEngineService | 大量データの類似度計算 | 分散処理 + 近似アルゴリズム | 精度の若干低下 | 処理時間、推奨精度 |
| FraudDetectionService | リアルタイム機械学習 | モデル事前学習 + 高速推論 | モデル更新の遅延 | 推論時間、検出精度 |
| DifficultyAdjustmentService | 最適化計算の複雑さ | 局所最適解 + ヒューリスティック | 最適解保証なし | 計算時間、調整精度 |
| AnalyticsService | 大量データの集計処理 | 分散処理 + 段階的集計 | リアルタイム性の低下 | 処理時間、データ鮮度 |

### 5. 複雑度管理戦略

#### 複雑度監視

| 監視対象 | 監視指標 | 警告閾値 | 対応アクション | 自動化レベル |
|---|---|---|---|---|
| サイクロマティック複雑度 | CC値 | 15以上 | コードレビュー必須 | 自動（CI/CD） |
| メソッド行数 | 物理行数 | 100行以上 | リファクタリング計画 | 自動（静的解析） |
| 依存関係数 | import文・注入数 | 8個以上 | アーキテクチャレビュー | 半自動（ツール支援） |
| 処理時間 | レスポンス時間 | SLA × 150% | パフォーマンス調査 | 自動（APM） |
| エラー率 | 例外発生率 | 1%以上 | 緊急対応 | 自動（監視ツール） |

#### リファクタリング計画

| 対象サービス | リファクタリング理由 | 実施計画 | 影響範囲 | 検証方法 |
|---|---|---|---|---|
| RecommendationEngineService | 複雑度15→10に削減 | アルゴリズム分割・Strategy適用 | 推奨精度への影響 | A/Bテスト |
| AnalyticsService | 責任分離（CC 12→8） | レポート種別でサービス分割 | 既存レポートAPI | 回帰テスト |
| FraudDetectionService | 性能改善（500ms→200ms） | アルゴリズム最適化 | 検出精度への影響 | 性能テスト + 精度測定 |
| DifficultyAdjustmentService | 可読性向上（行数120→60） | 計算ロジックのモジュール化 | 調整精度への影響 | 統計的検証 |

---

## フォーマットの特徴

### 利点

- **定量的評価**：複雑度指標による客観的なサービス抽出判断
- **保守性向上**：複雑なロジックの分離による可読性向上
- **テスタビリティ**：複雑なアルゴリズムの独立テストが可能
- **専門性考慮**：アルゴリズムの専門知識と業務ロジックの分離
- **継続的改善**：複雑度監視による継続的な品質向上

### 欠点

- **過度な分割リスク**：不必要な複雑度でのサービス分割
- **評価コスト**：複雑度測定とモニタリングのオーバーヘッド
- **判断の難しさ**：閾値設定とパターン識別の主観性
- **性能オーバーヘッド**：サービス分割による呼び出しコスト

### 適用場面

- **アルゴリズム重要システム**：機械学習・最適化・分析処理が多い
- **品質重視プロジェクト**：コード品質の定量管理が必要
- **長期保守予定**：複雑なロジックの継続的な改善が必要
- **専門知識分離**：業務知識とアルゴリズム知識の分離が重要
- **チーム専門化**：アルゴリズム専門家と業務専門家の分業
