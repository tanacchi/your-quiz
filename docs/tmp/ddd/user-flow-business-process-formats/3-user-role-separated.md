# 案3: ユーザー種別分割型

## フォーマット概要

匿名ユーザー・管理者・システムの3つの視点でフローを分割整理し、各ユーザー種別の権限・責任範囲を明確化。セキュリティ要件やアクセス制御の設計に適している。

## 構成

```markdown
# ユーザー操作・業務フロー整理

## ユーザー種別概要

| ユーザー種別 | 権限レベル | 主要責務 | アクセス範囲 |
|-------------|------------|----------|-------------|
| 匿名ユーザー | 低 | コンテンツ消費 | 公開データのみ |
| 管理者 | 高 | コンテンツ管理 | 全データ + 管理機能 |
| システム | 最高 | 自動処理 | 全システムリソース |

## 匿名ユーザーフロー

### フロー1: [フロー名]
| 項目 | 内容 |
|------|------|
| **Who** | 匿名ユーザー |
| **What** | 実行内容 |
| **権限要件** | 必要な権限 |
| **セキュリティ制約** | 制限事項 |
| **重要度** | 高/中/低 |
| **処理方式** | リアルタイム/準リアルタイム/バッチ |

### 操作手順
1. ステップ1
2. ステップ2

### セキュリティ考慮事項
- 制約1
- 制約2

## 管理者フロー

[同様の構成]

## システムフロー

[同様の構成]

## 権限マトリックス

| 操作 | 匿名ユーザー | 管理者 | システム | 備考 |
|------|-------------|---------|----------|------|
|      | ✅/❌        | ✅/❌    | ✅/❌     |      |
```

## サンプル実装

```markdown
# ユーザー操作・業務フロー整理 - クイズアプリケーション

## ユーザー種別概要

| ユーザー種別 | 権限レベル | 主要責務 | アクセス範囲 | 識別方法 |
|-------------|------------|----------|-------------|----------|
| **匿名ユーザー** | 読み取り | クイズ回答・閲覧 | 承認済みクイズ、自分の履歴 | セッション、ブラウザ識別 |
| **管理者** | 管理 | クイズ承認・管理 | 全クイズ、承認待ち、統計 | 認証（将来実装） |
| **システム** | システム | 自動処理・同期 | 全データ、インフラ | プロセス実行権限 |

---

## 匿名ユーザーフロー

### フロー1: クイズ回答フロー

| 項目 | 内容 |
|------|------|
| **Who** | 匿名ユーザー（ログイン不要） |
| **What** | ◯×クイズの回答、結果閲覧、履歴確認 |
| **権限要件** | 読み取り専用（承認済みクイズのみ） |
| **セキュリティ制約** | 承認待ち・拒否クイズは非表示、他ユーザー履歴は非表示 |
| **重要度** | 高（メイン機能） |
| **処理方式** | リアルタイム |
| **頻度** | 100回/日 |

#### 操作手順
1. **アプリアクセス** - スマートフォンブラウザでURL直接アクセス
2. **クイズ一覧取得** - 承認済みクイズのみAPI経由で取得
3. **問題表示** - Tinder風UIで問題文・選択肢表示
4. **回答実行** - 右スワイプ（◯）・左スワイプ（×）
5. **結果確認** - 正誤判定バン表示 → フェードアウト → 解説表示
6. **履歴保存** - IndexedDBに回答結果永続化
7. **継続/終了** - 次の問題継続 or アプリ終了

#### セキュリティ考慮事項
- **データアクセス制限**: 承認済み（approved=true）クイズのみ取得可能
- **履歴プライバシー**: 他ユーザーの回答履歴は参照不可
- **不正操作防止**: API直接呼び出しでの不正データ送信を防止
- **XSS対策**: 表示データは全てエスケープ処理済み
- **レート制限**: API呼び出し頻度制限（100req/min）

#### 例外処理
| 例外パターン | 発生条件 | 対応方法 | セキュリティ影響 |
|-------------|----------|----------|------------------|
| **不正API呼び出し** | 直接API操作 | 400エラー返却、ログ記録 | 低（情報漏洩なし） |
| **承認待ちクイズアクセス** | URLハック試行 | 404エラー、アクセス拒否 | 中（存在情報漏洩） |
| **大量リクエスト** | 短時間大量アクセス | レート制限、一時制限 | 低（DoS対策） |

---

### フロー2: クイズ作成フロー

| 項目 | 内容 |
|------|------|
| **Who** | 匿名ユーザー（一般投稿者） |
| **What** | 問題文・正解・解説・タグの入力・投稿 |
| **権限要件** | 投稿権限（承認待ち状態での保存） |
| **セキュリティ制約** | XSSサニタイズ、文字数制限、即時公開不可 |
| **重要度** | 高（コンテンツ供給源） |
| **処理方式** | リアルタイム（投稿）、バッチ（承認） |
| **頻度** | 10回/日 |

#### 操作手順
1. **作成画面アクセス** - 作成ボタン押下でフォーム表示
2. **フォーム入力** - 問題文（500字以内）、正解（◯×）、解説（1000字以内）、タグ
3. **バリデーション** - クライアント側での入力検証
4. **投稿実行** - サーバーへPOST送信
5. **サーバー処理** - XSSサニタイズ、承認待ち状態でDB保存
6. **識別情報保存** - salt付きハッシュでブラウザに作成者情報保存
7. **完了通知** - 投稿完了、承認待ち状態を通知

#### セキュリティ考慮事項
- **XSS対策**: HTMLタグ完全除去、特殊文字エスケープ
- **インジェクション対策**: SQLインジェクション、NoSQLインジェクション防止
- **匿名識別**: salt付きハッシュで作成者識別、個人情報は保存しない
- **承認制**: 投稿即座公開なし、管理者承認後公開
- **スパム対策**: 同一IPからの連続投稿制限（10投稿/時間）
- **文字数制限**: 問題文500字、解説1000字の厳格な制限

#### 例外処理
| 例外パターン | 発生条件 | 対応方法 | セキュリティ影響 |
|-------------|----------|----------|------------------|
| **XSS攻撃試行** | HTMLタグ混入 | サニタイズ処理、投稿受理 | 高（攻撃無害化） |
| **文字数超過** | 制限超過データ | クライアント制限、サーバー拒否 | 低（DoS対策） |
| **連続投稿** | スパム行為 | IP制限、一時投稿禁止 | 中（スパム防止） |

---

## 管理者フロー

### フロー1: クイズ承認フロー

| 項目 | 内容 |
|------|------|
| **Who** | 管理者（現在はDB直接操作、将来は管理画面） |
| **What** | 投稿クイズの内容確認、承認/拒否判定 |
| **権限要件** | 管理者権限（全クイズ読み書き、承認権限） |
| **セキュリティ制約** | 認証必須（将来）、操作ログ記録 |
| **重要度** | 高（品質管理） |
| **処理方式** | バッチ（手動実行） |
| **頻度** | 5回/日 |

#### 操作手順
1. **承認待ちクイズ確認** - DB直接クエリで approved=false データ取得
2. **内容審査** - 問題文・解説・タグの適切性確認
3. **重複チェック** - 類似問題の存在確認（手動）
4. **判定実行** - 承認/拒否の決定
5. **ステータス更新** - DB直接操作で approved=true/false 更新
6. **拒否理由記録** - 拒否の場合、理由をメモ（将来の改善用）

#### セキュリティ考慮事項
- **操作権限**: DB直接アクセス権限必須
- **操作ログ**: 承認/拒否操作の完全ログ記録
- **判定基準**: 内容適切性、重複チェック、法的問題なし
- **データ整合性**: 承認状態変更時の整合性確保
- **バックアップ**: 誤操作対策のバックアップ体制

#### 承認基準
| 項目 | 承認条件 | 拒否条件 | 判定方法 |
|------|----------|----------|----------|
| **内容適切性** | 教育的価値あり | 不適切・攻撃的内容 | 手動確認 |
| **重複度** | 許容（仕様上OK） | - | 手動検索 |
| **技術的品質** | 文字化け・表示問題なし | 表示不具合 | 目視確認 |
| **法的問題** | 著作権・肖像権問題なし | 権利侵害疑い | 手動判定 |

---

### フロー2: システム管理フロー

| 項目 | 内容 |
|------|------|
| **Who** | 管理者（システム管理者） |
| **What** | システム状態監視、障害対応、メンテナンス |
| **権限要件** | システム管理者権限（インフラ操作） |
| **セキュリティ制約** | 多要素認証、操作ログ、承認フロー |
| **重要度** | 高（システム継続性） |
| **処理方式** | リアルタイム（監視）、バッチ（メンテナンス） |
| **頻度** | 監視：継続的、メンテナンス：週次 |

#### 操作手順
1. **システム監視** - ダッシュボードでメトリクス確認
2. **アラート対応** - 障害発生時の緊急対応
3. **ログ分析** - エラーログ、アクセスログの定期分析
4. **パフォーマンス調整** - システム最適化作業
5. **セキュリティ監視** - 不正アクセス、攻撃の検出・対応

---

## システムフロー

### フロー1: オフライン同期フロー

| 項目 | 内容 |
|------|------|
| **Who** | システム（ServiceWorker、Background Sync） |
| **What** | ネットワーク復旧時のデータ同期、整合性確保 |
| **権限要件** | システムレベル権限（DB読み書き、API呼び出し） |
| **セキュリティ制約** | データ整合性、認証不要（システム内処理） |
| **重要度** | 中（UX向上） |
| **処理方式** | バッチ（ネットワーク復旧時） |
| **頻度** | ネットワーク状況に依存 |

#### 操作手順
1. **ネットワーク状態監視** - navigator.onLine での常時監視
2. **オフライン検出** - 接続断線の検出、オフラインモード開始
3. **ローカルデータ利用** - IndexedDBからの事前ダウンロードデータ利用
4. **操作キューイング** - オフライン中の操作を同期キューに保存
5. **復旧検出** - ネットワーク接続復旧の検出
6. **同期実行** - キューイングされたデータのサーバー送信
7. **整合性確認** - サーバー・クライアント間の データ整合性確認

#### セキュリティ考慮事項
- **データ整合性**: 同期時の競合解決、最新データ優先
- **エラーハンドリング**: 同期失敗時のリトライ機能、指数バックオフ
- **プライバシー**: 同期データの暗号化、一時保存最小化
- **パフォーマンス**: 大量データ同期時のチャンク分割

---

### フロー2: 定期メンテナンスフロー

| 項目 | 内容 |
|------|------|
| **Who** | システム（cron、scheduled tasks） |
| **What** | 古いデータ削除、統計情報更新、パフォーマンス最適化 |
| **権限要件** | システムレベル権限（DB管理、リソース管理） |
| **セキュリティ制約** | バックアップ必須、ロールバック準備 |
| **重要度** | 中（システム健全性） |
| **処理方式** | バッチ（定期実行） |
| **頻度** | 日次・週次・月次 |

#### 操作手順
1. **日次処理**（毎日深夜2時）
   - ログローテーション
   - 一時データ削除
   - 統計情報更新

2. **週次処理**（日曜日深夜）
   - 古い回答履歴の圧縮
   - インデックス最適化
   - パフォーマンス分析レポート生成

3. **月次処理**（月初深夜）
   - 長期未承認クイズの削除検討
   - ストレージ使用量分析
   - セキュリティログ分析

---

## 権限マトリックス

| 操作/データ | 匿名ユーザー | 管理者 | システム | 備考 |
|-------------|-------------|---------|----------|------|
| **承認済みクイズ閲覧** | ✅ | ✅ | ✅ | 基本機能 |
| **承認待ちクイズ閲覧** | ❌ | ✅ | ✅ | 管理者のみ |
| **クイズ作成** | ✅ | ✅ | ❌ | 承認待ちで作成 |
| **クイズ承認** | ❌ | ✅ | ❌ | 管理者権限必須 |
| **他ユーザー履歴** | ❌ | ✅ | ✅ | プライバシー保護 |
| **システム設定** | ❌ | ❌ | ✅ | システム権限必須 |
| **DB直接アクセス** | ❌ | ✅ | ✅ | 管理・システムのみ |
| **API統計情報** | ❌ | ✅ | ✅ | 運用情報 |

## セキュリティ要件サマリー

### 匿名ユーザー
- **認証**: 不要（セッション管理のみ）
- **データアクセス**: 承認済み公開データのみ
- **操作制限**: 読み取り・作成（承認待ち）のみ
- **プライバシー**: 個人履歴のみ参照可能

### 管理者
- **認証**: 将来的に多要素認証必須
- **データアクセス**: 全データ（承認待ち含む）
- **操作権限**: 承認・拒否・削除・システム設定
- **監査**: 全操作のログ記録必須

### システム
- **認証**: プロセスレベル認証
- **データアクセス**: 全システムリソース
- **操作権限**: 自動処理・メンテナンス・監視
- **制約**: バックアップ・ロールバック体制必須

## 実装優先度

| ユーザー種別 | 実装優先度 | 理由 | 初期実装範囲 |
|-------------|------------|------|-------------|
| **匿名ユーザー** | 1（最高） | メイン機能 | 回答・作成フロー |
| **システム** | 2（高） | 基盤機能 | 同期・メンテナンス |
| **管理者** | 3（中） | 運用機能 | 承認フロー（DB直接） |

## 将来拡張

### Phase 2: 管理者機能強化
- Web管理画面の実装
- バッチ承認機能
- 統計ダッシュボード
- 不正検出アラート

### Phase 3: 権限細分化
- 一般ユーザー登録機能
- 投稿者権限レベル
- モデレーター権限
- コミュニティ管理機能
```

## 利点・欠点

### 利点

- ✅ ユーザー種別ごとの権限・責任が明確
- ✅ セキュリティ要件の漏れ防止
- ✅ アクセス制御設計が容易
- ✅ 段階的実装の優先度判断が可能

### 欠点

- ❌ フロー間の連携が見えにくい
- ❌ 同一機能の重複記述が発生
- ❌ ユーザー種別が増えると複雑化

## 適用場面

- 複数ユーザー種別がある場合
- セキュリティ・権限管理が重要
- 段階的な機能リリースを予定
- アクセス制御の詳細設計が必要
