# エンティティ間関連性分析フォーマット案3：ビジネスルール中心型

## フォーマットの概要

DDD 2024年のベストプラクティスに基づき、ビジネスルールとインバリアント（不変条件）を中心としたエンティティ間関連性分析フォーマット。ドメインの制約とビジネスロジックの配置を重視した設計アプローチ。

## 記載項目テンプレート

### 1. ビジネスルール体系分析

#### コアビジネスルール抽出

| ルール名 | ルール内容 | 対象エンティティ | 実装場所 | 優先度 |
|---|---|---|---|---|
| [Rule名] | [具体的制約内容] | [関係するエンティティ] | [Entity/Service/Factory] | [High/Medium/Low] |

#### ルール分類マトリックス

| ルールカテゴリ | ルール数 | 複雑度 | エンティティ横断 | 実装戦略 |
|---|---|---|---|---|
| [データ整合性] | [件数] | [High/Medium/Low] | [Yes/No] | [実装アプローチ] |
| [ビジネス制約] | [件数] | [High/Medium/Low] | [Yes/No] | [実装アプローチ] |
| [業務フロー] | [件数] | [High/Medium/Low] | [Yes/No] | [実装アプローチ] |

### 2. インバリアント（不変条件）設計

#### エンティティレベルインバリアント

| エンティティ名 | インバリアント名 | 条件式 | 検証タイミング | 違反時動作 |
|---|---|---|---|---|
| [Entity名] | [条件名] | [論理式] | [検証時点] | [Exception/対応策] |

#### アグリゲートレベルインバリアント

| アグリゲート名 | インバリアント名 | 関与エンティティ | 条件式 | 保証レベル |
|---|---|---|---|---|
| [Aggregate名] | [条件名] | [エンティティリスト] | [論理式] | [Strong/Eventual] |

#### システムレベルインバリアント

| インバリアント名 | 関与アグリゲート | 条件式 | 保証戦略 | 検証頻度 |
|---|---|---|---|---|
| [条件名] | [Aggregateリスト] | [論理式] | [実装方法] | [検証タイミング] |

### 3. ビジネスロジック配置設計

#### エンティティ責任分析

| エンティティ名 | ビジネス責任 | 含有ルール | メソッド設計 | 協調パターン |
|---|---|---|---|---|
| [Entity名] | [責任内容] | [ルールリスト] | [主要メソッド] | [他エンティティとの協調] |

#### ドメインサービス設計

| サービス名 | 担当ルール | 関与エンティティ | サービス理由 | インターフェース |
|---|---|---|---|---|
| [Service名] | [ルール内容] | [エンティティリスト] | [サービス化理由] | [主要メソッド] |

### 4. 制約充足関係分析

#### 制約依存関係

| 制約A | 制約B | 依存関係 | 検証順序 | 競合解決 |
|---|---|---|---|---|
| [制約名] | [制約名] | [依存型] | [実行順] | [競合時対応] |

#### 制約実行計画

| 制約グループ | 実行順序 | 並列実行可否 | 失敗時処理 | パフォーマンス影響 |
|---|---|---|---|---|
| [グループ名] | [順序] | [可/不可] | [ロールバック戦略] | [処理時間影響] |

### 5. ビジネス例外設計

#### 例外体系設計

| 例外名 | 発生条件 | 関連ルール | 回復可能性 | ユーザー対応 |
|---|---|---|---|---|
| [Exception名] | [発生条件] | [違反ルール] | [可/不可] | [ユーザーアクション] |

#### 例外処理戦略

| 処理レイヤー | 処理方針 | ログ出力 | ユーザー通知 | システム動作 |
|---|---|---|---|---|
| [Entity/Service/Application] | [処理方針] | [ログレベル] | [通知内容] | [継続/停止] |

---

## サンプル実装：クイズアプリケーション

### 1. ビジネスルール体系分析

#### コアビジネスルール抽出

| ルール名 | ルール内容 | 対象エンティティ | 実装場所 | 優先度 |
|---|---|---|---|---|
| 最小問題数制約 | クイズには最低1問の質問が必要 | Quiz, Question | Quiz Entity | High |
| 回答時間制限 | セッションには制限時間が設定される | QuizSession | QuizSession Entity | High |
| 承認者権限制約 | クイズ承認は管理者権限が必要 | Quiz, Admin | Quiz Domain Service | High |
| 重複回答禁止 | 同一ユーザーは同じクイズを1日1回まで | QuizSession, User | Session Domain Service | Medium |
| 選択肢必須 | 各質問には2つ以上の選択肢が必要 | Question, Choice | Question Entity | High |
| ユーザー一意性 | メールアドレスによるユーザー一意性 | User | User Factory | High |
| スコア計算ルール | 正答率×時間係数でスコア算出 | QuizSession, Score | Score Value Object | Medium |

#### ルール分類マトリックス

| ルールカテゴリ | ルール数 | 複雑度 | エンティティ横断 | 実装戦略 |
|---|---|---|---|---|
| データ整合性 | 3 | Low | No | Entity内で検証 |
| ビジネス制約 | 2 | Medium | Yes | Domain Serviceで実装 |
| 業務フロー | 2 | High | Yes | Application Serviceで制御 |
| セキュリティ | 1 | Medium | Yes | Domain Serviceで検証 |

### 2. インバリアント（不変条件）設計

#### エンティティレベルインバリアント

| エンティティ名 | インバリアント名 | 条件式 | 検証タイミング | 違反時動作 |
|---|---|---|---|---|
| Quiz | 最小問題数 | questions.size() >= 1 | 問題追加/削除時 | MinimumQuestionException |
| Question | 選択肢必須 | choices.size() >= 2 | 選択肢変更時 | InsufficientChoicesException |
| QuizSession | 制限時間内 | currentTime <= startTime + timeLimit | 回答提出時 | TimeoutException |
| User | メール形式 | email matches regex | 登録/更新時 | InvalidEmailFormatException |
| Choice | 正解設定 | exactly one correct choice per question | 正解設定時 | MultipleCorrectAnswersException |

#### アグリゲートレベルインバリアント

| アグリゲート名 | インバリアント名 | 関与エンティティ | 条件式 | 保証レベル |
|---|---|---|---|---|
| Quiz | クイズ整合性 | Quiz, Question, Choice | すべての質問に有効な選択肢 | Strong |
| QuizSession | セッション整合性 | QuizSession, Answer | 回答数 <= 質問数 | Strong |
| User | ユーザー一意性 | User | system.users.email unique | Strong |
| Administration | 承認権限整合性 | Admin, Quiz | 承認者は有効な管理者 | Strong |

#### システムレベルインバリアント

| インバリアント名 | 関与アグリゲート | 条件式 | 保証戦略 | 検証頻度 |
|---|---|---|---|---|
| 孤立データ防止 | Quiz, User | 削除ユーザーのクイズは無効化 | Event-driven cleanup | ユーザー削除時 |
| セッション一意性 | QuizSession, User, Quiz | (user, quiz, date) unique | Database constraint | セッション作成時 |
| 統計データ整合性 | Quiz, QuizSession, Statistics | 統計値 = 実績値 | Batch reconciliation | 日次バッチ |

### 3. ビジネスロジック配置設計

#### エンティティ責任分析

| エンティティ名 | ビジネス責任 | 含有ルール | メソッド設計 | 協調パターン |
|---|---|---|---|---|
| Quiz | クイズ整合性管理 | 最小問題数、承認状態 | addQuestion(), approve() | Factory経由作成 |
| Question | 質問整合性管理 | 選択肢必須、正解設定 | addChoice(), setCorrectAnswer() | Quiz内部で協調 |
| QuizSession | セッション管理 | 制限時間、回答順序 | submitAnswer(), complete() | User・Quiz参照 |
| User | ユーザーアイデンティティ | メール一意性、認証 | register(), authenticate() | Factory経由作成 |
| Score | スコア計算 | スコア計算ルール | calculate(), compare() | QuizSession内部で使用 |

#### ドメインサービス設計

| サービス名 | 担当ルール | 関与エンティティ | サービス理由 | インターフェース |
|---|---|---|---|---|
| QuizApprovalService | 承認権限制約 | Quiz, Admin | 複数エンティティ横断 | approve(Quiz, Admin) |
| SessionLimitService | 重複回答禁止 | QuizSession, User, Quiz | 複数アグリゲート横断 | canStartSession(User, Quiz) |
| UserRegistrationService | ユーザー一意性 | User | 外部システム連携 | register(UserData) |
| ScoreCalculationService | スコア計算 | QuizSession, Score | 複雑なビジネスロジック | calculateScore(Session) |

### 4. 制約充足関係分析

#### 制約依存関係

| 制約A | 制約B | 依存関係 | 検証順序 | 競合解決 |
|---|---|---|---|---|
| ユーザー認証 | セッション開始 | 前提条件 | 認証→セッション | 認証失敗でセッション拒否 |
| 問題存在確認 | 回答提出 | 前提条件 | 問題確認→回答 | 問題不存在でエラー |
| 制限時間確認 | スコア計算 | 前提条件 | 時間確認→計算 | 時間超過で無効処理 |
| 承認状態確認 | セッション作成 | 前提条件 | 承認確認→作成 | 未承認でセッション拒否 |

#### 制約実行計画

| 制約グループ | 実行順序 | 並列実行可否 | 失敗時処理 | パフォーマンス影響 |
|---|---|---|---|---|
| セッション開始制約 | 認証→承認確認→重複チェック | 一部並列可 | 早期失敗で中断 | 低（キャッシュ活用） |
| 回答提出制約 | 時間確認→問題確認→回答検証 | 逐次実行 | ロールバック不要 | 中（DB確認必要） |
| クイズ作成制約 | 内容検証→権限確認→保存 | 逐次実行 | トランザクション内 | 中（検証処理重い） |

### 5. ビジネス例外設計

#### 例外体系設計

| 例外名 | 発生条件 | 関連ルール | 回復可能性 | ユーザー対応 |
|---|---|---|---|---|
| MinimumQuestionException | 質問数 < 1 | 最小問題数制約 | 可 | 質問を追加してください |
| TimeoutException | 制限時間超過 | 回答時間制限 | 不可 | セッションを再開始してください |
| UnauthorizedApprovalException | 非管理者の承認試行 | 承認者権限制約 | 不可 | 管理者権限が必要です |
| DuplicateSessionException | 重複セッション作成 | 重複回答禁止 | 可 | 明日再度お試しください |
| InvalidEmailFormatException | メール形式不正 | ユーザー一意性 | 可 | 正しいメール形式で入力してください |

#### 例外処理戦略

| 処理レイヤー | 処理方針 | ログ出力 | ユーザー通知 | システム動作 |
|---|---|---|---|---|
| Entity | 不変条件維持 | DEBUG | - | Exception throw |
| Domain Service | ビジネスルール実行 | INFO | - | Exception throw |
| Application Service | 例外変換・処理 | WARN | エラーメッセージ | 処理中断 |
| Infrastructure | システム例外処理 | ERROR | システムエラー | 状態復旧 |

---

## フォーマットの特徴

### 利点

- **ビジネスルール明確化**：ドメインの制約が明確に文書化される
- **実装指針具体的**：どこに何のロジックを配置するか明確
- **品質向上**：制約違反による不具合を事前防止
- **保守性向上**：ビジネスルール変更時の影響範囲が明確
- **テスト設計支援**：制約条件がテストケース設計の指針となる

### 欠点

- **初期工数大**：すべてのビジネスルールの洗い出しが必要
- **複雑性増加**：制約が増えるほど設計複雑性が上がる
- **パフォーマンス影響**：制約検証処理による性能低下可能性
- **学習コスト**：ドメインモデリングとルール設計の両方の理解必要

### 適用場面

- **制約が多いドメイン**：金融、医療、法的要求が厳格なシステム
- **品質重視プロジェクト**：データ整合性が最重要なシステム
- **長期保守予定**：ビジネスルール変更が頻繁にあるシステム
- **複雑な業務フロー**：多数の制約条件がある業務システム
- **規制遵守必要**：コンプライアンス要求が厳しい業界
