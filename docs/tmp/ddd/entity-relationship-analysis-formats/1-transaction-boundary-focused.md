# エンティティ間関連性分析フォーマット案1：トランザクション境界中心型

## フォーマットの概要

DDD 2024年のベストプラクティスに基づき、トランザクション一貫性とアグリゲート境界を中心としたエンティティ間関連性分析フォーマット。ビジネス不変条件を満たすための最小単位でのトランザクション境界設計に重点を置く。

## 記載項目テンプレート

### 1. アグリゲート境界分析

#### アグリゲート候補の抽出

| アグリゲート名 | 責任範囲 | トランザクション境界理由 | ビジネス不変条件 | 想定サイズ |
|---|---|---|---|---|
| [アグリゲート名] | [責任とスコープ] | [なぜこの境界が必要か] | [守るべきビジネスルール] | [エンティティ数] |

#### アグリゲートルート特定

| アグリゲート名 | アグリゲートルート | 選定理由 | 外部アクセスポリシー |
|---|---|---|---|
| [アグリゲート名] | [ルートエンティティ] | [なぜルートとなるか] | [外部からのアクセス制御] |

### 2. エンティティ間関連性マトリックス

#### 同一アグリゲート内関連

| エンティティA | エンティティB | 関係性 | 一貫性レベル | ライフサイクル |
|---|---|---|---|---|
| [エンティティ名] | [エンティティ名] | [関係の種類] | [強一貫性/結果整合性] | [作成/更新/削除の依存] |

#### アグリゲート間関連

| アグリゲートA | アグリゲートB | 関係性 | 一貫性戦略 | 統合パターン |
|---|---|---|---|---|
| [アグリゲート名] | [アグリゲート名] | [関係の種類] | [結果整合性戦略] | [イベント/リポジトリ/サービス] |

### 3. トランザクション分析

#### トランザクション境界設計

| 業務処理名 | 関与アグリゲート | トランザクション戦略 | 一貫性保証 | ロック範囲 |
|---|---|---|---|---|
| [処理名] | [アグリゲートリスト] | [単一/分散トランザクション] | [即座/結果整合性] | [ロック対象] |

#### パフォーマンス考慮事項

| アグリゲート名 | 同時実行競合リスク | 最適化戦略 | 分割検討 |
|---|---|---|---|
| [アグリゲート名] | [高/中/低] | [楽観ロック/分散] | [分割可能性] |

### 4. ドメインイベント設計

#### アグリゲート内イベント

| アグリゲート名 | イベント名 | 発行タイミング | イベントデータ |
|---|---|---|---|
| [アグリゲート名] | [イベント名] | [どの操作で発行] | [含むデータ] |

#### アグリゲート間結合パターン

| 発行アグリゲート | 購読アグリゲート | イベント名 | 処理内容 | 障害時処理 |
|---|---|---|---|---|
| [発行元] | [購読先] | [イベント名] | [実行処理] | [補償処理] |

### 5. インバリアント（ビジネス制約）分析

#### アグリゲート内インバリアント

| アグリゲート名 | インバリアント名 | 制約内容 | 検証タイミング | 違反時対応 |
|---|---|---|---|---|
| [アグリゲート名] | [制約名] | [具体的制約] | [いつ検証] | [エラー処理] |

#### アグリゲート間インバリアント

| 関連アグリゲート | インバリアント名 | 制約内容 | 整合性戦略 | 許容遅延 |
|---|---|---|---|---|
| [アグリゲートリスト] | [制約名] | [具体的制約] | [どう保証するか] | [遅延許容時間] |

---

## サンプル実装：クイズアプリケーション

### 1. アグリゲート境界分析

#### アグリゲート候補の抽出

| アグリゲート名 | 責任範囲 | トランザクション境界理由 | ビジネス不変条件 | 想定サイズ |
|---|---|---|---|---|
| Quiz | クイズの管理・実行 | クイズの一貫性保証必要 | 問題数≥1、承認状態管理 | 5-10エンティティ |
| User | ユーザー管理・認証 | ユーザー情報の一意性 | ユーザーID一意性、権限整合性 | 3-5エンティティ |
| QuizSession | 回答セッション管理 | 回答の整合性・採点 | 回答順序、時間制限、採点一貫性 | 4-7エンティティ |
| Administration | 管理機能 | 管理操作の権限・記録 | 管理者権限検証、操作ログ整合性 | 3-4エンティティ |

#### アグリゲートルート特定

| アグリゲート名 | アグリゲートルート | 選定理由 | 外部アクセスポリシー |
|---|---|---|---|
| Quiz | Quiz（クイズ） | クイズ全体のライフサイクル制御 | QuizIdによる直接アクセスのみ |
| User | User（ユーザー） | ユーザーのアイデンティティ中心 | UserIdまたはEmail認証のみ |
| QuizSession | QuizSession（セッション） | セッション状態の制御責任 | SessionIdによる直接アクセスのみ |
| Administration | Admin（管理者） | 管理権限の中心的制御 | AdminIdによる認証アクセスのみ |

### 2. エンティティ間関連性マトリックス

#### 同一アグリゲート内関連

| エンティティA | エンティティB | 関係性 | 一貫性レベル | ライフサイクル |
|---|---|---|---|---|
| Quiz | Question | 1対多（構成） | 強一貫性 | Quiz削除時Question全削除 |
| Question | Choice | 1対多（構成） | 強一貫性 | Question削除時Choice全削除 |
| QuizSession | Answer | 1対多（構成） | 強一貫性 | Session削除時Answer全削除 |
| User | UserProfile | 1対1（拡張） | 強一貫性 | 同期削除・更新 |
| Admin | AdminLog | 1対多（ログ） | 強一貫性 | Admin削除時ログ保持（論理削除） |

#### アグリゲート間関連

| アグリゲートA | アグリゲートB | 関係性 | 一貫性戦略 | 統合パターン |
|---|---|---|---|---|
| Quiz | User | 多対多（作成者） | 結果整合性 | ドメインイベント |
| QuizSession | Quiz | 多対1（参照） | 結果整合性 | リポジトリ参照 |
| QuizSession | User | 多対1（参照） | 結果整合性 | リポジトリ参照 |
| Administration | Quiz | 1対多（管理） | 結果整合性 | ドメインサービス |
| Administration | User | 1対多（管理） | 結果整合性 | ドメインサービス |

### 3. トランザクション分析

#### トランザクション境界設計

| 業務処理名 | 関与アグリゲート | トランザクション戦略 | 一貫性保証 | ロック範囲 |
|---|---|---|---|---|
| クイズ作成 | Quiz | 単一トランザクション | 即座一貫性 | Quiz集約全体 |
| クイズ回答開始 | QuizSession, Quiz | 分散トランザクション | 結果整合性 | 各アグリゲート単位 |
| 回答提出 | QuizSession | 単一トランザクション | 即座一貫性 | Session集約全体 |
| クイズ承認 | Quiz, Administration | 分散トランザクション | 結果整合性 | 各アグリゲート単位 |
| ユーザー登録 | User | 単一トランザクション | 即座一貫性 | User集約全体 |

#### パフォーマンス考慮事項

| アグリゲート名 | 同時実行競合リスク | 最適化戦略 | 分割検討 |
|---|---|---|---|
| Quiz | 中（承認時競合） | 楽観ロック、バージョニング | 統計情報の分離検討 |
| User | 低（登録時のみ） | 一意制約、楽観ロック | 分割不要 |
| QuizSession | 高（並行回答） | セッション分離、楽観ロック | 回答履歴の分離検討 |
| Administration | 低（管理者限定） | 悲観ロック許容 | ログの分離検討 |

### 4. ドメインイベント設計

#### アグリゲート内イベント

| アグリゲート名 | イベント名 | 発行タイミング | イベントデータ |
|---|---|---|---|
| Quiz | QuizCreated | クイズ作成完了時 | QuizId, Title, CreatorId, Timestamp |
| Quiz | QuizApproved | 承認完了時 | QuizId, ApproverId, Timestamp |
| QuizSession | SessionStarted | セッション開始時 | SessionId, QuizId, UserId, StartTime |
| QuizSession | AnswerSubmitted | 回答提出時 | SessionId, QuestionId, Answer, Timestamp |
| QuizSession | SessionCompleted | セッション完了時 | SessionId, Score, Duration, Timestamp |

#### アグリゲート間結合パターン

| 発行アグリゲート | 購読アグリゲート | イベント名 | 処理内容 | 障害時処理 |
|---|---|---|---|---|
| Quiz | Administration | QuizCreated | 承認待ちリスト追加 | イベント再配信 |
| QuizSession | Quiz | SessionCompleted | 統計情報更新 | 結果整合性で後処理 |
| User | Quiz | UserDeactivated | 作成者情報無効化 | 論理削除で対応 |
| Administration | Quiz | ApprovalProcessed | 承認状態反映 | 補償処理でロールバック |

### 5. インバリアント（ビジネス制約）分析

#### アグリゲート内インバリアント

| アグリゲート名 | インバリアント名 | 制約内容 | 検証タイミング | 違反時対応 |
|---|---|---|---|---|
| Quiz | 最小問題数制約 | 問題数 ≥ 1 | 問題削除・クイズ作成時 | DomainExceptionスロー |
| Quiz | 承認状態整合性 | 承認済→未承認への変更不可 | 状態変更時 | IllegalStateExceptionスロー |
| QuizSession | 回答順序制約 | 問題は順序通り回答 | 回答提出時 | InvalidOperationExceptionスロー |
| QuizSession | セッション時間制限 | 制限時間内の回答のみ有効 | 回答提出時 | TimeoutExceptionスロー |
| User | ユーザーID一意性 | システム内でUserID一意 | ユーザー作成時 | DuplicateExceptionスロー |

#### アグリゲート間インバリアント

| 関連アグリゲート | インバリアント名 | 制約内容 | 整合性戦略 | 許容遅延 |
|---|---|---|---|---|
| Quiz-User | 作成者存在制約 | クイズ作成者は有効ユーザー | 結果整合性＋補償処理 | 5分以内 |
| QuizSession-Quiz | クイズ存在制約 | セッション対象クイズが存在 | イベント駆動検証 | 1分以内 |
| Administration-Quiz | 承認権限制約 | 承認は管理者権限必須 | ドメインサービス検証 | 即座検証 |
| QuizSession-User | 回答者存在制約 | セッション回答者は有効ユーザー | 結果整合性＋補償処理 | 5分以内 |

---

## フォーマットの特徴

### 利点

- **トランザクション境界が明確**：ビジネス不変条件に基づいた適切な境界設定
- **パフォーマンス考慮**：同時実行性とロック戦略を事前検討
- **一貫性戦略明確**：即座一貫性vs結果整合性の使い分け指針
- **実装指針具体的**：開発時の判断基準が明確

### 欠点

- **複雑性が高い**：トランザクション戦略の理解が必要
- **設計変更コスト**：境界変更時の影響範囲が大きい
- **学習コスト**：DDDとトランザクション設計の両方の知識必要

### 適用場面

- **高一貫性要求システム**：金融、在庫管理など
- **並行処理重要システム**：高トラフィック、リアルタイム処理
- **複雑な業務制約**：多くのビジネスルールがある場合
- **経験豊富チーム**：DDD・アーキテクチャ設計経験者が多い場合
