# データアーキテクチャ方針

## データストア戦略

### データ分類と配置方針

クイズアプリケーションにおけるデータ特性と適切なストア選択：

| データ分類 | 特性 | 推奨ストア | 一貫性要件 | 理由 |
|-----------|------|-----------|-----------|------|
| **マスターデータ** | 構造化・ACID必要 | RDBMS | 強一貫性 | クイズ・承認状態の整合性保証 |
| **ユーザー状態** | 高速アクセス・一時的 | Browser Storage | 結果整合性 | オフライン対応・UX向上 |
| **キャッシュデータ** | 高頻度読み取り | Multi-layer Cache | 結果整合性 | パフォーマンス最適化 |

### データベース技術選択

- **メインDB**: SQLite + Cloudflare D1
  - 強一貫性が必要なクイズ・承認データ
  - Cloudflare Workers統合による運用統一
  - シンプルなCRUD要件には十分な機能性

- **クライアントストレージ**: IndexedDB + localStorage
  - オフライン対応とUX向上
  - 一時的な回答データとユーザー設定

## データ一貫性方針

### ACID vs BASE選択基準

**強一貫性（ACID）適用領域**:

- クイズ承認状態管理
- 作成者識別・重複防止  
- 統計データ集計
- SQLiteの制約内での堅牢性確保

**結果整合性（BASE）適用領域**:

- 回答履歴（オフライン対応優先）
- キャッシュデータ（パフォーマンス優先）
- 利用統計（遅延許容）

### オフライン・オンライン同期戦略

- **同期パターン**: Eventually Consistent with Conflict Resolution
- **D1制約考慮**: 数秒のタイムアウト制限内での効率的な同期処理
- **競合解決ルール**:
  - 回答データ: Last-Write-Wins（透明処理）
  - 設定データ: User-Choice（ユーザー選択）
  - マスターデータ: Server-Wins（管理者優先）

## データモデリング方針

### エンティティ設計原則

- **Quiz Aggregate**: 問題・解答・メタデータの集約
- **Answer History**: 時系列イベントとしての回答記録
- **User Context**: 匿名化された識別子と設定情報

### 将来拡張性考慮

- **Event Sourcing**: 回答履歴のみ部分適用
- **CQRS**: 現段階では不採用（過剰設計）
- **SQLite制約対応**: データ量増加時のPostgreSQL移行戦略準備
- **シャーディング**: SQLite→PostgreSQL移行後に検討

## セキュリティ・プライバシー方針

### データ保護戦略

- **暗号化方針**:
  - ユーザー識別子: Salt付きハッシュ
  - 転送時: TLS 1.3強制
  - 保存時: 機密度に応じた選択的暗号化

- **データ保持ポリシー**:
  - 承認済みクイズ: 永続保持（D1 25GB制限考慮）
  - 承認待ち/拒否: 自動削除（30日/7日）
  - 回答履歴: 匿名化処理（2年後）
  - **容量管理**: D1制限監視とデータ最適化

### プライバシー配慮

- 匿名ユーザー中心設計
- 最小限データ収集原則
- 自動削除・匿名化による最小化
