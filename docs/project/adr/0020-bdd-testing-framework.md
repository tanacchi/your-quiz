# ADR-0020: BDDテスティングフレームワーク選定

## ステータス

Proposed

## コンテキスト

### 背景

クイズアプリケーションのBDDテスト実装において、以下の要件を満たすフレームワーク選定が必要となった：

- **パッケージ分離対応**: `api/` および `e2e/` パッケージでの独立したBDDテスト環境
- **API直接テスト**: UIを介さないAPI直接呼び出しでのドメインロジック検証
- **型安全性重視**: TypeScript完全対応による開発者体験向上
- **自動化重視**: CI/CD統合・並列実行・高速フィードバックループ
- **Vitest統合**: 単体テストとの一貫性確保（Vitestとの技術スタック統一）
- **DDD設計連携**: ユビキタス言語辞書との完全統合
- **長期保守性**: 安定したエコシステム・豊富なドキュメント・コミュニティサポート

### 技術的制約

- **既存技術スタック**: Vitest（単体テスト）、TypeScript、Node.js
- **プロジェクト構成**: モノレポ構成での `api/`、`ui/`、`e2e/` パッケージ分離
- **CI/CD要件**: GitHub Actions統合、並列実行対応
- **パフォーマンス要件**: 高速テスト実行による開発効率向上

## 候補選択肢

### Option 1: Cucumber.js + Vitest

**概要**: 業界標準のCucumber.jsとVitestテストランナーの統合

**技術仕様**:

- Cucumber.js v11.3.0（最新安定版）
- TypeScript完全対応（追加設定による）
- Vitest統合（カスタム実行設定）
- 豊富なプラグイン・フォーマッター

**メリット**:

- ✅ **業界標準**: 5,137 GitHub stars、月間500万DL の実績
- ✅ **豊富なエコシステム**: プラグイン・拡張・カスタマイズ選択肢多数
- ✅ **企業実績**: 大規模プロジェクトでの採用事例豊富
- ✅ **安定性**: Cucumber組織による長期サポート・継続的メンテナンス
- ✅ **ドキュメント充実**: 公式・コミュニティ両方での豊富なリソース
- ✅ **TypeScript対応**: 完全な型安全性（設定により）
- ✅ **コミュニティサポート**: Stack Overflow・GitHub Discussions活発

**デメリット**:

- ❌ **設定複雑性**: Vitest統合に追加設定・カスタマイズ要
- ❌ **学習コスト**: Cucumber.js固有の概念・設定の習得必要
- ❌ **実行オーバーヘッド**: 独立プロセスによる若干のパフォーマンス劣化

### Option 2: QuickPickle + Vitest

**概要**: Vitest専用のGherkin BDDプラグイン

**技術仕様**:

- QuickPickle v1.9.0
- Vitest完全統合
- TypeScriptネイティブ対応

**メリット**:

- ✅ **Vitest完全統合**: 同一実行環境による一貫した開発体験
- ✅ **高速実行**: Vitestの並列処理・Worker threads活用
- ✅ **設定簡素**: 最小限の設定でBDD環境構築
- ✅ **TypeScript最適化**: ネイティブTypeScript対応

**デメリット**:

- ❌ **新興技術**: 40 GitHub stars、週間171DL と小規模コミュニティ
- ❌ **エコシステム不足**: プラグイン・拡張の選択肢限定
- ❌ **企業採用事例不足**: 大規模プロジェクトでの実績少
- ❌ **ドキュメント不足**: 基本的なドキュメントのみ、ベストプラクティス不明
- ❌ **長期サポート不確実**: 個人開発者による維持、継続性リスク
- ❌ **トラブルシューティング困難**: 情報・解決策の不足

### Option 3: Playwright-BDD + Playwright

**概要**: PlaywrightランナーでのGherkin実行

**技術仕様**:

- Playwrightテストランナー拡張
- ブラウザ自動化特化設計

**メリット**:

- ✅ **E2E特化**: ブラウザテストに最適化された高性能
- ✅ **TypeScript対応**: Playwright基盤の型安全性

**デメリット**:

- ❌ **API特化不適**: API単体テストには過剰機能・低効率
- ❌ **実行コスト**: ブラウザ起動オーバーヘッド大
- ❌ **用途限定**: E2Eテスト以外での利用価値低

## 決定内容

**Cucumber.js + Vitest** をBDDテスティングフレームワークとして採用する

## 決定理由

### 1. 安定性・信頼性の重視

| 項目 | Cucumber.js | QuickPickle | Playwright-BDD |
|------|-------------|-------------|----------------|
| **GitHub Stars** | 5,137 | 40 | 中程度 |
| **月間DL** | 500万+ | 少数 | 中程度 |
| **企業採用** | 多数 | 限定的 | 中程度 |
| **長期サポート** | 組織保証 | 個人依存 | Microsoft支援 |
| **ドキュメント** | 豊富 | 基本的 | 中程度 |

**判断**: プロダクション環境での長期運用を考慮し、実績・安定性を最優先

### 2. リスク管理

**QuickPickle採用時のリスク**:

- **コミュニティリスク**: 小規模コミュニティ（40 stars）による情報・サポート不足
- **継続性リスク**: 個人開発者依存による長期メンテナンス不確実性
- **エコシステムリスク**: プラグイン・拡張不足による機能制限
- **企業採用リスク**: 大規模プロジェクト実績不足による未知の問題

**Cucumber.js選択によるリスク軽減**:

- **安定性**: Cucumber組織による継続的サポート
- **情報豊富**: 豊富なドキュメント・チュートリアル・ベストプラクティス
- **問題解決**: Stack Overflow・コミュニティでの活発なサポート

### 3. 技術要件適合性

| 要件 | Cucumber.js+Vitest | QuickPickle+Vitest | 判定 |
|------|-------------------|-------------------|------|
| **TypeScript対応** | ★★★★☆ (設定要) | ★★★★★ (ネイティブ) | Cucumber.js許容範囲 |
| **Vitest統合** | ★★★☆☆ (カスタム) | ★★★★★ (完全統合) | 設定工数vs安定性 |
| **API直接テスト** | ★★★★★ (最適化) | ★★★★★ (最適化) | 同等 |
| **ドキュメント** | ★★★★★ (豊富) | ★★☆☆☆ (不足) | Cucumber.js圧勝 |
| **長期保守性** | ★★★★★ (保証) | ★★☆☆☆ (不安) | Cucumber.js圧勝 |

**総合判断**: 設定複雑性というデメリットを考慮しても、安定性・保守性の価値が上回る

### 4. プロジェクト戦略適合性

**短期開発効率 vs 長期保守性**:

- QuickPickle: 短期間での高効率開発
- Cucumber.js: 長期間での安定運用・拡張性

**判断**: プロダクションアプリケーションとして長期保守性を重視

## 実装方針

### 1. パッケージ構成

```txt
api/
├── package.json                       # cucumber依存関係追加
├── cucumber.config.js                 # Cucumber設定
├── vitest.config.ts                   # Vitest設定（単体テスト用）
└── tests/
    ├── features/                      # Gherkinシナリオ
    │   ├── quiz-approval-flow.feature
    │   ├── domain-constraints.feature
    │   └── data-consistency.feature
    ├── steps/                         # ステップ定義（TypeScript）
    │   ├── quiz-management.steps.ts
    │   ├── domain-services.steps.ts
    │   └── data-validation.steps.ts
    ├── support/                       # テスト設定
    │   ├── world.ts                  # Cucumberコンテキスト
    │   ├── hooks.ts                  # Before/After Hook
    │   └── api-client.ts             # API呼び出しヘルパー
    └── fixtures/                      # テストデータ
        └── quiz-data.json
```

### 2. 技術設定

**依存関係**:

```json
{
  "devDependencies": {
    "vitest": "^1.x.x",
    "@cucumber/cucumber": "^11.3.0",
    "@cucumber/pretty-formatter": "^1.x.x",
    "@types/cucumber": "^7.x.x",
    "typescript": "^5.x.x"
  }
}
```

**Cucumber設定** (`cucumber.config.js`):

```javascript
export default {
  require: ['tests/steps/**/*.ts', 'tests/support/**/*.ts'],
  format: ['pretty', 'json:reports/cucumber-report.json'],
  paths: ['tests/features/**/*.feature'],
  requireModule: ['ts-node/register']
}
```

**TypeScript設定追加**:

```json
{
  "compilerOptions": {
    "types": ["@cucumber/cucumber", "vitest/globals"]
  }
}
```

### 3. 実行コマンド

```bash
# API BDD テスト実行
npm run test:bdd:api

# Cucumber HTML レポート生成
npm run test:bdd:api:report

# 単体テスト実行（Vitest）
npm run test:unit
```

### 4. Vitest統合戦略

**分離実行**:

- BDDテスト: Cucumber.js独立実行
- 単体テスト: Vitest独立実行
- 統合レポート: 両結果をCI/CDで統合

**共通ヘルパー**:

- APIクライアント・テストデータは両環境で共用
- TypeScript型定義の統一

## 結果・期待効果

### 1. 安定性・信頼性向上

- **長期サポート**: Cucumber組織による継続的メンテナンス保証
- **豊富な情報**: 公式ドキュメント・コミュニティサポート活用
- **実績ベース**: 大規模プロジェクトでの採用事例による安心感

### 2. 開発効率向上

- **学習コスト**: 業界標準による知識・経験の活用
- **問題解決**: 豊富な情報・サポートによる迅速なトラブル解決
- **拡張性**: プラグイン・カスタマイズによる機能拡張

### 3. 品質向上

- **ビジネスロジック検証**: Gherkin記法によるビジネス要件の明確化
- **保守性**: TypeScript型システムによるリファクタリング安全性
- **可読性**: 業界標準記法による関係者間の共通理解

## 代替案とトレードオフ

### QuickPickle選択時のトレードオフ

**得られるもの**: Vitest完全統合・高速実行・設定簡素性
**失うもの**: 安定性・エコシステム・ドキュメント・長期サポート

→ **判断**: 短期効率より長期保守性を優先

### Playwright-BDD選択時のトレードオフ

**得られるもの**: E2E特化最適化・ブラウザテスト機能
**失うもの**: API単体テスト効率・軽量性・汎用性

→ **判断**: E2Eパッケージでは将来的に検討、APIではCucumber.js採用

## 移行・実装戦略

### Phase 1: 環境構築（1-2日）

- Cucumber.js環境セットアップ
- TypeScript統合設定
- 基本動作確認

### Phase 2: PoC実装（2-3日）

- 1つのフィーチャーファイル作成
- ステップ定義実装
- API呼び出し動作確認

### Phase 3: 本格実装（1週間）

- 全境界づけられたコンテキストのBDDシナリオ作成
- ステップ定義完全実装
- CI/CD統合

### Phase 4: 運用最適化（継続）

- パフォーマンス調整
- レポート・ドキュメント整備
- チーム習熟度向上

## 補足・注意事項

### 設定複雑性への対応

1. **段階的導入**: 最小構成から開始し、段階的に機能追加
2. **ドキュメント整備**: プロジェクト固有の設定・運用手順書作成
3. **ベストプラクティス適用**: Cucumber.js公式推奨事項の採用

### 成功指標

- [ ] BDDテスト環境構築完了（TypeScript + API直接呼び出し）
- [ ] 全境界づけられたコンテキストのシナリオ作成完了
- [ ] CI/CD統合完了（自動実行・レポート生成）
- [ ] 開発者習熟度向上（Gherkin記法・ステップ定義）
- [ ] 長期保守性確保（ドキュメント・運用手順整備）

### 将来の拡張計画

- **E2Eパッケージ**: Playwright-BDD検討
- **パフォーマンステスト**: Cucumber.js + 負荷テストツール統合
- **レポート強化**: HTMLレポート・ダッシュボード統合

---

**決定日**: 2025-01-31
**決定者**: 開発チーム
**レビュー予定**: 3ヶ月後（実装完了後）
