# ドメイン知識ベース

## 目的

[要件定義](docs/project/specifications/requirements/requirements-quiz.md)と[ユーザーストーリー](docs/project/specifications/user-stories/user-story-quiz.md)を基に、クイズアプリケーションドメインの深い理解を構築し、重要なビジネスルール・制約・例外処理を体系的に整理する。

## 概要

クイズアプリケーションのビジネスドメインにおける中核的な知識を、ドメインエキスパートとの対話を通じて抽出・整理し、DDD設計の基盤となるドメイン理解を確立します。本知識ベースは`specifications/requirements/requirements-quiz.md`の機能要件・非機能要件と完全に整合しています。

## ビジネスルール体系

### 1. クイズ管理ルール

#### 1.1 クイズ作成制約

| 制約項目 | 制約内容 | 根拠文書 | 例外処理 |
|----------|----------|----------|----------|
| **問題文長** | 必須、500文字以内 | requirements-quiz.md:11 | 制限超過時はリアルタイム警告表示 |
| **正解形式** | ◯または×の2択のみ | requirements-quiz.md:12 | 他形式入力は型レベルで排除 |
| **解説長** | 任意、1000文字以内 | requirements-quiz.md:13 | 設定時のみ制限適用 |
| **タグ数** | 任意、10個まで | requirements-quiz.md:14 | 上限超過時は最新10個を保持 |
| **サニタイズ** | HTMLタグ除去必須 | requirements-quiz.md:15 | XSS攻撃防止のため例外なし |

#### 1.2 承認フロールール

| 状態遷移 | 実行者 | 前提条件 | 後続処理 |
|----------|--------|----------|----------|
| **投稿→承認待ち** | 匿名ユーザー | バリデーション通過 | 管理者通知、作成者ID生成 |
| **承認待ち→承認済み** | 管理者のみ | 内容審査完了 | 公開状態変更、統計更新 |
| **承認待ち→拒否** | 管理者のみ | 品質基準未達 | 拒否理由記録、ログ保存 |
| **承認済み→変更** | 不可 | - | 編集は新規作成扱い |

### 2. 学習体験ルール

#### 2.1 回答制約

| 制約項目 | 制約内容 | 根拠文書 | ビジネス価値 |
|----------|----------|----------|-------------|
| **回答可能性** | 承認済みクイズのみ | user-story-quiz.md:3 | 品質保証された学習コンテンツ |
| **回答重複** | 同一クイズ複数回答許可 | user-story-quiz.md:15 | 反復学習による定着促進 |
| **即座判定** | スワイプ操作後即座に正誤表示 | user-story-quiz.md:8 | 学習効果最大化 |
| **履歴保持** | 匿名化形式で永続保持 | requirements-quiz.md:25 | 学習進捗追跡・統計分析 |

#### 2.2 セッション管理ルール

| 管理項目 | 管理方法 | 根拠文書 | プライバシー配慮 |
|----------|----------|----------|------------------|
| **ユーザー識別** | salt付きハッシュ | requirements-quiz.md:30 | 個人特定不可能な匿名性 |
| **デバイス識別** | フィンガープリント | user-story-quiz.md:12 | 複数デバイス対応 |
| **セッション継続** | 30日間有効 | requirements-quiz.md:31 | 学習継続性とストレージ効率 |
| **作成者権限** | CreatorIdによる照合 | user-story-quiz.md:18 | 自作クイズのみ確認可能 |

### 3. データ管理ルール

#### 3.1 永続化戦略

| データ種別 | 保持期間 | 保持理由 | 根拠文書 |
|------------|----------|----------|----------|
| **承認済みクイズ** | 永続保持 | 学習コンテンツとして価値継続 | requirements-quiz.md:40 |
| **承認待ちクイズ** | 30日後削除 | 運用効率とストレージ最適化 | requirements-quiz.md:41 |
| **拒否クイズ** | 7日後削除 | 短期間の再審査余地を残す | requirements-quiz.md:42 |
| **回答履歴** | 2年後匿名化 | 統計分析価値とプライバシー配慮 | requirements-quiz.md:43 |

#### 3.2 品質管理ルール

| 品質観点 | 管理基準 | 実装方法 | 根拠文書 |
|----------|----------|----------|----------|
| **重複チェック** | 類似問題の統合・警告 | 問題文の類似度判定 | requirements-quiz.md:50 |
| **不適切コンテンツ** | 自動検出・管理者審査 | キーワードフィルタ + 人的判断 | requirements-quiz.md:51 |
| **タグ正規化** | 表記揺れの統一 | 正規化名での内部管理 | requirements-quiz.md:52 |

## 重要な設計決定とトレードオフ

### 1. 匿名ユーザー管理の複雑性

#### 決定: セッションベース匿名管理 vs ステートレス

**選択**: セッションベース（UserSession集約による管理）

**理由**:

- 作成者識別の継続性（自作クイズ確認機能）
- オフライン対応の必要性（同期処理基準）
- 学習履歴の個人化（進捗追跡・統計）

**トレードオフ**:

- ✅ 機能性向上: 豊富な学習体験提供
- ✅ ユーザー体験改善: 継続的な学習支援
- ❌ システム複雑性増加: セッション管理・同期処理
- ❌ ストレージコスト: セッション情報永続化

**代替案検討**:

- **ステートレス方式**: 簡素だが作成者識別・履歴管理不可
- **ログイン方式**: 高機能だが匿名性要件に反する

### 2. 承認フローの厳格性

#### 決定: 全件人的承認 vs 一部自動承認

**選択**: 全件人的承認（管理者による品質統制）

**理由**:

- コンテンツ品質の一貫性保証
- 不適切コンテンツの確実な排除
- ブランド価値・信頼性の維持

**トレードオフ**:

- ✅ 品質保証: 高品質な学習コンテンツ
- ✅ 安全性: 不適切コンテンツの事前排除
- ❌ 運用負荷: 管理者の継続的作業
- ❌ 公開遅延: 即座公開不可

**スケーラビリティ考慮**:

- 投稿量増加時は承認者増員・承認基準明文化で対応
- 将来的にはML支援による半自動化を検討

### 3. オフライン対応の技術的複雑性

#### 決定: 統合型 vs 分離型アーキテクチャ

**選択**: 分離型（Offline Sync Context独立）

**理由**:

- 技術的複雑性の局所化
- 他機能への影響最小化
- 専門性の集約（同期・競合解決）

**トレードオフ**:

- ✅ 保守性向上: 複雑な同期ロジックの分離
- ✅ 技術的負債局所化: 影響範囲限定
- ❌ 統合複雑性: コンテキスト間連携
- ❌ 学習コスト: 分散アーキテクチャの理解

**競合解決戦略**:

- **Last-Write-Wins**: 実装簡素、データロスリスク
- **Manual Resolution**: 複雑だが確実性高い
- → **単純化**: Last-Write-Winsで開始、必要に応じて高度化

## ドメインの複雑性分析

### 1. 本質的複雑性

#### 1.1 ビジネスルールの複雑性

- **承認フロー**: 状態遷移・権限制御・品質管理の複合
- **匿名ユーザー管理**: プライバシー・識別・継続性の両立
- **オフライン同期**: 整合性・競合解決・パフォーマンス

#### 1.2 技術的制約の複雑性

- **Cloudflare D1制限**: 25GB制限でのデータ保持戦略
- **PWA要件**: オフライン対応・同期処理
- **匿名性要件**: セキュリティ・プライバシー配慮

### 2. 偶発的複雑性の排除

#### 2.1 過度な抽象化の回避

- エンティティ・値オブジェクト分類の明確化
- 不要なデザインパターンの適用回避
- ドメインロジックとインフラ関心事の分離

#### 2.2 早期最適化の回避

- スケーラビリティ要件の段階的対応
- パフォーマンス最適化は測定後実施
- 拡張性確保と現在要件のバランス

## 例外シナリオと対応戦略

### 1. データ整合性例外

| 例外シナリオ | 発生原因 | 対応戦略 | 優先度 |
|-------------|----------|----------|--------|
| **Quiz-Answer不整合** | Quiz削除後のAnswer孤児化 | 履歴保持（匿名化継続） | 低 |
| **セッション期限切れ** | 30日超過アクセス | 新規セッション自動生成 | 中 |
| **同期競合** | オフライン期間中の同一データ更新 | Last-Write-Wins + ログ記録 | 高 |
| **承認者不在** | 管理者長期不在 | 代理承認権限・エスカレーション | 高 |

### 2. パフォーマンス劣化例外

| 劣化シナリオ | 閾値 | 対応戦略 | 自動対応 |
|-------------|------|----------|----------|
| **大量投稿** | 1日100件以上 | バッチ処理・優先度制御 | ○ |
| **高頻度アクセス** | 同時接続100以上 | キャッシュ強化・CDN活用 | ○ |
| **ストレージ上限** | D1 20GB到達 | 古いデータアーカイブ | ○ |
| **同期処理遅延** | 5分以上 | 同期処理の分割・再試行 | × |

### 3. セキュリティ例外

| 脅威シナリオ | 検出方法 | 対応戦略 | 根拠文書 |
|-------------|----------|----------|----------|
| **XSS攻撃** | サニタイズチェック | HTML除去・エスケープ | requirements-quiz.md:60 |
| **大量投稿攻撃** | レート制限 | IP・セッション単位制限 | requirements-quiz.md:61 |
| **不適切コンテンツ** | キーワード検出 | 自動拒否・管理者確認 | requirements-quiz.md:62 |
| **匿名性侵害** | 識別情報混入 | データ検証・ログ監視 | requirements-quiz.md:63 |

## まとめ

クイズアプリケーションドメインは、**匿名性を保持しながらの個人化された学習体験提供**という本質的な複雑性を持ちます。この複雑性は以下の設計原則で管理します：

- **責務の明確な分離**: 境界づけられたコンテキストによる関心事分離
- **ビジネスルールの明文化**: 不変条件・制約の型レベル表現
- **例外処理の戦略化**: 想定される例外への明確な対応方針
- **トレードオフの透明化**: 設計決定の理由・代替案・影響の明記

この知識ベースは、後続のDDD戦術パターン適用・アーキテクチャ設計の確固たる基盤を提供します。

## 関連ドキュメント

- [要件定義](docs/project/specifications/requirements/requirements-quiz.md)
- [ユーザーストーリー](docs/project/specifications/user-stories/user-story-quiz.md)
- [ドメインモデル概要](docs/project/ddd-design/2.00_domain-model-overview.md)
- [ユビキタス言語辞書](docs/project/ddd-design/2.03_ubiquitous-language/ubiquitous-language-dictionary.md)

---
**作成工程**: DDD設計
**作成日**: 2025-01-30
**更新日**: 2025-01-30
