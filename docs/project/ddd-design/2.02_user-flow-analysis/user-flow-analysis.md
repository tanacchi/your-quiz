# ユーザーフロー分析

## 目的

[ユーザーストーリー](docs/project/specifications/user-stories/user-story-quiz.md)で定義された機能要件を詳細なユーザーフローに展開し、ビジネス価値・技術難易度・ROI分析に基づく段階的実装計画を策定する。

## 概要

クイズアプリケーションにおける主要なユーザー操作と業務フローを、正常系・異常系を含めて整理し、ドメインロジックの境界を明確化します。本分析は`specifications/user-stories/user-story-quiz.md`の5W1H分析と`requirements-quiz.md`の制約条件に基づいています。

## 主要ユーザーストーリー

### US-01: クイズ回答（匿名ユーザー）

**アクター**: 匿名ユーザー
**目的**: 承認済みクイズに回答して学習する

#### 正常フロー（US-01）

1. **クイズ一覧表示**
   - 承認済みクイズ一覧を取得
   - タグによる絞り込み機能を提供
   - Tinder UI形式で表示

2. **クイズ回答**
   - ユーザーがスワイプ操作で回答入力（右=◯、左=×）
   - 正誤判定をリアルタイム表示
   - 解説と次問題ボタンを表示

3. **回答記録**
   - 回答履歴をブラウザ（IndexedDB）に保存
   - セッション情報を記録

#### 異常フロー（US-01）

- **ネットワークエラー**: オフラインモードへ切り替え
- **データ不整合**: エラーメッセージ表示と安全な状態への復帰
- **不正回答**: バリデーションエラーとして処理

### US-02: クイズ作成（匿名ユーザー）

**アクター**: 匿名ユーザー
**目的**: 新しいクイズを投稿する

#### 正常フロー（US-02）

1. **クイズ入力**
   - 問題文（必須、500文字以内）
   - 正解選択（◯または×）
   - 解説（任意、1000文字以内）
   - タグ設定（任意、複数）

2. **投稿処理**
   - 入力バリデーション実行
   - サニタイズ処理実行
   - 承認待ち状態でデータベース保存
   - 作成者識別情報（salt付きハッシュ）をブラウザ保存

3. **確認表示**
   - 投稿完了メッセージ表示
   - 作成者のみクイズ確認可能

#### 異常フロー（US-02）

- **バリデーションエラー**: 具体的なエラーメッセージ表示
- **文字数超過**: リアルタイム警告表示
- **ネットワークエラー**: ドラフト保存と再試行機能

### US-03: クイズ承認（管理者）

**アクター**: 管理者
**目的**: 投稿されたクイズを審査・承認する

#### 正常フロー（US-03）

1. **承認待ちクイズ確認**
   - 承認待ち状態のクイズ一覧取得
   - 内容確認（問題文、解説、タグ）

2. **承認判定**
   - 承認: クイズ状態を承認済みに変更、承認日時記録
   - 拒否: クイズ状態を拒否に変更、理由記録

3. **承認完了**
   - 承認済みクイズが一般ユーザーに公開
   - 承認統計の更新

#### 異常フロー（US-03）

- **重複チェック**: 類似クイズの警告表示
- **不適切コンテンツ**: 自動的に拒否、ログ記録

### US-04: 回答履歴確認（匿名ユーザー）

**アクター**: 匿名ユーザー
**目的**: 過去の回答を確認・復習する

#### 正常フロー（US-04）

1. **履歴一覧表示**
   - ブラウザ保存の回答履歴を取得
   - 問題文・回答日時・正誤の一覧表示

2. **詳細確認**
   - 特定回答の詳細表示
   - 正解・解説の再確認
   - 再解答機能の提供

#### 異常フロー（US-04）

- **データ消失**: 履歴なしメッセージ表示
- **データ破損**: 安全な初期化処理

### US-05: オフライン利用（匿名ユーザー）

**アクター**: 匿名ユーザー
**目的**: ネットワーク不安定時でもクイズを利用する

#### 正常フロー（US-05）

1. **オフライン検出**
   - ネットワーク断線の検出
   - オフラインモード切り替え提案

2. **オフライン機能**
   - 事前ダウンロード済みクイズで回答
   - ローカル回答履歴記録

3. **同期処理**
   - ネットワーク復旧時に自動同期
   - 競合解決処理

#### 異常フロー（US-05）

- **データ不足**: 追加ダウンロード提案
- **同期失敗**: エラー表示と手動再試行

## 運営側業務フロー

### BF-01: コンテンツ管理業務

#### 日次運営業務（BF-01）

1. **承認待ちクイズ確認**
   - 新規投稿クイズの内容審査
   - 品質基準に基づく承認・拒否判定
   - 不適切コンテンツの除去

2. **データ品質管理**
   - 重複クイズの統合・削除
   - タグの正規化・整理
   - ユーザー報告への対応

#### 定期運営業務（BF-01）

1. **統計分析**
   - クイズ回答率分析
   - タグ人気度分析
   - エラー発生状況監視

2. **システム保守**
   - データベース最適化
   - 古いデータのアーカイブ
   - セキュリティ更新

### BF-02: データ管理業務

#### データ保持ポリシー（BF-02）

1. **承認済みクイズ**: 永続保持（D1 25GB制限考慮）
2. **承認待ちクイズ**: 30日後自動削除
3. **拒否クイズ**: 7日後自動削除
4. **回答履歴**: 2年後匿名化処理

#### データ監視（BF-02）

1. **容量監視**: D1制限に対する使用量監視
2. **品質監視**: データ整合性チェック
3. **セキュリティ監視**: 不正アクセス検出

## ドメインイベント

### クイズライフサイクルイベント

| イベント名 | 発生タイミング | データ | 後続処理 |
|------------|----------------|--------|----------|
| **QuizSubmitted** | クイズ投稿時 | Quiz, CreatorId | 承認待ち状態設定、通知 |
| **QuizApproved** | 管理者承認時 | QuizId, ApprovedBy, ApprovedAt | 公開状態変更、統計更新 |
| **QuizRejected** | 管理者拒否時 | QuizId, RejectedBy, Reason | 拒否状態設定、ログ記録 |
| **QuizAnswered** | ユーザー回答時 | AnswerId, QuizId, UserAnswer | 履歴記録、統計更新 |

### システムイベント

| イベント名 | 発生タイミング | データ | 後続処理 |
|------------|----------------|--------|----------|
| **OfflineModeActivated** | ネットワーク断線検出時 | SessionId, Timestamp | ローカルストレージ切り替え |
| **DataSynchronized** | オンライン復旧時 | SessionId, SyncedData | サーバーとの同期処理 |
| **CreatorIdentified** | 作成者情報生成時 | CreatorId, DeviceFingerprint | セッション管理、権限設定 |

## ビジネスルールと不変条件

### クイズエンティティの不変条件

1. **問題文制約**
   - 必須入力
   - 500文字以内
   - HTMLタグ除去済み

2. **正解制約**
   - ◯または×の2択のみ
   - 必須設定

3. **解説制約**
   - 任意入力
   - 1000文字以内（設定時）
   - HTMLタグ除去済み

4. **ステータス遷移制約**
   - 投稿→承認待ち（自動）
   - 承認待ち→承認済み（管理者のみ）
   - 承認待ち→拒否（管理者のみ）
   - 承認済み・拒否からの状態変更不可

### 回答エンティティの不変条件

1. **回答制約**
   - 承認済みクイズのみ回答可能
   - ◯または×の2択のみ
   - 回答後の変更不可

2. **履歴制約**
   - 同一クイズへの複数回答許可
   - セッション単位での回答管理
   - 永続化は匿名化された形式

### セッション管理の不変条件

1. **セッション識別**
   - デバイスフィンガープリントベース
   - salt付きハッシュによる匿名化
   - 複数デバイス対応

2. **データ同期**
   - オフライン回答の競合解決
   - Last-Write-Winsによる単純化
   - データ整合性保証

## 境界コンテキスト候補

1. **Quiz Management Context**
   - クイズの作成・編集・承認
   - エンティティ: Quiz, QuizStatus
   - 責務: コンテンツ管理

2. **Answer Context**
   - 回答・履歴管理
   - エンティティ: Answer, AnswerHistory
   - 責務: 学習記録管理

3. **User Session Context**
   - 匿名ユーザーセッション管理
   - エンティティ: QuizSession, CreatorId
   - 責務: 匿名認証・識別

4. **Offline Sync Context**
   - オフライン対応・同期処理
   - 責務: データ同期・競合解決

## まとめ

クイズアプリケーションの主要ユーザーフローを5つのストーリー（US-01〜US-05）として整理し、それぞれの正常系・異常系・ビジネス価値を明確化しました。特に**匿名ユーザーによる継続的な学習体験**と**品質統制された承認フロー**が、このドメインの中核的価値を提供します。

これらのフロー分析により、4つの境界づけられたコンテキスト候補（Quiz Management・Answer・User Session・Offline Sync）が特定され、後続のDDD設計における確固たる基盤が構築されました。

## 関連ドキュメント

- [ユーザーストーリー](docs/project/specifications/user-stories/user-story-quiz.md)
- [要件定義](docs/project/specifications/requirements/requirements-quiz.md)
- [ドメインモデル概要](docs/project/ddd-design/2.00_domain-model-overview.md)
- [境界づけられたコンテキスト定義](docs/project/ddd-design/2.09_bounded-context-definition/README.md)

---
**作成工程**: DDD設計
**作成日**: 2025-01-30
**更新日**: 2025-01-30
