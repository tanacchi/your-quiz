# API非機能要件

## 目的

Your QuizアプリケーションのAPI設計における非機能要件を定義し、パフォーマンス・スケーラビリティ・可用性・セキュリティの具体的な実装指針を提供する。

## 参照ドキュメント

- [API設計概要](README.md) - 全体アーキテクチャ・設計方針
- [API機能カタログ](api-catalog.md) - 87エンドポイントの詳細仕様
- [イベント駆動API統合](event-integration.md) - 非同期処理・リアルタイム機能
- [境界づけられたコンテキスト](../ddd-design/2.09_bounded-context-definition/README.md) - ドメイン境界

## パフォーマンス要件

### 1. API応答時間要件

#### 境界づけられたコンテキスト別パフォーマンス目標

| コンテキスト | 操作種別 | 目標応答時間 | 測定条件 | 最適化方針 | 監視閾値 |
|-------------|----------|-------------|----------|-----------|----------|
| **Quiz Domain - Manage** | クイズ投稿 | **≤200ms** | **95%ile** | **バリデーション最適化・非同期承認** | **300ms** |
| | 下書き保存 | **≤100ms** | **95%ile** | **ローカルキャッシュ・差分更新** | **150ms** |
| | 承認処理 | **≤500ms** | **95%ile** | **バックグラウンド処理・イベント駆動** | **750ms** |
| **Quiz Domain - Learning** | Deck生成 | **≤150ms** | **95%ile** | **クイズデータ事前キャッシュ** | **200ms** |
| | セッション開始 | **≤100ms** | **95%ile** | **Deck データプリロード** | **150ms** |
| | 回答提出 | **≤50ms** | **95%ile** | **正誤判定キャッシュ・非同期統計更新** | **100ms** |
| | 履歴取得 | **≤200ms** | **95%ile** | **ページネーション・インデックス最適化** | **300ms** |
| **User Domain** | 認証・セッション作成 | **≤100ms** | **95%ile** | **JWT生成最適化・Redis セッション** | **150ms** |
| | 権限確認 | **≤20ms** | **95%ile** | **JWT クレーム・ローカルキャッシュ** | **50ms** |
| **Sync Domain** | 同期データアップロード | **≤1000ms** | **95%ile** | **バッチ処理・非同期処理** | **1500ms** |
| | 競合解決 | **≤300ms** | **95%ile** | **ルールベース自動解決** | **500ms** |

#### 検索・発見機能の特別要件

| 検索種別 | 目標応答時間 | 結果件数制限 | 最適化方針 | 監視閾値 |
|----------|-------------|-------------|-----------|----------|
| **キーワード検索** | **≤200ms** | **50件** | **Elasticsearch・全文インデックス** | **300ms** |
| **タグフィルタ検索** | **≤100ms** | **100件** | **タグインデックス・ビットマップ** | **150ms** |
| **複合検索** | **≤300ms** | **30件** | **検索結果キャッシュ・並行処理** | **500ms** |
| **推奨クイズ** | **≤150ms** | **20件** | **事前計算・個人化キャッシュ** | **200ms** |

### 2. リアルタイム機能要件

#### WebSocket・GraphQL Subscription

| 機能 | 通知遅延 | 同時接続数 | 最適化方針 | 監視項目 |
|------|----------|-----------|-----------|----------|
| **セッション進捗更新** | **≤100ms** | **1000接続** | **Room ベース配信・差分更新** | **接続数・メッセージ頻度** |
| **承認通知** | **≤200ms** | **全ユーザー** | **ユーザー別チャンネル・永続化** | **通知到達率** |
| **同期状態更新** | **≤500ms** | **アクティブユーザー** | **状態変化時のみ配信** | **同期完了率** |
| **推奨更新** | **≤1000ms** | **個別ユーザー** | **バックグラウンド計算・プッシュ配信** | **更新頻度** |

### 3. イベント処理パフォーマンス

#### ドメインイベント処理要件

| イベント種別 | 処理時間目標 | バッチサイズ | 最適化方針 | 障害時対応 |
|-------------|-------------|-------------|-----------|-----------|
| **QuizSubmittedEvent** | **≤50ms** | **単一** | **承認キュー・非同期処理** | **3回リトライ** |
| **AnswerSubmittedEvent** | **≤20ms** | **100件/batch** | **統計更新バッチ・遅延書き込み** | **イベント再送** |
| **SessionCompletedEvent** | **≤200ms** | **単一** | **結果計算・間違い問題集生成** | **手動再処理** |
| **SynchronizationEvent** | **≤1000ms** | **1000件/batch** | **並行処理・競合検出** | **部分ロールバック** |

## スケーラビリティ戦略

### 1. 匿名ユーザー対応スケーリング

#### JWT・セッション管理

| 要求特性 | 推奨戦略 | 理由 | 実装方式 | 適用時期 |
|----------|----------|------|----------|----------|
| **JWT生成・検証** | **垂直スケール** | **CPU集約・暗号化処理** | **高性能CPU・メモリキャッシュ** | **1000セッション/分** |
| **セッション状態管理** | **水平スケール** | **Redis クラスター対応** | **Redis Cluster・レプリケーション** | **10000アクティブセッション** |
| **デバイス識別管理** | **垂直→水平** | **初期垂直、将来水平分散** | **デバイスID ハッシュ分散** | **50000デバイス登録** |

#### 匿名認証特有のスケール要件

```typescript
// デバイス識別によるシャーディング戦略
interface DeviceShardingStrategy {
  shardCount: 16;              // デバイスID による16分割
  hashFunction: 'consistent';  // 一貫性ハッシュ
  migrationStrategy: 'gradual'; // 段階的移行

  // 負荷分散条件
  scaleOutTrigger: {
    deviceRegistrations: 10000;  // デバイス登録数
    dailyLogins: 50000;         // 日次ログイン数
    sessionDuration: 120;       // 平均セッション時間（分）
  };
}
```

### 2. オフライン同期スケーリング

#### 同期処理の負荷特性

| 同期種別 | 負荷特性 | スケール戦略 | 実装方針 | ボトルネック対策 |
|----------|----------|-------------|----------|------------------|
| **回答データ同期** | **I/O集約** | **水平スケール** | **並行処理・キューイング** | **データベース分散書き込み** |
| **下書き同期** | **CPU集約** | **垂直スケール** | **差分計算・マージ処理** | **メモリ増強・処理最適化** |
| **競合解決** | **メモリ集約** | **垂直スケール** | **ルールエンジン・キャッシュ** | **専用解決サーバー** |
| **バッチ同期** | **ネットワーク集約** | **水平スケール** | **レプリケーション・CDN** | **帯域幅拡張** |

#### オフライン特有のスケール戦略

```typescript
// オフライン同期処理のスケーリング設計
interface OfflineSyncScaling {
  // バッチ処理設定
  batchProcessing: {
    maxBatchSize: 1000;         // 最大バッチサイズ
    processingInterval: 100;    // 処理間隔（ms）
    concurrency: 8;             // 並行処理数
  };

  // キューイング戦略
  queueStrategy: {
    priorityLevels: ['realtime', 'normal', 'batch'];
    realtimeCapacity: 100;      // リアルタイム処理枠
    retryPolicy: 'exponential'; // 指数バックオフ
  };

  // 負荷制御
  loadControl: {
    maxConcurrentSyncs: 50;     // 最大同時同期数
    rateLimitPerDevice: 100;    // デバイス別制限/分
    adaptiveThrottling: true;   // 適応的スロットリング
  };
}
```

### 3. Deck・学習セッション管理スケーリング

#### 学習データの拡張性

| データ種別 | 増加要因 | スケール戦略 | パーティション戦略 | 保持期間 |
|-----------|----------|-------------|------------------|----------|
| **Deck メタデータ** | **ユーザー増・検索多様化** | **垂直→水平** | **ユーザーID ベース** | **無期限** |
| **学習セッション** | **アクティブユーザー数** | **水平スケール** | **時系列・ユーザーID** | **1年間** |
| **回答履歴** | **セッション数・問題数** | **水平スケール** | **時系列パーティション** | **3年間** |
| **統計データ** | **集計複雑化** | **垂直スケール** | **事前集計・OLAP** | **永続** |

## 可用性・耐障害性設計

### 1. イベント駆動アーキテクチャの可用性

#### Event Store・Event Bus冗長化

| コンポーネント | 冗長化方式 | 理由 | 実装方針 | RTO/RPO |
|---------------|-----------|------|----------|---------|
| **Event Store** | **Active-Standby** | **データ整合性重視** | **PostgreSQL レプリケーション** | **RTO:5分/RPO:1分** |
| **Event Bus** | **Active-Active** | **処理能力・可用性** | **Redis Cluster・Kafka** | **RTO:30秒/RPO:0** |
| **Event Handler** | **Active-Active** | **負荷分散・冗長性** | **複数インスタンス・ロードバランサー** | **RTO:1分/RPO:0** |

#### イベント処理の障害対応

```typescript
// イベント処理耐障害性設計
interface EventResilienceStrategy {
  // リトライ戦略
  retryPolicy: {
    maxRetries: 3;
    backoffStrategy: 'exponential';
    retryableErrors: ['TimeoutError', 'NetworkError'];
    nonRetryableErrors: ['ValidationError', 'AuthorizationError'];
  };

  // Dead Letter Queue
  deadLetterQueue: {
    enabled: true;
    retentionDays: 30;
    alertThreshold: 10;         // DLQ メッセージ数閾値
  };

  // Circuit Breaker
  circuitBreaker: {
    enabled: true;
    failureThreshold: 5;        // 連続失敗数
    recoveryTimeout: 30000;     // 回復タイムアウト（ms）
  };
}
```

### 2. API層の可用性設計

#### RESTful + GraphQL統合環境

| API種別 | 可用性目標 | 冗長化方式 | 負荷分散 | 障害検知 |
|---------|-----------|-----------|----------|----------|
| **RESTful API** | **99.9%** | **Active-Active** | **Round Robin + Health Check** | **2秒間隔** |
| **GraphQL** | **99.9%** | **Active-Active** | **Weighted Round Robin** | **1秒間隔** |
| **WebSocket** | **99.5%** | **Active-Standby** | **Session Affinity** | **5秒間隔** |

#### APIゲートウェイ障害対応

```typescript
// API Gateway耐障害性設計
interface APIGatewayResilience {
  // Health Check設定
  healthCheck: {
    interval: 2000;             // チェック間隔（ms）
    timeout: 1000;              // タイムアウト（ms）
    unhealthyThreshold: 3;      // 異常判定回数
    healthyThreshold: 2;        // 正常復帰判定回数
  };

  // Failover設定
  failover: {
    automaticFailover: true;
    failoverTimeout: 5000;      // フェイルオーバータイムアウト
    gradualTrafficShift: true;  // 段階的トラフィック移行
  };

  // 負荷制御
  loadShedding: {
    enabled: true;
    cpuThreshold: 85;           // CPU使用率閾値
    memoryThreshold: 85;        // メモリ使用率閾値
    responseTimeThreshold: 2000; // 応答時間閾値（ms）
  };
}
```

### 3. キャッシュ層の可用性

#### Redis クラスター・フェイルオーバー

| キャッシュ種別 | 可用性戦略 | データ保護 | 復旧戦略 | 影響範囲 |
|---------------|-----------|-----------|----------|----------|
| **セッションキャッシュ** | **Redis Cluster** | **レプリケーション** | **自動フェイルオーバー** | **認証機能** |
| **クエリキャッシュ** | **Redis Sentinel** | **RDB + AOF** | **手動切り替え** | **検索性能** |
| **統計キャッシュ** | **Redis Sharding** | **定期バックアップ** | **段階復旧** | **レポート機能** |

## セキュリティ要件

### 1. 匿名認証セキュリティ

#### JWT・デバイス識別のセキュリティ設計

| セキュリティ要素 | 実装方針 | セキュリティレベル | 監視・検知 |
|-----------------|----------|------------------|-----------|
| **JWT署名** | **RS256・4096bit鍵** | **高** | **署名検証失敗率** |
| **デバイスフィンガープリント** | **多要素組み合わせ・ハッシュ化** | **中** | **重複検知・異常アクセス** |
| **セッション管理** | **Redis・暗号化格納** | **高** | **セッション乗っ取り検知** |
| **レート制限** | **IP・ユーザー・エンドポイント別** | **中** | **DDoS・ブルートフォース検知** |

#### 匿名認証特有のセキュリティ要件

```typescript
// 匿名認証セキュリティ設定
interface AnonymousAuthSecurity {
  // JWT設定
  jwt: {
    algorithm: 'RS256';
    keyRotationDays: 30;        // 鍵ローテーション間隔
    tokenExpiryHours: 24;       // トークン有効期限
    refreshTokenExpiryDays: 30; // リフレッシュトークン期限
  };

  // デバイス識別
  deviceFingerprint: {
    factors: ['userAgent', 'screen', 'timezone', 'language', 'plugins'];
    hashAlgorithm: 'SHA-256';
    saltRotationDays: 7;        // ソルトローテーション
  };

  // セッション保護
  sessionSecurity: {
    httpOnly: true;             // XSS対策
    secure: true;               // HTTPS必須
    sameSite: 'strict';         // CSRF対策
    encryption: 'AES-256-GCM';  // セッションデータ暗号化
  };
}
```

### 2. API エンドポイントセキュリティ

#### レート制限・DDoS対策

| エンドポイント群 | 制限種別 | 制限値 | 時間窓 | 超過時対応 |
|-----------------|----------|--------|--------|-----------|
| **認証API** | **IP別** | **100回** | **1時間** | **24時間ブロック** |
| **クイズ投稿** | **ユーザー別** | **10回** | **1日** | **投稿制限** |
| **検索API** | **IP別** | **300回** | **1時間** | **一時制限** |
| **回答提出** | **セッション別** | **1000回** | **1時間** | **セッション中断** |

#### 入力検証・サニタイゼーション

```typescript
// API入力検証設定
interface APIValidationSecurity {
  // 入力検証
  validation: {
    maxRequestSize: '10MB';      // 最大リクエストサイズ
    timeoutMs: 30000;           // リクエストタイムアウト
    strictValidation: true;     // 厳密なスキーマ検証
  };

  // サニタイゼーション
  sanitization: {
    htmlStripping: true;        // HTMLタグ除去
    sqlInjectionPrevention: true; // SQLインジェクション対策
    xssProtection: true;        // XSS対策
    pathTraversalPrevention: true; // ディレクトリトラバーサル対策
  };

  // 暗号化
  encryption: {
    dataAtRest: 'AES-256';      // 保存時暗号化
    dataInTransit: 'TLS-1.3';   // 転送時暗号化
    keyManagement: 'AWS-KMS';   // 鍵管理サービス
  };
}
```

## 監視・運用要件

### 1. パフォーマンス監視

#### API メトリクス監視

| メトリクス | 監視間隔 | アラート閾値 | 重要度 | 対応アクション |
|-----------|----------|-------------|--------|----------------|
| **応答時間** | **1分** | **150ms (95%ile)** | **Critical** | **即座対応・スケールアウト** |
| **エラー率** | **1分** | **1%** | **Critical** | **障害調査・ロールバック検討** |
| **スループット** | **1分** | **1000 req/min** | **Warning** | **キャパシティ計画見直し** |
| **同時接続数** | **1分** | **800接続** | **Warning** | **接続プール拡張準備** |

#### システムリソース監視

```typescript
// システム監視設定
interface SystemMonitoring {
  // CPU・メモリ監視
  resources: {
    cpuThreshold: 80;           // CPU使用率閾値（%）
    memoryThreshold: 85;        // メモリ使用率閾値（%）
    diskThreshold: 90;          // ディスク使用率閾値（%）
    networkThreshold: 80;       // ネットワーク使用率閾値（%）
  };

  // データベース監視
  database: {
    connectionPoolUsage: 80;    // 接続プール使用率閾値（%）
    queryExecutionTime: 1000;   // クエリ実行時間閾値（ms）
    lockWaitTime: 5000;         // ロック待機時間閾値（ms）
    replicationLag: 1000;       // レプリケーション遅延閾値（ms）
  };

  // Redis監視
  redis: {
    memoryUsage: 80;            // メモリ使用率閾値（%）
    keyspaceHitRate: 90;        // ヒット率下限（%）
    evictedKeys: 100;           // 退避キー数閾値（個/分）
    blockedClients: 10;         // ブロッククライアント数閾値
  };
}
```

### 2. ビジネスメトリクス監視

#### KPI・ビジネス指標監視

| ビジネスメトリクス | 監視頻度 | 目標値 | アラート条件 | 対応チーム |
|------------------|----------|--------|-------------|-----------|
| **DAU（日次アクティブユーザー）** | **日次** | **増加傾向** | **前日比-10%** | **プロダクト** |
| **クイズ投稿数** | **日次** | **10件/日** | **3日連続5件未満** | **コンテンツ** |
| **セッション完了率** | **日次** | **80%** | **70%未満** | **エンジニア** |
| **オフライン同期成功率** | **時間** | **95%** | **90%未満** | **エンジニア** |

### 3. セキュリティ監視・インシデント対応

#### セキュリティ監視項目

```typescript
// セキュリティ監視設定
interface SecurityMonitoring {
  // 認証・認可監視
  authentication: {
    failedLoginThreshold: 10;    // 失敗ログイン閾値（回/時間）
    suspiciousDeviceThreshold: 3; // 疑わしいデバイス閾値
    sessionHijackingDetection: true; // セッション乗っ取り検知
  };

  // API攻撃監視
  apiSecurity: {
    rateLimitViolations: 100;    // レート制限違反閾値（回/時間）
    maliciousPayloadDetection: true; // 悪意あるペイロード検知
    sqlInjectionAttempts: 1;     // SQLインジェクション試行閾値
    xssAttempts: 1;              // XSS攻撃試行閾値
  };

  // インフラセキュリティ
  infrastructure: {
    unauthorizedAccess: true;    // 不正アクセス検知
    privilegeEscalation: true;   // 権限昇格検知
    dataExfiltration: true;      // データ漏洩検知
    networkAnomalies: true;      // ネットワーク異常検知
  };
}
```

## 災害復旧・事業継続

### 1. バックアップ・復旧戦略

#### データ別バックアップ方針

| データ種別 | バックアップ頻度 | 保持期間 | 復旧目標 | バックアップ方式 |
|-----------|-----------------|----------|----------|-----------------|
| **ユーザーデータ** | **1時間** | **3年** | **RTO:1時間/RPO:1時間** | **増分・暗号化** |
| **クイズデータ** | **6時間** | **永続** | **RTO:2時間/RPO:6時間** | **完全・差分** |
| **学習履歴** | **1日** | **1年** | **RTO:4時間/RPO:24時間** | **完全バックアップ** |
| **イベントログ** | **リアルタイム** | **永続** | **RTO:30分/RPO:0** | **ストリーミング** |

### 2. 災害復旧手順

#### 障害レベル別復旧戦略

```typescript
// 災害復旧設定
interface DisasterRecoveryStrategy {
  // 障害レベル定義
  incidentLevels: {
    level1: {
      description: 'API応答遅延・部分サービス停止';
      responseTime: '30分以内';
      recoveryAction: 'スケールアウト・キャッシュクリア';
    };
    level2: {
      description: 'データベース障害・主要機能停止';
      responseTime: '1時間以内';
      recoveryAction: 'フェイルオーバー・データ復旧';
    };
    level3: {
      description: '全サービス停止・データ損失リスク';
      responseTime: '4時間以内';
      recoveryAction: '完全復旧・バックアップ復元';
    };
  };

  // 復旧優先順位
  recoveryPriority: [
    'ユーザー認証・セッション管理',
    'クイズ回答・学習機能',
    'クイズ投稿・管理機能',
    '統計・レポート機能'
  ];
}
```

## まとめ

この非機能要件定義により、以下の品質特性を持つAPIシステムが実現される：

### パフォーマンス特性

- **応答性**: 95%ile ≤100msの高速応答
- **スループット**: 1000同時セッション対応
- **効率性**: リソース使用率80%以下での安定稼働

### 拡張性特性

- **水平拡張**: 負荷に応じた自動スケールアウト
- **垂直拡張**: CPU・メモリ集約処理の効率化
- **弾力性**: 需要変動への適応

### 信頼性特性

- **可用性**: 99.9%アップタイム
- **耐障害性**: 単一障害点排除・自動復旧
- **データ保護**: RPO≤1時間・RTO≤4時間

### セキュリティ特性

- **認証・認可**: 匿名ユーザー対応・JWT セキュリティ
- **データ保護**: 暗号化・アクセス制御
- **攻撃対策**: DDoS・インジェクション対策

実装フェーズでは、この要件に基づいてインフラ設計・アプリケーション実装・監視設定を段階的に構築する。

## 関連ドキュメント

- [API設計概要](README.md) - 全体アーキテクチャ・方針
- [API機能カタログ](api-catalog.md) - エンドポイント仕様・パフォーマンス要件
- [イベント駆動API統合](event-integration.md) - 非同期処理・リアルタイム要件
- [API設計ガイドライン](../../guidelines/api-design-principles.md) - 設計原則・実装パターン

---
**作成工程**: API設計
**作成日**: 2025-08-02
**更新日**: 2025-08-02
